function parseUri(e){for(var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),i={},r=14;r--;)i[t.key[r]]=n[r]||"";return i[t.q.name]={},i[t.key[12]].replace(t.q.parser,function(e,n,r){n&&(i[t.q.name][n]=r)}),i}var requirejs,require,define;!function(e){function t(e,t){return v.call(e,t)}function n(e,t){var n,i,r,o,a,s,c,u,d,l,f=t&&t.split("/"),h=g.map,p=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(f=f.slice(0,f.length-1),e=f.concat(e.split("/")),u=0;u<e.length;u+=1)if(l=e[u],"."===l)e.splice(u,1),u-=1;else if(".."===l){if(1===u&&(".."===e[2]||".."===e[0]))break;u>0&&(e.splice(u-1,2),u-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((f||p)&&h){for(n=e.split("/"),u=n.length;u>0;u-=1){if(i=n.slice(0,u).join("/"),f)for(d=f.length;d>0;d-=1)if(r=h[f.slice(0,d).join("/")],r&&(r=r[i])){o=r,a=u;break}if(o)break;!s&&p&&p[i]&&(s=p[i],c=u)}!o&&s&&(o=s,a=c),o&&(n.splice(0,a,o),e=n.join("/"))}return e}function i(t,n){return function(){return d.apply(e,y.call(arguments,0).concat([t,n]))}}function r(e){return function(t){return n(t,e)}}function o(e){return function(t){h[e]=t}}function a(n){if(t(p,n)){var i=p[n];delete p[n],m[n]=!0,u.apply(e,i)}if(!t(h,n)&&!t(m,n))throw new Error("No "+n);return h[n]}function s(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function c(e){return function(){return g&&g.config&&g.config[e]||{}}}var u,d,l,f,h={},p={},g={},m={},v=Object.prototype.hasOwnProperty,y=[].slice;l=function(e,t){var i,o=s(e),c=o[0];return e=o[1],c&&(c=n(c,t),i=a(c)),c?e=i&&i.normalize?i.normalize(e,r(t)):n(e,t):(e=n(e,t),o=s(e),c=o[0],e=o[1],c&&(i=a(c))),{f:c?c+"!"+e:e,n:e,pr:c,p:i}},f={require:function(e){return i(e)},exports:function(e){var t=h[e];return"undefined"!=typeof t?t:h[e]={}},module:function(e){return{id:e,uri:"",exports:h[e],config:c(e)}}},u=function(n,r,s,c){var u,d,g,v,y,w,b=[],_=typeof s;if(c=c||n,"undefined"===_||"function"===_){for(r=!r.length&&s.length?["require","exports","module"]:r,y=0;y<r.length;y+=1)if(v=l(r[y],c),d=v.f,"require"===d)b[y]=f.require(n);else if("exports"===d)b[y]=f.exports(n),w=!0;else if("module"===d)u=b[y]=f.module(n);else if(t(h,d)||t(p,d)||t(m,d))b[y]=a(d);else{if(!v.p)throw new Error(n+" missing "+d);v.p.load(v.n,i(c,!0),o(d),{}),b[y]=h[d]}g=s?s.apply(h[n],b):void 0,n&&(u&&u.exports!==e&&u.exports!==h[n]?h[n]=u.exports:g===e&&w||(h[n]=g))}else n&&(h[n]=s)},requirejs=require=d=function(t,n,i,r,o){return"string"==typeof t?f[t]?f[t](n):a(l(t,n).f):(t.splice||(g=t,n.splice?(t=n,n=i,i=null):t=e),n=n||function(){},"function"==typeof i&&(i=r,r=o),r?u(e,t,n,i):setTimeout(function(){u(e,t,n,i)},4),d)},d.config=function(e){return g=e,g.deps&&d(g.deps,g.callback),d},requirejs._defined=h,define=function(e,n,i){n.splice||(i=n,n=[]),t(h,e)||t(p,e)||(p[e]=[e,n,i])},define.amd={jQuery:!0}}(),function(e,t){var n;e.rails=n={linkClickSelector:"a[data-confirm], a[data-method], a[data-remote], a[data-disable-with]",inputChangeSelector:"select[data-remote], input[data-remote], textarea[data-remote]",formSubmitSelector:"form",formInputClickSelector:"form input[type=submit], form input[type=image], form button[type=submit], form button:not(button[type])",disableSelector:"input[data-disable-with], button[data-disable-with], textarea[data-disable-with]",enableSelector:"input[data-disable-with]:disabled, button[data-disable-with]:disabled, textarea[data-disable-with]:disabled",requiredInputSelector:"input[name][required]:not([disabled]),textarea[name][required]:not([disabled])",fileInputSelector:"input:file",linkDisableSelector:"a[data-disable-with]",CSRFProtection:function(t){var n=e('meta[name="csrf-token"]').attr("content");n&&t.setRequestHeader("X-CSRF-Token",n)},fire:function(t,n,i){var r=e.Event(n);return t.trigger(r,i),r.result!==!1},confirm:function(e){return confirm(e)},ajax:function(t){return e.ajax(t)},href:function(e){return e.attr("href")},handleRemote:function(i){var r,o,a,s,c,u;if(n.fire(i,"ajax:before")){if(s=i.data("cross-domain")||null,c=i.data("type")||e.ajaxSettings&&e.ajaxSettings.dataType,i.is("form")){r=i.attr("method"),o=i.attr("action"),a=i.serializeArray();var d=i.data("ujs:submit-button");d&&(a.push(d),i.data("ujs:submit-button",null))}else i.is(n.inputChangeSelector)?(r=i.data("method"),o=i.data("url"),a=i.serialize(),i.data("params")&&(a=a+"&"+i.data("params"))):(r=i.data("method"),o=n.href(i),a=i.data("params")||null);return u={type:r||"GET",data:a,dataType:c,crossDomain:s,beforeSend:function(e,r){return r.dataType===t&&e.setRequestHeader("accept","*/*;q=0.5, "+r.accepts.script),n.fire(i,"ajax:beforeSend",[e,r])},success:function(e,t,n){i.trigger("ajax:success",[e,t,n])},complete:function(e,t){i.trigger("ajax:complete",[e,t])},error:function(e,t,n){i.trigger("ajax:error",[e,t,n])}},o&&(u.url=o),n.ajax(u)}return!1},handleMethod:function(i){var r=n.href(i),o=i.data("method"),a=i.attr("target"),s=e("meta[name=csrf-token]").attr("content"),c=e("meta[name=csrf-param]").attr("content"),u=e('<form method="post" action="'+r+'"></form>'),d='<input name="_method" value="'+o+'" type="hidden" />';c!==t&&s!==t&&(d+='<input name="'+c+'" value="'+s+'" type="hidden" />'),a&&u.attr("target",a),u.hide().append(d).appendTo("body"),u.submit()},disableFormElements:function(t){t.find(n.disableSelector).each(function(){var t=e(this),n=t.is("button")?"html":"val";t.data("ujs:enable-with",t[n]()),t[n](t.data("disable-with")),t.prop("disabled",!0)})},enableFormElements:function(t){t.find(n.enableSelector).each(function(){var t=e(this),n=t.is("button")?"html":"val";t.data("ujs:enable-with")&&t[n](t.data("ujs:enable-with")),t.prop("disabled",!1)})},allowAction:function(e){var t,i=e.data("confirm"),r=!1;return i?(n.fire(e,"confirm")&&(r=n.confirm(i),t=n.fire(e,"confirm:complete",[r])),r&&t):!0},blankInputs:function(t,n,i){var r,o=e(),a=n||"input,textarea";return t.find(a).each(function(){r=e(this),(i?r.val():!r.val())&&(o=o.add(r))}),o.length?o:!1},nonBlankInputs:function(e,t){return n.blankInputs(e,t,!0)},stopEverything:function(t){return e(t.target).trigger("ujs:everythingStopped"),t.stopImmediatePropagation(),!1},callFormSubmitBindings:function(n,i){var r=n.data("events"),o=!0;return r!==t&&r.submit!==t&&e.each(r.submit,function(e,t){return"function"==typeof t.handler?o=t.handler(i):void 0}),o},disableElement:function(e){e.data("ujs:enable-with",e.html()),e.html(e.data("disable-with")),e.bind("click.railsDisable",function(e){return n.stopEverything(e)})},enableElement:function(e){e.data("ujs:enable-with")!==t&&(e.html(e.data("ujs:enable-with")),e.data("ujs:enable-with",!1)),e.unbind("click.railsDisable")}},e.ajaxPrefilter(function(e,t,i){e.crossDomain||n.CSRFProtection(i)}),e(document).delegate(n.linkDisableSelector,"ajax:complete",function(){n.enableElement(e(this))}),e(document).delegate(n.linkClickSelector,"click.rails",function(i){var r=e(this),o=r.data("method"),a=r.data("params");return n.allowAction(r)?(r.is(n.linkDisableSelector)&&n.disableElement(r),r.data("remote")!==t?!i.metaKey&&!i.ctrlKey||o&&"GET"!==o||a?(n.handleRemote(r)===!1&&n.enableElement(r),!1):!0:r.data("method")?(n.handleMethod(r),!1):void 0):n.stopEverything(i)}),e(document).delegate(n.inputChangeSelector,"change.rails",function(t){var i=e(this);return n.allowAction(i)?(n.handleRemote(i),!1):n.stopEverything(t)}),e(document).delegate(n.formSubmitSelector,"submit.rails",function(i){var r=e(this),o=r.data("remote")!==t,a=n.blankInputs(r,n.requiredInputSelector),s=n.nonBlankInputs(r,n.fileInputSelector);return n.allowAction(r)?a&&r.attr("novalidate")==t&&n.fire(r,"ajax:aborted:required",[a])?n.stopEverything(i):o?s?n.fire(r,"ajax:aborted:file",[s]):!e.support.submitBubbles&&e().jquery<"1.7"&&n.callFormSubmitBindings(r,i)===!1?n.stopEverything(i):(n.handleRemote(r),!1):void setTimeout(function(){n.disableFormElements(r)},13):n.stopEverything(i)}),e(document).delegate(n.formInputClickSelector,"click.rails",function(t){var i=e(this);if(!n.allowAction(i))return n.stopEverything(t);var r=i.attr("name"),o=r?{name:r,value:i.val()}:null;i.closest("form").data("ujs:submit-button",o)}),e(document).delegate(n.formSubmitSelector,"ajax:beforeSend.rails",function(t){this==t.target&&n.disableFormElements(e(this))}),e(document).delegate(n.formSubmitSelector,"ajax:complete.rails",function(t){this==t.target&&n.enableFormElements(e(this))}),e(function(){csrf_token=e("meta[name=csrf-token]").attr("content"),csrf_param=e("meta[name=csrf-param]").attr("content"),e('form input[name="'+csrf_param+'"]').val(csrf_token)})}(jQuery),function(e,t){"use strict";var n,i;if(e.uaMatch=function(e){e=e.toLowerCase();var t=/(opr)[\/]([\w.]+)/.exec(e)||/(chrome)[ \/]([\w.]+)/.exec(e)||/(version)[ \/]([\w.]+).*(safari)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("trident")>=0&&/(rv)(?::| )([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[],n=/(ipad)/.exec(e)||/(iphone)/.exec(e)||/(android)/.exec(e)||/(windows phone)/.exec(e)||/(win)/.exec(e)||/(mac)/.exec(e)||/(linux)/.exec(e)||[];return{browser:t[3]||t[1]||"",version:t[2]||"0",platform:n[0]||""}},n=e.uaMatch(t.navigator.userAgent),i={},n.browser&&(i[n.browser]=!0,i.version=n.version,i.versionNumber=parseInt(n.version)),n.platform&&(i[n.platform]=!0),(i.chrome||i.opr||i.safari)&&(i.webkit=!0),i.rv){var r="msie";n.browser=r,i[r]=!0}if(i.opr){var o="opera";n.browser=o,i[o]=!0}if(i.safari&&i.android){var a="android";n.browser=a,i[a]=!0}i.name=n.browser,i.platform=n.platform,e.browser=i}(jQuery,window),define("enviroment",function(){function e(e){return e.toLowerCase()==s}function t(){return s}function n(){return e("development")}function i(){return e("staging")}function r(){return e("production")}function o(){/^(www\.)?readcube\.com$/i.test(c)?s="production":/^staging\.readcube\.com$/i.test(c)?s="staging":/^local\.readcube\.com$/i.test(c)&&(s="development")}var a={},s="unknown",c=document.domain;return o(),a.is=e,a.get=t,a.staging=i,a.production=r,a.development=n,window.env=a,a}),define("util",function(){function e(){try{if(window["readcube-console-log"]||localStorage.getItem("readcube-console-log"))return console.log.apply(console,arguments)}catch(e){}}function t(e){return"undefined"==typeof e?(new Date).toISOString():new Date(e).toISOString()}function n(e){var t={};if(!e)return t;for(var n=0;n<e.length;n++)t[e[n].id]=e[n];return t}function i(e){var t=[];if(!e)return t;for(var n in e)t.push(e[n]);return t}function r(e,t){return"undefined"!=typeof t[e]}function o(e){return $.extend(!0,{},e)}function a(){return Array.prototype.splice.call(arguments,0,0,!0,{}),$.extend.apply($,arguments)}function s(e){var t=[];for(var n in e)t.push(n+"="+encodeURIComponent(e[n]));return t.join("&")}function c(e,t){var n=e.split("#");return n[0]+=-1==n[0].indexOf("?")?"?":"&",n[0]+=s(t),n.join("#")}function u(e,t){var n=null,i=null,r=0,o=function(){clearTimeout(n),n=null,r=Date.now(),e.apply(i,arguments)};return function(){i=this;var e=Date.now()-r,a=t-e;0>a?o():n||(n=setTimeout(o,a))}}function d(e){setTimeout(e,0)}function l(e,t,n){n&&(e+="?_ts="+(new Date).getTime()),$.get(e,function(){$("<link>",{rel:"stylesheet",type:"text/css",href:e}).appendTo("head"),t&&t()})}function f(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}function h(e){return e.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}function p(e){return/[\xb8\u02c7\xb4\xa8`'"~]{1}/.test(e)}function g(e){return{width:e[0].offsetWidth,height:e[0].offsetHeight}}function m(){return m.md?m.md:(m.md=$("<div></div>").css({position:"absolute",visibility:"hidden"}).appendTo(document.body),m.md)}function v(e){if(document.body.contains(e[0]))return g(e);e=e.clone(),e.appendTo(m());var t=g(e);return e.remove(),t}function y(e){for(var t={top:+1/0,left:+1/0,bottom:-1/0,right:-1/0},n=0;n<e.length;n++){var i=e[n].getBoundingClientRect();t.top=Math.min(t.top,i.top),t.left=Math.min(t.left,i.left),t.bottom=Math.max(t.bottom,i.bottom),t.right=Math.max(t.right,i.right)}return t}function w(e){var t=document.createElement("span");return e.parentNode.insertBefore(t,e),t.appendChild(e),t}function b(e){var t=e.firstChild;return e.parentNode.insertBefore(t,e),e.parentNode.removeChild(e),t}function _(){var e=document.createElement("div");e.style.visibility="hidden",e.style.width="100px",e.style.msOverflowStyle="scrollbar",document.body.appendChild(e);var t=e.offsetWidth;e.style.overflow="scroll";var n=document.createElement("div");n.style.width="100%",e.appendChild(n);var i=n.offsetWidth;return e.parentNode.removeChild(e),t-i}var x=function(){var e={};return{tic:function(){var t=f();return e[t]=Date.now(),t},toc:function(t){var n=Date.now()-e[t];return delete e[t],n}}}();return{log:e,guid:f,timer:x,loadCss:l,throttle:u,queueExec:d,addParams:c,dateISO:t,regexEscape:h,containsDiacritic:p,clone:o,merge:a,definedKey:r,arrayToHash:n,hashToArray:i,measureElement:v,getBoundingRect:y,wrapTextNode:w,unwrapTextNode:b,getScrollbarWidth:_}}),define("endpoint",["util"],function(e){var t=e.clone(window.readcube.endpoints);return function(n,i){return t[n]?i?e.addParams(t[n],i):t[n]:null}}),window.Modernizr=function(e,t,n){function i(e){y.cssText=e}function r(e,t){return i(b.join(e+";")+(t||""))}function o(e,t){return typeof e===t}function a(e,t){return!!~(""+e).indexOf(t)}function s(e,t){for(var i in e){var r=e[i];if(!a(r,"-")&&y[r]!==n)return"pfx"==t?r:!0}return!1}function c(e,t,i){for(var r in e){var a=t[e[r]];if(a!==n)return i===!1?e[r]:o(a,"function")?a.bind(i||t):a}return!1}function u(e,t,n){var i=e.charAt(0).toUpperCase()+e.slice(1),r=(e+" "+x.join(i+" ")+i).split(" ");return o(t,"string")||o(t,"undefined")?s(r,t):(r=(e+" "+C.join(i+" ")+i).split(" "),c(r,t,n))}var d,l,f,h="2.8.2",p={},g=t.documentElement,m="modernizr",v=t.createElement(m),y=v.style,w=":)",b=({}.toString," -webkit- -moz- -o- -ms- ".split(" ")),_="Webkit Moz O ms",x=_.split(" "),C=_.toLowerCase().split(" "),S={svg:"http://www.w3.org/2000/svg"},k={},T=[],N=T.slice,E=function(e,n,i,r){var o,a,s,c,u=t.createElement("div"),d=t.body,l=d||t.createElement("body");if(parseInt(i,10))for(;i--;)s=t.createElement("div"),s.id=r?r[i]:m+(i+1),u.appendChild(s);return o=["&#173;",'<style id="s',m,'">',e,"</style>"].join(""),u.id=m,(d?u:l).innerHTML+=o,l.appendChild(u),d||(l.style.background="",l.style.overflow="hidden",c=g.style.overflow,g.style.overflow="hidden",g.appendChild(l)),a=n(u,e),d?u.parentNode.removeChild(u):(l.parentNode.removeChild(l),g.style.overflow=c),!!a},R=function(){function e(e,r){r=r||t.createElement(i[e]||"div"),e="on"+e;var a=e in r;return a||(r.setAttribute||(r=t.createElement("div")),r.setAttribute&&r.removeAttribute&&(r.setAttribute(e,""),a=o(r[e],"function"),o(r[e],"undefined")||(r[e]=n),r.removeAttribute(e))),r=null,a}var i={select:"input",change:"input",submit:"form",reset:"form",error:"img",load:"img",abort:"img"};return e}(),O={}.hasOwnProperty;f=o(O,"undefined")||o(O.call,"undefined")?function(e,t){return t in e&&o(e.constructor.prototype[t],"undefined")}:function(e,t){return O.call(e,t)},Function.prototype.bind||(Function.prototype.bind=function(e){var t=this;if("function"!=typeof t)throw new TypeError;var n=N.call(arguments,1),i=function(){if(this instanceof i){var r=function(){};r.prototype=t.prototype;var o=new r,a=t.apply(o,n.concat(N.call(arguments)));return Object(a)===a?a:o}return t.apply(e,n.concat(N.call(arguments)))};return i}),k.flexbox=function(){return u("flexWrap")},k.flexboxlegacy=function(){return u("boxDirection")},k.postmessage=function(){return!!e.postMessage},k.hashchange=function(){return R("hashchange",e)&&(t.documentMode===n||t.documentMode>7)},k.rgba=function(){return i("background-color:rgba(150,255,150,.5)"),a(y.backgroundColor,"rgba")},k.backgroundsize=function(){return u("backgroundSize")},k.borderradius=function(){return u("borderRadius")},k.boxshadow=function(){return u("boxShadow")},k.textshadow=function(){return""===t.createElement("div").style.textShadow},k.opacity=function(){return r("opacity:.55"),/^0.55$/.test(y.opacity)},k.cssgradients=function(){var e="background-image:",t="gradient(linear,left top,right bottom,from(#9f9),to(white));",n="linear-gradient(left top,#9f9, white);";return i((e+"-webkit- ".split(" ").join(t+e)+b.join(n+e)).slice(0,-e.length)),a(y.backgroundImage,"gradient")},k.csstransforms=function(){return!!u("transform")},k.csstransitions=function(){return u("transition")},k.fontface=function(){var e;return E('@font-face {font-family:"font";src:url("https://")}',function(n,i){var r=t.getElementById("smodernizr"),o=r.sheet||r.styleSheet,a=o?o.cssRules&&o.cssRules[0]?o.cssRules[0].cssText:o.cssText||"":"";e=/src/i.test(a)&&0===a.indexOf(i.split(" ")[0])}),e},k.generatedcontent=function(){var e;return E(["#",m,"{font:0/0 a}#",m,':after{content:"',w,'";visibility:hidden;font:3px/1 a}'].join(""),function(t){e=t.offsetHeight>=3}),e},k.video=function(){var e=t.createElement("video"),n=!1;try{(n=!!e.canPlayType)&&(n=new Boolean(n),n.ogg=e.canPlayType('video/ogg; codecs="theora"').replace(/^no$/,""),n.h264=e.canPlayType('video/mp4; codecs="avc1.42E01E"').replace(/^no$/,""),n.webm=e.canPlayType('video/webm; codecs="vp8, vorbis"').replace(/^no$/,""))}catch(i){}return n},k.localstorage=function(){try{return localStorage.setItem(m,m),localStorage.removeItem(m),!0}catch(e){return!1}},k.svg=function(){return!!t.createElementNS&&!!t.createElementNS(S.svg,"svg").createSVGRect};for(var $ in k)f(k,$)&&(l=$.toLowerCase(),p[l]=k[$](),T.push((p[l]?"":"no-")+l));return p.addTest=function(e,t){if("object"==typeof e)for(var i in e)f(e,i)&&p.addTest(i,e[i]);else{if(e=e.toLowerCase(),p[e]!==n)return p;t="function"==typeof t?t():t,"undefined"!=typeof enableClasses&&enableClasses&&(g.className+=" "+(t?"":"no-")+e),p[e]=t}return p},i(""),v=d=null,p._version=h,p._prefixes=b,p._domPrefixes=C,p._cssomPrefixes=x,p.hasEvent=R,p.testProp=function(e){return s([e])},p.testAllProps=u,p.testStyles=E,p}(this,this.document),define("mobile-detect",function(){function e(){var e={Android:function(){return/Android/i.test(i)},BlackBerry:function(){return/BlackBerry/i.test(i)},iOS:function(){return/iPhone|iPad|iPod/i.test(i)},Opera:function(){return/Opera Mini/i.test(i)},Windows:function(){/IEMobile/i.test(i)}};for(var t in e)if(e[t]())return t;return null}function t(){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(i)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(i.substr(0,4))}function n(){return!!e()||t()}var i=navigator.userAgent||navigator.vendor||window.opera;return{isMobile:n,platform:e}}),define("browser-detect",function(){function e(e,t){return new RegExp("(?:^|\\s+)"+t+"(?:\\s+|$)").test(e.className)}function t(t,n){e(t,n)||(t.className=t.className?[t.className,n].join(" "):n)}var n={init:function(){this.browser=this.searchString(this.dataBrowser),this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion),this.OS=this.searchString(this.dataOS),this.browser&&t(document.documentElement,this.browser.toLowerCase()),this.OS&&t(document.documentElement,this.OS.toLowerCase()+"-os")},searchString:function(e){for(var t=0;t<e.length;t++){var n=e[t].string,i=e[t].prop;if(this.versionSearchString=e[t].versionSearch||e[t].identity,n){if(-1!=n.indexOf(e[t].subString))return e[t].identity}else if(i)return e[t].identity}return null},searchVersion:function(e){var t=e.indexOf(this.versionSearchString);return-1==t?null:parseFloat(e.substring(t+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Trident",identity:"Explorer",versionSearch:"rv"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};return n.init(),n}),define("subpixelfont-test",function(){return function(){var e=document.getElementsByTagName("body")[0],t=document.createElement("div");t.style.position="absolute",t.style.visibility="hidden",t.style.fontFamily='"Georgia"',t.innerHTML="PICS",e.appendChild(t);var n=10,i=4,r=.1;t.style.fontSize=n+"px";var o=t.offsetWidth;t.style.fontSize=n*i+"px";var a=t.offsetWidth;return e.removeChild(t),Math.abs(a/o-i)<r}}),define("compatible",["util","mobile-detect","browser-detect","subpixelfont-test"],function(e,t,n,i){function r(){return"WebkitAppearance"in document.documentElement.style}function o(){return"Safari"==n.browser&&"Windows"==n.OS}function a(){for(var n=0;n<s.length;n++){var a=s[n];if("string"!=typeof a){for(var c=!1,u=0;u<a.length;u++)if(Modernizr[a[u]]){c=!0;break}if(!c)return e.log("[READCUBE] browser does not support "+a.join(" or ")),{result:!1,message:"old_browser"}}else if(!Modernizr[a])return e.log("[READCUBE] browser does not support "+a),{result:!1,message:"old_browser"}}return r()||i()?t.isMobile()?(e.log("[READCUBE] browser is mobile"),{result:!1,message:"mobile_browser"}):o()?(e.log("[READCUBE] browser is safari on windows"),{result:!1,message:"old_browser"}):{result:!0,message:"ok"}:(e.log("[READCUBE] browser does not support subpixel font rendering"),{result:!1,message:"font_fail"})}var s=[["flexbox","flexboxlegacy"],"fontface","backgroundsize","borderradius","boxshadow","opacity","rgba","textshadow","cssgradients","csstransforms","csstransitions","hashchange","video","localstorage","postmessage","svg"];return a()}),parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},function(e){"$:nomunge";function t(e){return"string"==typeof e}function n(e){var t=_.call(arguments,1);return function(){return e.apply(this,t.concat(_.call(arguments)))}}function i(e){return e.replace(v,"$2")}function r(e){return e.replace(/(?:^[^?#]*\?([^#]*).*$)?.*/,"$1")}function o(n,i,r,o,a){var s,d,f,h,p;return o!==c?(f=r.match(n?v:/^([^#?]*)\??([^#]*)(#?.*)/),p=f[3]||"",2===a&&t(o)?d=o.replace(n?m:I,""):(h=l(f[2]),o=t(o)?l[n?E:N](o):o,d=2===a?o:1===a?e.extend({},o,h):e.extend({},h,o),d=u(d),n&&(d=d.replace(y,x))),s=f[1]+(n?b:d||!f[1]?"?":"")+d+p):s=i(r!==c?r:location.href),s}function a(e,n,i){return n===c||"boolean"==typeof n?(i=n,n=C[e?E:N]()):n=t(n)?n.replace(e?m:I,""):n,l(n,i)}function s(n,i,r,o){return t(r)||"object"==typeof r||(o=r,r=i,i=c),this.each(function(){var t=e(this),a=i||g()[(this.nodeName||"").toLowerCase()]||"",s=a&&t.attr(a)||"";t.attr(a,C[n](s,r,o))})}var c,u,d,l,f,h,p,g,m,v,y,w,b,_=Array.prototype.slice,x=decodeURIComponent,C=e.param,S=e.bbq=e.bbq||{},k=e.event.special,T="hashchange",N="querystring",E="fragment",R="elemUrlAttr",O="href",$="src",I=/^.*\?|#.*$/g,A={};C[N]=n(o,0,r),C[E]=d=n(o,1,i),C.sorted=u=function(t,n){var i=[],r={};return e.each(C(t,n).split("&"),function(e,t){var n=t.replace(/(?:%5B|=).*$/,""),o=r[n];o||(o=r[n]=[],i.push(n)),o.push(t)}),e.map(i.sort(),function(e){return r[e]}).join("&")},d.noEscape=function(t){t=t||"";var n=e.map(t.split(""),encodeURIComponent);y=new RegExp(n.join("|"),"g")},d.noEscape(",/"),d.ajaxCrawlable=function(e){return e!==c&&(e?(m=/^.*(?:#!|#)/,v=/^([^#]*)(?:#!|#)?(.*)$/,b="#!"):(m=/^.*#/,v=/^([^#]*)#?(.*)$/,b="#"),w=!!e),w},d.ajaxCrawlable(0),e.deparam=l=function(t,n){var i={},r={"true":!0,"false":!1,"null":null};return e.each(t.replace(/\+/g," ").split("&"),function(t,o){var a,s=o.split("="),u=x(s[0]),d=i,l=0,f=u.split("]["),h=f.length-1;if(/\[/.test(f[0])&&/\]$/.test(f[h])?(f[h]=f[h].replace(/\]$/,""),f=f.shift().split("[").concat(f),h=f.length-1):h=0,2===s.length)if(a=x(s[1]),n&&(a=a&&!isNaN(a)?+a:"undefined"===a?c:r[a]!==c?r[a]:a),h)for(;h>=l;l++)u=""===f[l]?d.length:f[l],d=d[u]=h>l?d[u]||(f[l+1]&&isNaN(f[l+1])?{}:[]):a;else e.isArray(i[u])?i[u].push(a):i[u]=i[u]!==c?[i[u],a]:a;else u&&(i[u]=n?c:"")}),i},l[N]=n(a,0),l[E]=f=n(a,1),e[R]||(e[R]=function(t){return e.extend(A,t)})({a:O,base:O,iframe:$,img:$,input:$,form:"action",link:O,script:$}),g=e[R],e.fn[N]=n(s,N),e.fn[E]=n(s,E),S.pushState=h=function(e,n){t(e)&&/^#/.test(e)&&n===c&&(n=2);var i=e!==c,r=d(location.href,i?e:{},i?n:2);location.href=r},S.getState=p=function(e,t){return e===c||"boolean"==typeof e?f(e):f(t)[e]},S.removeState=function(t){var n={};t!==c&&(n=p(),e.each(e.isArray(t)?t:arguments,function(e,t){delete n[t]})),h(n,2)},k[T]=e.extend(k[T],{add:function(t){function n(e){var t=e[E]=d();e.getState=function(e,n){return e===c||"boolean"==typeof e?l(t,e):l(t,n)[e]},i.apply(this,arguments)}var i;return e.isFunction(t)?(i=t,n):(i=t.handler,void(t.handler=n))}})}(jQuery,this),function(e,t,n){"$:nomunge";function i(e){return e=e||location.href,"#"+e.replace(/^[^#]*#?(.*)$/,"$1")}var r,o="hashchange",a=document,s=e.event.special,c=a.documentMode,u="on"+o in t&&(c===n||c>7);e.fn[o]=function(e){return e?this.bind(o,e):this.trigger(o)},e.fn[o].delay=50,s[o]=e.extend(s[o],{setup:function(){return u?!1:void e(r.start)},teardown:function(){return u?!1:void e(r.stop)}}),r=function(){function r(){var n=i(),a=h(d);n!==d?(f(d=n,a),e(t).trigger(o)):a!==d&&(location.href=location.href.replace(/#.*/,"")+a),s=setTimeout(r,e.fn[o].delay)}var s,c={},d=i(),l=function(e){return e},f=l,h=l;return c.start=function(){s||r()},c.stop=function(){s&&clearTimeout(s),s=n},e.browser.msie&&!u&&function(){var t,n;c.start=function(){t||(n=e.fn[o].src,n=n&&n+i(),t=e('<iframe tabindex="-1" title="empty"/>').hide().one("load",function(){n||f(i()),r()}).attr("src",n||"javascript:0").insertAfter("body")[0].contentWindow,a.onpropertychange=function(){try{"title"===event.propertyName&&(t.document.title=a.title)}catch(e){}})},c.stop=l,h=function(){return i(t.location.href)},f=function(n,i){var r=t.document,s=e.fn[o].domain;n!==i&&(r.title=a.title,r.open(),s&&r.write('<script>document.domain="'+s+'"</script>'),r.close(),t.location.hash=n)}}(),c}()}(jQuery,this),function(e){"$:nomunge";var t,n,i,r,o=1,a=this,s=!1,c="postMessage",u="addEventListener",d=a[c];e[c]=function(t,n,i){n&&(t="string"==typeof t?t:e.param(t),i=i||parent,d?i[c](t,n.replace(/([^:]+:\/\/[^\/]+).*/,"$1")):n&&(i.location=n.replace(/#.*$/,"")+"#"+ +new Date+o++ +"&"+t))},e.receiveMessage=r=function(o,c,l){d?(o&&(i&&r(),i=function(t){return"string"==typeof c&&t.origin!==c||e.isFunction(c)&&c(t.origin)===s?s:void o(t)}),a[u]?a[o?u:"removeEventListener"]("message",i,s):a[o?"attachEvent":"detachEvent"]("onmessage",i)):(t&&clearInterval(t),t=null,o&&(l="number"==typeof c?c:"number"==typeof l?l:100,t=setInterval(function(){var e=document.location.hash,t=/^#?\d+&/;e!==n&&t.test(e)&&(n=e,o({data:e.replace(t,"")}))},l)))}}(jQuery),define("message-receiver",["util"],function(e){function t(t){return/readcube\.com(:\d+)?$/.test(t)?!0:(e.log("disallowed origin:",t),!1)}function n(e){if(!e.origin||t(e.origin)){var n=e.data;"string"==typeof n&&(n=$.deparam(e.data)),n.type&&$(r).trigger(n.type,[n])}}function i(){$.receiveMessage(n),window.popupMessage=function(e){$(r).trigger(e.type,[e])}}var r={};return i(),r}),define("iframe-modal",function(){var e=200,t=400,n=function(n){function i(){return $('<div class="modal-bg"></div>')}function r(){return $('<div class="modal-close '+n+'"><div class="close-btn">&#215</div></div>')}function o(e){return $('<iframe class="modal '+n+'" allowtransparency="true" marginheight="0" marginwidth="0" frameborder="0" src="'+e+'"></iframe>')}function a(){$(document.body).addClass("modal-open")}function s(){$(document.body).removeClass("modal-open")}function c(){$(window).unbind("keydown.iframe-modal")}function u(){c(),$(window).bind("keydown.iframe-modal",function(e){return e.metaKey||e.ctrlKey?void 0:27==e.keyCode&&f()?(d(),!1):void 0})}function d(){return v||!p?!1:(v=!0,c(),m.animate({top:"-100%",bottom:"100%"},t),g.animate({top:"-100%",bottom:"100%"},t,function(){g.remove(),g=null,p.fadeOut(e,function(){p.remove(),s(),p=null,v=!1})}),!0)}function l(n){return v||p?!1:(v=!0,a(),p=i(),m=r(),g=o(n),p.appendTo(document.body),m.appendTo(p),g.appendTo(p),p.click(function(){return d(),!1}),p.fadeIn(e,function(){m.animate({top:"0%",bottom:"0%"},t),g.animate({top:"0%",bottom:"0%"},t,function(){u(),v=!1})}),!0)}function f(){return null!=p}function h(e){f()?d():l(e)}var p=null,g=null,m=null,v=!1;return{show:l,hide:d,isOpen:f,toggle:h}};return n}),eval(function(e,t,n,i,r,o){if(r=function(e){return(t>e?"":r(parseInt(e/t)))+((e%=t)>35?String.fromCharCode(e+29):e.toString(36))},!"".replace(/^/,String)){for(;n--;)o[r(n)]=i[n]||r(n);i=[function(e){return o[e]}],r=function(){return"\\w+"},n=1}for(;n--;)i[n]&&(e=e.replace(new RegExp("\\b"+r(n)+"\\b","g"),i[n]));return e}("h.i['1a']=h.i['z'];h.O(h.i,{y:'D',z:9(x,t,b,c,d){6 h.i[h.i.y](x,t,b,c,d)},17:9(x,t,b,c,d){6 c*(t/=d)*t+b},D:9(x,t,b,c,d){6-c*(t/=d)*(t-2)+b},13:9(x,t,b,c,d){e((t/=d/2)<1)6 c/2*t*t+b;6-c/2*((--t)*(t-2)-1)+b},X:9(x,t,b,c,d){6 c*(t/=d)*t*t+b},U:9(x,t,b,c,d){6 c*((t=t/d-1)*t*t+1)+b},R:9(x,t,b,c,d){e((t/=d/2)<1)6 c/2*t*t*t+b;6 c/2*((t-=2)*t*t+2)+b},N:9(x,t,b,c,d){6 c*(t/=d)*t*t*t+b},M:9(x,t,b,c,d){6-c*((t=t/d-1)*t*t*t-1)+b},L:9(x,t,b,c,d){e((t/=d/2)<1)6 c/2*t*t*t*t+b;6-c/2*((t-=2)*t*t*t-2)+b},K:9(x,t,b,c,d){6 c*(t/=d)*t*t*t*t+b},J:9(x,t,b,c,d){6 c*((t=t/d-1)*t*t*t*t+1)+b},I:9(x,t,b,c,d){e((t/=d/2)<1)6 c/2*t*t*t*t*t+b;6 c/2*((t-=2)*t*t*t*t+2)+b},G:9(x,t,b,c,d){6-c*8.C(t/d*(8.g/2))+c+b},15:9(x,t,b,c,d){6 c*8.n(t/d*(8.g/2))+b},12:9(x,t,b,c,d){6-c/2*(8.C(8.g*t/d)-1)+b},Z:9(x,t,b,c,d){6(t==0)?b:c*8.j(2,10*(t/d-1))+b},Y:9(x,t,b,c,d){6(t==d)?b+c:c*(-8.j(2,-10*t/d)+1)+b},W:9(x,t,b,c,d){e(t==0)6 b;e(t==d)6 b+c;e((t/=d/2)<1)6 c/2*8.j(2,10*(t-1))+b;6 c/2*(-8.j(2,-10*--t)+2)+b},V:9(x,t,b,c,d){6-c*(8.o(1-(t/=d)*t)-1)+b},S:9(x,t,b,c,d){6 c*8.o(1-(t=t/d-1)*t)+b},Q:9(x,t,b,c,d){e((t/=d/2)<1)6-c/2*(8.o(1-t*t)-1)+b;6 c/2*(8.o(1-(t-=2)*t)+1)+b},P:9(x,t,b,c,d){f s=1.l;f p=0;f a=c;e(t==0)6 b;e((t/=d)==1)6 b+c;e(!p)p=d*.3;e(a<8.w(c)){a=c;f s=p/4}m f s=p/(2*8.g)*8.r(c/a);6-(a*8.j(2,10*(t-=1))*8.n((t*d-s)*(2*8.g)/p))+b},H:9(x,t,b,c,d){f s=1.l;f p=0;f a=c;e(t==0)6 b;e((t/=d)==1)6 b+c;e(!p)p=d*.3;e(a<8.w(c)){a=c;f s=p/4}m f s=p/(2*8.g)*8.r(c/a);6 a*8.j(2,-10*t)*8.n((t*d-s)*(2*8.g)/p)+c+b},T:9(x,t,b,c,d){f s=1.l;f p=0;f a=c;e(t==0)6 b;e((t/=d/2)==2)6 b+c;e(!p)p=d*(.3*1.5);e(a<8.w(c)){a=c;f s=p/4}m f s=p/(2*8.g)*8.r(c/a);e(t<1)6-.5*(a*8.j(2,10*(t-=1))*8.n((t*d-s)*(2*8.g)/p))+b;6 a*8.j(2,-10*(t-=1))*8.n((t*d-s)*(2*8.g)/p)*.5+c+b},F:9(x,t,b,c,d,s){e(s==u)s=1.l;6 c*(t/=d)*t*((s+1)*t-s)+b},E:9(x,t,b,c,d,s){e(s==u)s=1.l;6 c*((t=t/d-1)*t*((s+1)*t+s)+1)+b},16:9(x,t,b,c,d,s){e(s==u)s=1.l;e((t/=d/2)<1)6 c/2*(t*t*(((s*=(1.B))+1)*t-s))+b;6 c/2*((t-=2)*t*(((s*=(1.B))+1)*t+s)+2)+b},A:9(x,t,b,c,d){6 c-h.i.v(x,d-t,0,c,d)+b},v:9(x,t,b,c,d){e((t/=d)<(1/2.k)){6 c*(7.q*t*t)+b}m e(t<(2/2.k)){6 c*(7.q*(t-=(1.5/2.k))*t+.k)+b}m e(t<(2.5/2.k)){6 c*(7.q*(t-=(2.14/2.k))*t+.11)+b}m{6 c*(7.q*(t-=(2.18/2.k))*t+.19)+b}},1b:9(x,t,b,c,d){e(t<d/2)6 h.i.A(x,t*2,0,c,d)*.5+b;6 h.i.v(x,t*2-d,0,c,d)*.5+c*.5+b}});",62,74,"||||||return||Math|function|||||if|var|PI|jQuery|easing|pow|75|70158|else|sin|sqrt||5625|asin|||undefined|easeOutBounce|abs||def|swing|easeInBounce|525|cos|easeOutQuad|easeOutBack|easeInBack|easeInSine|easeOutElastic|easeInOutQuint|easeOutQuint|easeInQuint|easeInOutQuart|easeOutQuart|easeInQuart|extend|easeInElastic|easeInOutCirc|easeInOutCubic|easeOutCirc|easeInOutElastic|easeOutCubic|easeInCirc|easeInOutExpo|easeInCubic|easeOutExpo|easeInExpo||9375|easeInOutSine|easeInOutQuad|25|easeOutSine|easeInOutBack|easeInQuad|625|984375|jswing|easeInOutBounce".split("|"),0,{})),function(e){var t,n,i,r,o,a,s,c,u,d,l,f,h,p=0,g={},m=[],v=0,y={},w=[],b=null,_=new Image,x=/\.(jpg|gif|xpng|bmp|jpeg)(.*)?$/i,C=/[^\.]\.(swf)\s*$/i,S=1,k=0,T="",N=!1,E=e.extend(e("<div/>")[0],{prop:0}),R=e.browser.msie&&e.browser.version<7&&!window.XMLHttpRequest,O=function(){n.hide(),_.onerror=_.onload=null,b&&b.abort(),t.empty()
},$=function(){return!1===g.onError(m,p,g)?(n.hide(),void(N=!1)):(g.titleShow=!1,g.width="auto",g.height="auto",t.html('<p id="fancybox-error">The requested content cannot be loaded.<br />Please try again later.</p>'),void A())},I=function(){var i,r,o,s,c,u,d=m[p];if(O(),g=e.extend({},e.fn.fancybox.defaults,"undefined"==typeof e(d).data("fancybox")?g:e(d).data("fancybox")),u=g.onStart(m,p,g),u===!1)return void(N=!1);if("object"==typeof u&&(g=e.extend(g,u)),o=g.title||(d.nodeName?e(d).attr("title"):d.title)||"",d.nodeName&&!g.orig&&(g.orig=e(d).children("img:first").length?e(d).children("img:first"):e(d)),""===o&&g.orig&&g.titleFromAlt&&(o=g.orig.attr("alt")),i=g.href||(d.nodeName?e(d).attr("href"):d.href)||null,(/^(?:javascript)/i.test(i)||"#"==i)&&(i=null),g.type?(r=g.type,i||(i=g.content)):g.content?r="html":i&&(r=i.match(x)?"image":i.match(C)?"swf":e(d).hasClass("iframe")?"iframe":0===i.indexOf("#")?"inline":"ajax"),!r)return void $();switch("inline"==r&&(d=i.substr(i.indexOf("#")),r=e(d).length>0?"inline":"ajax"),g.type=r,g.href=i,g.title=o,g.autoDimensions&&("html"==g.type||"inline"==g.type||"ajax"==g.type?(g.width="auto",g.height="auto"):g.autoDimensions=!1),g.modal&&(g.overlayShow=!0,g.hideOnOverlayClick=!1,g.hideOnContentClick=!1,g.enableEscapeButton=!1,g.showCloseButton=!1),g.padding=parseInt(g.padding,10),g.margin=parseInt(g.margin,10),t.css("padding",g.padding+g.margin),e(".fancybox-inline-tmp").unbind("fancybox-cancel").bind("fancybox-change",function(){e(this).replaceWith(a.children())}),r){case"html":t.html(g.content),A();break;case"inline":if(e(d).parent().is("#fancybox-content")===!0)return void(N=!1);e('<div class="fancybox-inline-tmp" />').hide().insertBefore(e(d)).bind("fancybox-cleanup",function(){e(this).replaceWith(a.children())}).bind("fancybox-cancel",function(){e(this).replaceWith(t.children())}),e(d).appendTo(t),A();break;case"image":N=!1,e.fancybox.showActivity(),_=new Image,_.onerror=function(){$()},_.onload=function(){N=!0,_.onerror=_.onload=null,D()},_.src=i;break;case"swf":g.scrolling="no",s='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" width="'+g.width+'" height="'+g.height+'"><param name="movie" value="'+i+'"></param>',c="",e.each(g.swf,function(e,t){s+='<param name="'+e+'" value="'+t+'"></param>',c+=" "+e+'="'+t+'"'}),s+='<embed src="'+i+'" type="application/x-shockwave-flash" width="'+g.width+'" height="'+g.height+'"'+c+"></embed></object>",t.html(s),A();break;case"ajax":N=!1,e.fancybox.showActivity(),g.ajax.win=g.ajax.success,b=e.ajax(e.extend({},g.ajax,{url:i,data:g.ajax.data||{},error:function(e){e.status>0&&$()},success:function(e,r,o){var a="object"==typeof o?o:b;if(200==a.status){if("function"==typeof g.ajax.win){if(u=g.ajax.win(i,e,r,o),u===!1)return void n.hide();("string"==typeof u||"object"==typeof u)&&(e=u)}t.html(e),A()}}}));break;case"iframe":M()}},A=function(){var n=g.width,i=g.height;n=n.toString().indexOf("%")>-1?parseInt((e(window).width()-2*g.margin)*parseFloat(n)/100,10)+"px":"auto"==n?"auto":n+"px",i=i.toString().indexOf("%")>-1?parseInt((e(window).height()-2*g.margin)*parseFloat(i)/100,10)+"px":"auto"==i?"auto":i+"px",t.wrapInner('<div style="width:'+n+";height:"+i+";overflow: "+("auto"==g.scrolling?"auto":"yes"==g.scrolling?"scroll":"hidden")+';position:relative;"></div>'),g.width=t.width(),g.height=t.height(),M()},D=function(){g.width=_.width,g.height=_.height,e("<img />").attr({id:"fancybox-img",src:_.src,alt:g.title}).appendTo(t),M()},M=function(){var o,l;return n.hide(),r.is(":visible")&&!1===y.onCleanup(w,v,y)?(e.event.trigger("fancybox-cancel"),void(N=!1)):(N=!0,e(a.add(i)).unbind(),e(window).unbind("resize.fb scroll.fb"),e(document).unbind("keydown.fb"),r.is(":visible")&&"outside"!==y.titlePosition&&r.css("height",r.height()),w=m,v=p,y=g,y.overlayShow?(i.css({"background-color":y.overlayColor,opacity:y.overlayOpacity,cursor:y.hideOnOverlayClick?"pointer":"auto",height:e(document).height()}),i.is(":visible")||(R&&e("select:not(#fancybox-tmp select)").filter(function(){return"hidden"!==this.style.visibility}).css({visibility:"hidden"}).one("fancybox-cleanup",function(){this.style.visibility="inherit"}),i.show())):i.hide(),h=F(),j(),r.is(":visible")?(e(s.add(u).add(d)).hide(),o=r.position(),f={top:o.top,left:o.left,width:r.width(),height:r.height()},l=f.width==h.width&&f.height==h.height,void a.fadeTo(y.changeFade,.3,function(){var n=function(){a.html(t.contents()).fadeTo(y.changeFade,1,L)};e.event.trigger("fancybox-change"),a.empty().removeAttr("filter").css({"border-width":y.padding,width:h.width-2*y.padding,height:g.autoDimensions?"auto":h.height-k-2*y.padding}),l?n():(E.prop=0,e(E).animate({prop:1},{duration:y.changeSpeed,easing:y.easingChange,step:Y,complete:n}))})):(r.removeAttr("style"),a.css("border-width",y.padding),"elastic"==y.transitionIn?(f=U(),a.html(t.contents()),r.show(),y.opacity&&(h.opacity=0),E.prop=0,void e(E).animate({prop:1},{duration:y.speedIn,easing:y.easingIn,step:Y,complete:L})):("inside"==y.titlePosition&&k>0&&c.show(),a.css({width:h.width-2*y.padding,height:g.autoDimensions?"auto":h.height-k-2*y.padding}).html(t.contents()),void r.css(h).fadeIn("none"==y.transitionIn?0:y.speedIn,L))))},P=function(e){return e&&e.length?"float"==y.titlePosition?'<table id="fancybox-title-float-wrap" cellpadding="0" cellspacing="0"><tr><td id="fancybox-title-float-left"></td><td id="fancybox-title-float-main">'+e+'</td><td id="fancybox-title-float-right"></td></tr></table>':'<div id="fancybox-title-'+y.titlePosition+'">'+e+"</div>":!1},j=function(){if(T=y.title||"",k=0,c.empty().removeAttr("style").removeClass(),y.titleShow===!1)return void c.hide();if(T=e.isFunction(y.titleFormat)?y.titleFormat(T,w,v,y):P(T),!T||""===T)return void c.hide();switch(c.addClass("fancybox-title-"+y.titlePosition).html(T).appendTo("body").show(),y.titlePosition){case"inside":c.css({width:h.width-2*y.padding,marginLeft:y.padding,marginRight:y.padding}),k=c.outerHeight(!0),c.appendTo(o),h.height+=k;break;case"over":c.css({marginLeft:y.padding,width:h.width-2*y.padding,bottom:y.padding}).appendTo(o);break;case"float":c.css("left",-1*parseInt((c.width()-h.width-40)/2,10)).appendTo(r);break;default:c.css({width:h.width-2*y.padding,paddingLeft:y.padding,paddingRight:y.padding}).appendTo(r)}c.hide()},B=function(){return(y.enableEscapeButton||y.enableKeyboardNav)&&e(document).bind("keydown.fb",function(t){27==t.keyCode&&y.enableEscapeButton?(t.preventDefault(),e.fancybox.close()):37!=t.keyCode&&39!=t.keyCode||!y.enableKeyboardNav||"INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName||"SELECT"===t.target.tagName||(t.preventDefault(),e.fancybox[37==t.keyCode?"prev":"next"]())}),y.showNavArrows?((y.cyclic&&w.length>1||0!==v)&&u.show(),void((y.cyclic&&w.length>1||v!=w.length-1)&&d.show())):(u.hide(),void d.hide())},L=function(){e.support.opacity||(a.get(0).style.removeAttribute("filter"),r.get(0).style.removeAttribute("filter")),g.autoDimensions&&a.css("height","auto"),r.css("height","auto"),T&&T.length&&c.show(),y.showCloseButton&&s.show(),B(),y.hideOnContentClick&&a.bind("click",e.fancybox.close),y.hideOnOverlayClick&&i.bind("click",e.fancybox.close),e(window).bind("resize.fb",e.fancybox.resize),y.centerOnScroll&&e(window).bind("scroll.fb",e.fancybox.center),"iframe"==y.type&&e('<iframe id="fancybox-frame" name="fancybox-frame'+(new Date).getTime()+'" frameborder="0" hspace="0" '+(e.browser.msie?'allowtransparency="true""':"")+' scrolling="'+g.scrolling+'" src="'+y.href+'"></iframe>').appendTo(a),r.show(),N=!1,e.fancybox.center(),y.onComplete(w,v,y),W()},W=function(){var e,t;w.length-1>v&&(e=w[v+1].href,"undefined"!=typeof e&&e.match(x)&&(t=new Image,t.src=e)),v>0&&(e=w[v-1].href,"undefined"!=typeof e&&e.match(x)&&(t=new Image,t.src=e))},Y=function(e){var t={width:parseInt(f.width+(h.width-f.width)*e,10),height:parseInt(f.height+(h.height-f.height)*e,10),top:parseInt(f.top+(h.top-f.top)*e,10),left:parseInt(f.left+(h.left-f.left)*e,10)};"undefined"!=typeof h.opacity&&(t.opacity=.5>e?.5:e),r.css(t),a.css({width:t.width-2*y.padding,height:t.height-k*e-2*y.padding})},z=function(){return[e(window).width()-2*y.margin,e(window).height()-2*y.margin,e(document).scrollLeft()+y.margin,e(document).scrollTop()+y.margin]},F=function(){var e,t=z(),n={},i=y.autoScale,r=2*y.padding;return n.width=y.width.toString().indexOf("%")>-1?parseInt(t[0]*parseFloat(y.width)/100,10):y.width+r,n.height=y.height.toString().indexOf("%")>-1?parseInt(t[1]*parseFloat(y.height)/100,10):y.height+r,i&&(n.width>t[0]||n.height>t[1])&&("image"==g.type||"swf"==g.type?(e=y.width/y.height,n.width>t[0]&&(n.width=t[0],n.height=parseInt((n.width-r)/e+r,10)),n.height>t[1]&&(n.height=t[1],n.width=parseInt((n.height-r)*e+r,10))):(n.width=Math.min(n.width,t[0]),n.height=Math.min(n.height,t[1]))),n.top=parseInt(Math.max(t[3]-20,t[3]+.5*(t[1]-n.height-40)),10),n.left=parseInt(Math.max(t[2]-20,t[2]+.5*(t[0]-n.width-40)),10),n},H=function(e){var t=e.offset();return t.top+=parseInt(e.css("paddingTop"),10)||0,t.left+=parseInt(e.css("paddingLeft"),10)||0,t.top+=parseInt(e.css("border-top-width"),10)||0,t.left+=parseInt(e.css("border-left-width"),10)||0,t.width=e.width(),t.height=e.height(),t},U=function(){var t,n,i=g.orig?e(g.orig):!1,r={};return i&&i.length?(t=H(i),r={width:t.width+2*y.padding,height:t.height+2*y.padding,top:t.top-y.padding-20,left:t.left-y.padding-20}):(n=z(),r={width:2*y.padding,height:2*y.padding,top:parseInt(n[3]+.5*n[1],10),left:parseInt(n[2]+.5*n[0],10)}),r},q=function(){return n.is(":visible")?(e("div",n).css("top",-40*S+"px"),void(S=(S+1)%12)):void clearInterval(l)};e.fn.fancybox=function(t){return e(this).length?(e(this).data("fancybox",e.extend({},t,e.metadata?e(this).metadata():{})).unbind("click.fb").bind("click.fb",function(t){if(t.preventDefault(),!N){N=!0,e(this).blur(),m=[],p=0;var n=e(this).attr("rel")||"";n&&""!=n&&"nofollow"!==n?(m=e("a[rel="+n+"], area[rel="+n+"]"),p=m.index(this)):m.push(this),I()}}),this):this},e.fancybox=function(t){var n;if(!N){if(N=!0,n="undefined"!=typeof arguments[1]?arguments[1]:{},m=[],p=parseInt(n.index,10)||0,e.isArray(t)){for(var i=0,r=t.length;r>i;i++)"object"==typeof t[i]?e(t[i]).data("fancybox",e.extend({},n,t[i])):t[i]=e({}).data("fancybox",e.extend({content:t[i]},n));m=jQuery.merge(m,t)}else"object"==typeof t?e(t).data("fancybox",e.extend({},n,t)):t=e({}).data("fancybox",e.extend({content:t},n)),m.push(t);(p>m.length||0>p)&&(p=0),I()}},e.fancybox.showActivity=function(){clearInterval(l),n.show(),l=setInterval(q,66)},e.fancybox.hideActivity=function(){n.hide()},e.fancybox.next=function(){return e.fancybox.pos(v+1)},e.fancybox.prev=function(){return e.fancybox.pos(v-1)},e.fancybox.pos=function(e){N||(e=parseInt(e),m=w,e>-1&&e<w.length?(p=e,I()):y.cyclic&&w.length>1&&(p=e>=w.length?0:w.length-1,I()))},e.fancybox.cancel=function(){N||(N=!0,e.event.trigger("fancybox-cancel"),O(),g.onCancel(m,p,g),N=!1)},e.fancybox.close=function(){function t(){i.fadeOut("fast"),c.empty().hide(),r.hide(),e.event.trigger("fancybox-cleanup"),a.empty(),y.onClosed(w,v,y),w=g=[],v=p=0,y=g={},N=!1}if(!N&&!r.is(":hidden")){if(N=!0,y&&!1===y.onCleanup(w,v,y))return void(N=!1);if(O(),e(s.add(u).add(d)).hide(),e(a.add(i)).unbind(),e(window).unbind("resize.fb scroll.fb"),e(document).unbind("keydown.fb"),a.find("iframe").attr("src",R&&/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank"),"inside"!==y.titlePosition&&c.empty(),r.stop(),"elastic"==y.transitionOut){f=U();var n=r.position();h={top:n.top,left:n.left,width:r.width(),height:r.height()},y.opacity&&(h.opacity=1),c.empty().hide(),E.prop=1,e(E).animate({prop:0},{duration:y.speedOut,easing:y.easingOut,step:Y,complete:t})}else r.fadeOut("none"==y.transitionOut?0:y.speedOut,t)}},e.fancybox.resize=function(){i.is(":visible")&&i.css("height",e(document).height()),e.fancybox.center(!0)},e.fancybox.center=function(){var e,t;N||(t=arguments[0]===!0?1:0,e=z(),(t||!(r.width()>e[0]||r.height()>e[1]))&&r.stop().animate({top:parseInt(Math.max(e[3]-20,e[3]+.5*(e[1]-a.height()-40)-y.padding)),left:parseInt(Math.max(e[2]-20,e[2]+.5*(e[0]-a.width()-40)-y.padding))},"number"==typeof arguments[0]?arguments[0]:200))},e.fancybox.init=function(){e("#fancybox-wrap").length||(e("body").append(t=e('<div id="fancybox-tmp"></div>'),n=e('<div id="fancybox-loading"><div></div></div>'),i=e('<div id="fancybox-overlay"></div>'),r=e('<div id="fancybox-wrap"></div>')),o=e('<div id="fancybox-outer"></div>').append('<div class="fancybox-bg" id="fancybox-bg-n"></div><div class="fancybox-bg" id="fancybox-bg-ne"></div><div class="fancybox-bg" id="fancybox-bg-e"></div><div class="fancybox-bg" id="fancybox-bg-se"></div><div class="fancybox-bg" id="fancybox-bg-s"></div><div class="fancybox-bg" id="fancybox-bg-sw"></div><div class="fancybox-bg" id="fancybox-bg-w"></div><div class="fancybox-bg" id="fancybox-bg-nw"></div>').appendTo(r),o.append(a=e('<div id="fancybox-content"></div>'),s=e('<a id="fancybox-close"></a>'),c=e('<div id="fancybox-title"></div>'),u=e('<a href="javascript:;" id="fancybox-left"><span class="fancy-ico" id="fancybox-left-ico"></span></a>'),d=e('<a href="javascript:;" id="fancybox-right"><span class="fancy-ico" id="fancybox-right-ico"></span></a>')),s.click(e.fancybox.close),n.click(e.fancybox.cancel),u.click(function(t){t.preventDefault(),e.fancybox.prev()}),d.click(function(t){t.preventDefault(),e.fancybox.next()}),e.fn.mousewheel&&r.bind("mousewheel.fb",function(t,n){N?t.preventDefault():(0==e(t.target).get(0).clientHeight||e(t.target).get(0).scrollHeight===e(t.target).get(0).clientHeight)&&(t.preventDefault(),e.fancybox[n>0?"prev":"next"]())}),e.support.opacity||r.addClass("fancybox-ie"),R&&(n.addClass("fancybox-ie6"),r.addClass("fancybox-ie6"),e('<iframe id="fancybox-hide-sel-frame" src="'+(/^https/i.test(window.location.href||"")?"javascript:void(false)":"about:blank")+'" scrolling="no" border="0" frameborder="0" tabindex="-1"></iframe>').prependTo(o)))},e.fn.fancybox.defaults={padding:10,margin:40,opacity:!1,modal:!1,cyclic:!1,scrolling:"auto",width:560,height:340,autoScale:!0,autoDimensions:!0,centerOnScroll:!1,ajax:{},swf:{wmode:"transparent"},hideOnOverlayClick:!0,hideOnContentClick:!1,overlayShow:!0,overlayOpacity:.7,overlayColor:"#777",titleShow:!0,titlePosition:"float",titleFormat:null,titleFromAlt:!1,transitionIn:"fade",transitionOut:"fade",speedIn:300,speedOut:300,changeSpeed:300,changeFade:"fast",easingIn:"swing",easingOut:"swing",showCloseButton:!0,showNavArrows:!0,enableEscapeButton:!0,enableKeyboardNav:!0,onStart:function(){},onCancel:function(){},onComplete:function(){},onCleanup:function(){},onClosed:function(){},onError:function(){}},e(document).ready(function(){e.fancybox.init()})}(jQuery),define("iframe-modal-fbox",["util"],function(e){var t=function(t){function n(){return a?($.fancybox.close(),a=!1,!0):!1}function i(n){return a?!1:($.fancybox(e.merge(t,{onClosed:function(){a=!1},href:n})),a=!0,!0)}function r(){return a}function o(e){r()?n():i(e)}var a=!1;return t=e.merge({type:"iframe",width:540,padding:0,margin:0},t),{show:i,hide:n,isOpen:r,toggle:o}};return t}),define("user-modal",["util","endpoint","message-receiver","iframe-modal","iframe-modal-fbox","browser-detect"],function(e,t,n,i,r,o){var a=function(){function a(){return"Explorer"==o.browser&&o.version<9}function s(n,i){return n&&(p=n),t(p,e.merge(m,i))}function c(e,t){return g.show(s(e,t))}function u(){return g.hide()}function d(){return g.isOpen()}function l(e,t){return g.toggle(s(e,t))}function f(){$(n).on("auth:success",function(e,t){$(h).trigger("success",[t])})}var h={},p="login",g=a()?r({height:560}):i("login"),m={parent_url:window.location.toString(),embed:"1"};return f(),h.show=c,h.hide=u,h.isOpen=d,h.toggle=l,h};return a}),define("user",["util","endpoint","user-modal"],function(e,t,n){function i(){return e.clone(h)}function r(t,n){var r=h;h=t;var a=i();!o(r)&&o(t)&&$(l).trigger("auth",[e.merge(a,{auth:n})]),$(l).trigger("change",[a])}function o(e){return e&&e.id}function a(){return o(h)}function s(e){a()&&e(),$(l).on("auth",e)}function c(e,t){f.isOpen()||($(l).off("auth.single"),$(l).one("auth.single",function(e,n){t&&t(n)}),f.show("login",e))}function u(e,t){f.isOpen()||($(l).off("auth.single"),$(l).one("auth.single",function(e,n){t&&t(n)}),f.show("register",e))}function d(){$(f).on("success",function(e,t){f.hide(),r(t.user,t.auth)})}var l={},f=n(),h=e.clone(window.readcube.user);return d(),l.get=i,l.set=r,l.showLogin=c,l.showRegister=u,l.signedIn=a,l.onSignIn=s,window.user_api=l,l}),define("article",["util","endpoint"],function(e,t){function n(n){if(!m.meta){var i=e.timer.tic();$.ajax({url:t("article_data",e.merge({doi:m.doi,hash:m.hash},m.options)),dataType:"json",success:function(t){e.log("get_article_data:",e.timer.toc(i)+"ms",t),n(t)}})}}function i(n,i){n=e.merge({doi:m.doi,hash:m.hash},n),n=e.merge(window.readcube.access_options,n),n=e.merge(m.options,n);var r=e.timer.tic();$.ajax({type:"POST",url:t("article_pages"),dataType:"json",data:n,success:function(t){e.log("get_pages:",e.timer.toc(r)+"ms",t),i(t)}})}function r(n,i,r){n=e.merge({doi:m.doi,hash:m.hash},n),n=e.merge(window.readcube.access_options,n),n=e.merge(m.options,n);var o=e.timer.tic();$.ajax({type:"POST",url:t("generate_shared_access"),dataType:"json",data:n,success:function(t){e.log("get_pages:",e.timer.toc(o)+"ms",t),i&&i(t)},error:r||function(){}})}function o(){return e.clone(m)}function a(t){m=e.merge(m,t),$(g).trigger("data",[o()])}function s(t){m=e.merge(m,t),$(g).trigger("access-check",[o()]),t.access&&$(g).trigger("access",[o()])}function c(e){i(e,s)}function u(){return m.access}function d(e){m.meta?e(m):$(g).one("data",function(t,n){e(n)})}function l(e){m.access?e(m):$(g).one("access",function(t,n){e(n)})}function f(t){e.definedKey("access",m)?t(m):$(g).one("access-check",function(e,n){t(n)})}function h(t){$(g).on("access-check",function(e,n){t(n)}),e.definedKey("access",m)&&t(m)}function p(){m.meta||n(a)}var g={},m=e.clone(window.readcube.article);return p(),g.get=o,g.onData=d,g.checkAccessWith=c,g.onAccess=l,g.onceAccessChecked=f,g.onAccessCheck=h,g.hasAccess=u,g.generateSharedAccess=r,window.article=g,g}),define("access-control",["util","endpoint","user","article"],function(e,t,n,i){function r(e){if(window.readcube.publisher_proxy){var t=parseUri(e).host,n=parseUri(window.readcube.publisher_proxy).host;return e.replace(t,n)}return e}function o(){var e=t(i.get().meta.publisher+"_jsonp_access");return e?r(e):null}function a(){return"http://www.nature.com/articles/doi:"+i.get().doi+".epdf"}function s(){var t=i.get().meta;return"nature"==t.publisher?e.addParams(r(a()),{parent_url:location.toString(),pdf_url:t.pdf_url}):null}function c(){$(window).on("message",function(t){for(;t.originalEvent;)t=t.originalEvent;return"jsonp_access_result"==t.data.type?void v(t.data.result):"pdf_size"==t.data.type?(e.log("pdf size:",t.data.size),f(),void h(t.data.size)):"pdf_size_fail"==t.data.type?(f(),void e.log("get pdf size failed with status:",t.data.status)):void 0})}function u(){i.onData(function(){o()?p():t("parent")?d():l(),y()}),$(n).on("auth",w)}function d(){window.parent.postMessage({type:"get_pdf_size",pdf_url:i.get().meta.pdf_url},t("parent"))}function l(){s()&&(f(),$("<iframe></iframe>").attr("src",s()).addClass("access-check").appendTo(document.body))}function f(){$("iframe.access-check").remove()}function h(e){R.size=parseInt(e)||1337,C()}function p(){t("parent")?g():m()}function g(){window.parent.postMessage({type:"jsonp_access_check"},t("parent"))}function m(){var t=e.timer.tic(),n=i.get(),r={resource:n.meta.original_doi};n.options&&n.options.cochrane&&(r.pdfType=n.options.cochrane),$.ajax({url:o(),dataType:"jsonp",data:r,success:function(n){e.log("jsonp access response:",e.timer.toc(t)+"ms",n),v(n)}})}function v(e){R.jsonp_response=e,C()}function y(){setTimeout(function(){O||C()},I)}function w(){C(),$(i).one("access-check",function(){A[n.get().id]=!0,$(N).trigger("login-access-check")})}function b(e){A[n.get().id]?e():$(N).one("login-access-check",e)}function _(){i.onAccess(function(e){if(e.purchase&&e.purchase.rental_expires){var t=1e3*e.purchase.rental_expires,n=t-Date.now();n>=0&&x(n),$(N).trigger("rental-expiry",[t])}})}function x(e){setTimeout(function(){location.reload(!0)},e)}function C(){O=!0,i.checkAccessWith(R)}function S(t,n,r){O=!0,i.generateSharedAccess(e.merge(t,R),n,r)}function k(){t("parent")&&i.onceAccessChecked(function(){var e=i.hasAccess()?"access:fulltext":"access:preview";window.parent.postMessage({type:e},t("parent"))})}function T(){k(),c(),u(),_(),x(E)}var N={},E=864e5,R={},O=!1,I=5e3,A={};return T(),N.checkAccess=C,N.generateSharedAccess=S,N.onLoginCheck=b,N}),define("page",["util","browser-detect"],function(e,t){var n=2e3,i=1e3,r=function(e){this._dimensions=e.dimensions,this._container=e.container,this._text=e.text,this._urls=e.urls,this._init()};return r.prototype={_init:function(){this._page=this._createPlaceholder(),this._content=null,this._loading=!1,this._loaded=!1,this._jqxhr=null,this._scale=1,this._timeouts={},this._scalePage(),this._page.appendTo(this._container)},_createPlaceholder:function(){return $('<div class="pf w0 h0"></div>')},_retry:function(e){this._timeouts[e]&&clearTimeout(this._timeouts[e]),this._timeouts[e]=setTimeout($.proxy(this[e],this),i)},_cancelAllRetrys:function(){for(var e in this._timeouts)clearTimeout(this._timeouts[e])},_setThumb:function(){this._page.find("img.bt").remove(),$('<img class="bt" alt="" src="'+this._urls.thumb+'">').one("error",$.proxy(function(){e.log("* thumb load error"),this._retry("_setThumb")},this)).on("dragstart",!1).prependTo(this._page)},_setImageBg:function(){this._content.find("img.bf").remove(),$('<img class="bf" alt="" src="'+this._urls.bg+'">').one("error",$.proxy(function(){e.log("* background load error"),this._retry("_setImageBg")},this)).on("dragstart",!1).prependTo(this._content)},_setObjectBg:function(){this._content.find("object.bf").remove(),$('<object class="bf" type="image/svg+xml" data="'+this._urls.bg+'"></object>').on("dragstart",!1).prependTo(this._content)},_setBackground:function(){this._page.find("img.bt").remove(),"Safari"==t.browser?this._setObjectBg():this._setImageBg()},_scalePage:function(){if(this._page.css({width:this._dimensions.width*this._scale,height:this._dimensions.height*this._scale,margin:this._dimensions.margin*this._scale+"px auto"}),this._content){var e=this._scale/this._dimensions.zoom;this._content.css("transform","scale("+e.toFixed(5)+")")}},_createPage:function(e){this._content=$(e).find(".pc"),this._content.find("a").attr("target","_blank"),this._content.prepend('<div class="bf"></div>'),this._content.appendTo(this._page),this._scalePage(),this._setBackground()},_handleLoadSuccess:function(){this._jqxhr=null,this._loaded=!0,this._loading=!1,$(this).trigger("loaded")},_loadPage:function(){this._text?(this._createPage(this._text),this._handleLoadSuccess()):this._urls.text?this._jqxhr=$.ajax({url:this._urls.text,timeout:n,dataType:"text",success:$.proxy(function(e){this._loading&&(this._createPage(e),this._handleLoadSuccess())},this),error:$.proxy(function(){this._loading&&(e.log("* text load error"),this._retry("_loadPage"))},this)}):this._urls.thumb&&(this._setThumb(),this._handleLoadSuccess())},setUrls:function(e){!this._urls.text&&e.text&&(this._page.find("img").off("error"),this._jqxhr&&this._jqxhr.abort(),this._cancelAllRetrys(),this._loading=!1,this._loaded=!1,this._jqxhr=null,this._urls=e)},hasText:function(){return null!=this._content},hasAccess:function(){return!!this._urls.text},load:function(e){this.onLoaded(e),this._loaded||this._loading||(this._loading=!0,this._loadPage())},scale:function(e){this._scale!=e&&(this._scale=e,this._scalePage())},isVisible:function(){var e=this._container.offset().top,t=e+this._container.height(),n=this._page.offset().top,i=n+this._page.height();return i>=e&&t>=n},getElem:function(){return this._page},getWidth:function(){return this._dimensions.width},getHeight:function(){return this._dimensions.height},getMargin:function(){return this._dimensions.margin},getScale:function(){return this._scale},onLoaded:function(e){e=e||function(){},this._loaded&&e(),$(this).on("loaded",e)}},r}),define("loader",function(){function e(e){function t(){1==++l&&$(u).trigger("loading-start")}function n(e,t){t&&!f[e]&&(++d,f[e]=!0,$(u).trigger("page-loaded",[e])),0==--l&&$(u).trigger("loading-stop")}function i(i,r,o){t(i),e[i].load(function(){n(i,!0),r&&r()},function(){n(i,!1),o&&o()})}function r(t,n){for(var r=0,o=!1,a=0;a<e.length;a++)i(a,function(){++r==e.length&&t&&t()},function(){o||(o=!0,n&&n())})}function o(){for(var t=0;t<e.length;t++)e[t].isVisible()&&i(t)}function a(t,n){h=!1,n=n||p;for(var r=Math.min(e.length,1+2*n),o=[t],a=0,s=1;o.length<r;s++){var c=t-s,u=t+s;c>=0&&o.push(c),u<e.length&&o.push(u)}!function(){if(!(h||a>=r)){var e=arguments.callee,t=o[a];i(t,function(){++a,e()})}}()}function s(){h=!0}function c(){return d}var u={},d=0,l=0,f={},h=!1,p=2;return u.loadAll=r,u.loadVisible=o,u.preloadPages=a,u.stopPreloading=s,u.getLoadedCnt=c,u}return e}),define("viewer-control",["util","page","loader"],function(e,t,n){function i(i){function r(e,t){(j||"initialized"==e)&&(t?$(O).trigger(e,[t]):$(O).trigger(e))}function o(){A=n(I),$(A).on({"page-loaded":function(e,t){A.getLoadedCnt()>=I.length&&D.off("scroll.loader"),r("page-loaded",t+1)},"loading-start":function(){r("loading-start")},"loading-stop":function(){r("loading-stop")}})}function a(e){return Math.min(I.length-1,Math.max(0,e))}function s(){var e=parseInt(D.css("padding-left")),t=parseInt(D.css("padding-right"));return D[0].clientWidth-e-t}function c(){return 0}function u(){return D.height()}function d(){var e,t=0,n=(D.scrollTop()-c())/Y;for(e=0;e<I.length&&(t+=P[e].height+F,!(t>n));e++);var i=(t-n)/(P[e].height+F);return e+(1-i)}function l(e){var t,n=e>0?Math.floor(e):Math.ceil(e),i=e-n,r=0;for(t=0;n>t;t++)r+=P[t].height+F;return r+=i*(P[t].height+F),Math.round(r*Y)+c()}function f(e,t){var n=l(e);t&&(n+=F/2),D.scrollTop(n),A.loadVisible(),r("scroll")}function h(){return a(d())}function p(){var e=Math.floor(h());z!=e&&(z=e,r("page-changed",e+1))}function g(e){P=[];for(var t=0;t<e.length;t++){var n=e.size||e.sizes[t];P.push({zoom:e.zoom,height:n[1],width:n[0],margin:F})}}function m(){A.preloadPages(Math.floor(h()))}function v(){for(var e=0;e<I.length;e++){var t=I[e],n=t.getElem();t.isVisible()?n.addClass("open"):n.removeClass("open")}}function y(){D.off("scroll.update"),D.on("scroll.update",e.throttle(function(){p(),b(),r("scroll")},100));var t=null,n=null;D.off("scroll.loader"),D.on("scroll.loader",function(){clearTimeout(t),clearTimeout(n),A.stopPreloading(),t=setTimeout(function(){A.loadVisible()},200),n=setTimeout(function(){m()},1e3)});var i=null;D.off("scroll.render"),D.on("scroll.render",function(){clearTimeout(i),i=setTimeout(v,100)})}function w(e){return C(e/P[0].width)}function b(){D[0].style.display="block"}function _(e){clearInterval(L),B=P[z],L=setInterval(e,500),e()}function x(){clearInterval(L),L=null}function C(e){var t=d();Y=e;for(var n=0;n<I.length;n++)I[n].scale(e);f(t),b(),r("scale")}function S(e){C(Y*e)}function k(){_(function(){C(s()/B.width)})}function T(){_(function(){var e=s()/B.width,t=u()/(B.height+F);C(Math.min(e,t))})}function N(e){j?e():$(O).on("initialized",e)}function E(e){$.ajax({url:e.text[0],dataType:"text",success:function(n){$(function(){var a=$(n).data("pages"),s=a.length;D=$(i),M=D.find(".banner"),g(a),o();for(var c=0;s>c;c++){var u={container:D,dimensions:P[c],urls:{thumb:e.thumb[c],text:e.text[c],bg:e.background[c]}};0==c&&(u.text=n),I.push(new t(u))}"fit-width"==W?k():"fit-page"==W?T():w(Math.min(W,D.width())),D.scrollTop(0),v(),y(),m(),j=!0,r("initialized")})}})}function R(e){N(function(){for(var t=0;t<I.length;t++)I[t].setUrls({thumb:e.thumb[t],text:e.text[t],bg:e.background[t]});o(),v(),y(),m()})}var O={},I=[],A=null,D=null,M=null,P=null,j=!1,B=null,L=null,W=900,Y=1,z=0,F=8;return O.init=function(e){return E(e)},O.onInit=function(e){return N(e)},O.setData=function(e){return R(e)},O.fitPage=function(){return j?T():void 0},O.fitWidth=function(){return j?k():void 0},O.getElem=function(){return j?D:void 0},O.getPage=function(){return j?z+1:void 0},O.getPageObj=function(e){return j?I[e-1]:void 0},O.eachPage=function(e){if(j)for(var t=0;t<I.length;t++)if(!1===e(t+1,I[t]))return},O.eachVisiblePage=function(e){if(j)for(var t=z;t<I.length;t++){if(!I[t].isVisible())return;if(!1===e(t+1,I[t]))return}},O.gotoPage=function(e){return j&&(e=parseFloat(e),!isNaN(e))?f(a(e-1),!0):void 0},O.loadAll=function(e,t){j&&A.loadAll(e,t)},O.numPages=function(){return j?I.length:void 0},O.scaleBy=function(e){return j?(x(),S(e)):void 0},O.scaleTo=function(e){return j?(x(),C(e)):void 0},O}return i}),define("session",["endpoint"],function(e){function t(){o=!0,$(r).trigger("new")}function n(){$(window).on("message",function(e){for(;e.originalEvent;)e=e.originalEvent;"new_session"==e.data.type&&t()})}function i(){e("parent")?n():t()}var r={},o=!1;return r.onceStarted=function(e){o?e():$(r).one("new",e)},r.onStart=function(e){o&&e(),$(r).on("new",e)},i(),r}),define("readcube-analytics",["endpoint","util"],function(e,t){function n(e){o(),i(),d(e)}function i(){w=t.timer.tic(),clearInterval(b),b=setInterval(r,_)}function r(){var e=t.timer.toc(w)/1e3;u({duration:Math.round(e)}),t.log("session duration:",Math.round(e)+"s"),w=t.timer.tic()}function o(){clearInterval(v),v=setInterval(a,y),p={},sessionUpdateBatch={},m={}}function a(){if(h){var e={};e=t.merge(e,g),$.isEmptyObject(m)||(e=t.merge(e,{counters:m})),$.isEmptyObject(e)||l(e),p=t.merge(p,g),g={},m={}}}function s(e){if(e.sidepanel)c(e,"sidepanel");else if(e.access)c(e,"access");else if(e.article)c(e,"article");else if(e.shared)c(e,"shared");else if(e.share)c(e,"share");else if(e.print)c(e,"print");else for(var t in e)e[t]!==p[t]&&(g[t]=e[t])}function c(e,t){for(var n in e[t]){var i=p[t]&&p[t][n];e[t][n]!==i&&(g[t]=g[t]||{},g[t][n]=e[t][n])}}function u(e){for(var t in e)m[t]=(m[t]||0)+e[t]}function d(n){var i={doi:n.doi,publisher:n.meta.publisher,environment:"html5",referrer_url:window.readcube.tracking.referrer,article:{issn:n.meta.issn,eissn:n.meta.eissn,year:n.meta.year},access:{proxy:window.readcube.publisher_proxy}};$.ajax({url:e("analytics_init"),type:"POST",dataType:"json",crossDomain:!0,xhrFields:{withCredentials:!0},data:{data:t.merge(i,{session_id:f})},success:function(e){t.log("created new tracking session"),h=e.result}})}function l(n){t.log("sending metrics update: ",n),$.ajax({url:e("analytics_update"),type:"POST",dataType:"json",crossDomain:!0,xhrFields:{withCredentials:!0},data:{data:t.merge(n,{session_id:f,article_session_id:h})}})}var f=window.readcube.tracking.tracking_id,h=null,p={},g={},m={},v=null,y=3e4,w=null,b=null,_=6e4;return{start:n,sendEvent:s,addCounter:u}}),define("tracker",["session","user","article","readcube-analytics","util"],function(e,t,n,i){function r(){e.onStart(o),$(t).on("auth",function(e,t){c(t.user,t.auth)}),n.onAccessCheck(function(){a(n.hasAccess(),n.get().access_method)}),n.onData(function(){var e=window.readcube.access_options.shared_access_token||window.readcube.access_options.referrer_access_token,t=!!n.get().shared_annotations_url;e&&C(e,t)})}function o(){n.onData(function(){i.start(n.get()),ga("send","event","article","read","web")})}function a(e,t){i.sendEvent({access:{method:e?t:"denied"},access_denied:!!e})}function s(){i.sendEvent({altmetric:!0})}function c(e,t){var n={};n[t]=!0,i.sendEvent(n)}function u(){i.sendEvent({cite:!0})}function d(){i.sendEvent({discover:!0})}function l(e){ga("send","event","article","save_pdf","web",e?1:0),e&&i.sendEvent({download:!0})}function f(){i.sendEvent({highlight:1})}function h(e){ga("send","event","article","linkout",e)}function p(){i.sendEvent({note:1})}function g(e){var t={};t[e]=!0,i.sendEvent({print:t}),ga("send","event","article","print","web")}function m(e){i.sendEvent({purchased:!0,purchase_id:e.purchase.id})}function v(){i.sendEvent({related:!0})}function y(){i.sendEvent({save_cloud:!0})}function w(e){ga("send","event","article","scroll","page",e)}function b(e){var t={};t[e.split(/-/)[1]]=!0,i.sendEvent({sidepanel:t})}function _(e){var t={};t[e]=!0,i.sendEvent({share:t})}function x(e){i.sendEvent({share:{token:e}})}function C(e,t){i.sendEvent({shared:{view:!0,token:e,annotations:t}})}function S(){i.sendEvent({supplement:!0}),ga("send","event","article","supplement","view")}function k(){ga("send","event","article","video","view")}function T(){var e=n.get().access_method;return"sharing_token"==e?"web_reader_share":"referrer_token"==e?"web_reader_referral":"web_reader"}return r(),{accessChecked:a,altmetric:s,auth:c,cite:u,discover:d,download:l,highlight:f,linkout:h,note:p,print:g,purchase:m,related:v,saveCloud:y,sidepanel:b,scroll:w,share:_,shareToken:x,sharedAccess:C,supplement:S,video:k,trackingOrigin:T}
}),define("viewer",["article","viewer-control","tracker"],function(e,t,n){var i=t("#reader");return i.init(e.get()),e.onAccess(function(e){i.setData(e)}),$(i).on("page-changed",function(e,t){n.scroll(t)}),window.viewer=i,i}),define("storage",["user"],function(e){function t(){var t="readcube-storage";return e.signedIn()&&(t+=":"+e.get().id),t}function n(){var e=localStorage.getItem(t());u=e?JSON.parse(e):{}}function i(){localStorage.setItem(t(),JSON.stringify(u))}function r(e){return u[e]}function o(e,t){u[e]=t,i()}function a(e){delete u[e],i()}function s(){n(),$(e).on("change",function(){n(),$(c).trigger("reload")})}var c={},u=null;return s(),c.getItem=r,c.setItem=o,c.removeItem=a,c}),define("sync-primitives",["util","endpoint","article"],function(e,t,n){function i(i){$.ajax(e.merge(s,i,{type:"POST",url:t("add_to_sync"),data:{"ext_ids[doi]":n.get().doi,"return":!0,access_token:n.get().access_token}}))}function r(t){$.ajax(e.merge(s,t,{type:"DELETE"}))}function o(n,i){$.ajax(e.merge(s,i,{url:t("sync_item",{seq:n}),cache:!1}))}function a(n,i){$.ajax(e.merge(s,i,{type:"POST",url:t("sync_item_update"),data:{_json:JSON.stringify(n)}}))}var s={url:t("sync_item"),crossDomain:!0,dataType:"json",xhrFields:{withCredentials:!0},success:function(){},complete:function(){},error:function(){}};return{add:i,remove:r,pull:o,push:a}}),define("sync-storage",["util","storage","article"],function(e,t,n){function i(){return e.merge(h,t.getItem(f))}function r(e){t.setItem(f,e)}function o(){return l=i(),l.tip}function a(){return l=i(),l.item}function s(e){e&&(l.tip=e,r(l))}function c(e){e&&(l.item=e,r(l))}function u(){l=i(),l.version!=d&&(l=e.clone(h),l.version=d),r(l)}var d=.5,l=null,f="sync:"+n.get().doi,h={tip:0,item:{seq:0}};return u(),{tip:o,item:a,setTip:s,setItem:c}}),define("sync",["util","enviroment","endpoint","message-receiver","user","sync-primitives","sync-storage"],function(e,t,n,i,r,o,a){function s(){L--}function c(){L++}function u(){return 0>L}function d(e,t){s(),setTimeout(function(){e(),c()},t)}function l(t,n,i){var r=arguments.callee;o.pull(t,{success:function(i){e.log("sync pull:",i),"wait"==i.status?d(function(){r(t,n)},Math.ceil(1e3*i.timeout)):"ok"==i.status&&n(i)},error:function(){i&&i()}})}function f(){l(a.item().seq,function(e){a.setTip(e.tip),a.setItem(e.item),e.item&&$(M).trigger("changed",[k()])})}function h(e,t,n){l(0,function(i){i.item?(e=t(e,i.item),i.item.user_data=e.user_data,i.item.seq=i.tip+1,a.setTip(i.tip),a.setItem(i.item),n(i.item,t)):C()})}function p(t,n){var i=arguments.callee;o.push(t,{success:function(r){e.log("sync push:",r),"resync"==r.status?h(t,n,i):"wait"==r.status?d(function(){i(t,n)},Math.ceil(1e3*r.timeout)):"ok"==r.status&&(a.setTip(r.tip),a.setItem(r.item),$(M).trigger("private:push"))}})}function g(e,t){return function(){h(e,t,p)}}function m(){var e=j;j=null,e&&e()}function v(){return W%D==0}function y(){return W%A==0}function w(){P&&!u()&&(j&&v()?m():y()&&f(),++W)}function b(){B=setInterval(w,I),w()}function _(e){r.signedIn()?null!=P?e(P):l(0,function(t){e(!!t.item)},function(){e(!1)}):e(!1)}function x(){P=!0,$(M).trigger("added",[k()])}function C(){P=!1,j=null,$(M).trigger("removed")}function S(){r.onSignIn(function(){_(function(e){e&&x()})}),$(i).on("checkout:success",function(){!function(e){var t=arguments.callee;setTimeout(function(){_(function(n){n?x():t(1.5*e)})},e)}(2e3)}),b()}function k(){return a.item()}function T(e,t,n){r.signedIn()?(a.setItem(e),j=g(e,t),n&&$(M).one("private:push",n)):n&&n()}function N(t){_(function(n){n?(x(),t&&t()):o.add({complete:t,success:function(t){e.log("sync add:",t),"ok"==t.status&&x()}})})}function E(t){_(function(n){n?o.remove({complete:t,success:function(t){e.log("sync remove:",t),"ok"==t.status&&C()},error:function(e){404==e.status&&C()}}):t&&t()})}function R(e){P&&e(),$(M).on("added",e)}function O(e){P||e(),$(M).on("removed",e)}var I=1e3,A=t.production()?60:10,D=10,M={},P=null,j=null,B=null,L=0,W=0;return S(),M.get=k,M.set=T,M.add=N,M.remove=E,M.onAdd=R,M.onRemove=O,M.isAdded=_,window.sync=M,M}),function(e){e.fn.scrollParent||e.fn.extend({scrollParent:function(){var t;return t=e.browser.msie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))?this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0):this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0),/fixed/.test(this.css("position"))||!t.length?e(document.body):t}})}(jQuery),define("popover",["util"],function(e){function t(t){function r(){u.removeClass("up down left right"),u.css({top:"",left:""}),l.css({top:"",left:""})}function f(){r(),u.addClass("up"),k=e.measureElement(d),u.css({top:N.top-R-T.height-k.height-a.top,left:E.x-O-T.width/2});var t=e.getBoundingRect(l);return Math.max(0,S.top-(t.top-o.top))}function h(){r(),u.addClass("down"),k=e.measureElement(d),u.css({top:N.bottom-R+k.height+a.bottom,left:E.x-O-T.width/2});var t=e.getBoundingRect(l);return Math.max(0,t.bottom+o.bottom-S.bottom)}function p(){r(),u.addClass("left"),k=e.measureElement(d),u.css({top:E.y-R-T.height/2,left:N.left-O-T.width-k.width-a.left});var t=e.getBoundingRect(l);return Math.max(0,S.left-(t.left-o.left))}function g(){r(),u.addClass("right"),k=e.measureElement(d),u.css({top:E.y-R-T.height/2,left:N.right-O+k.width+a.right});var t=e.getBoundingRect(l);return Math.max(0,t.right+o.right-S.right)}function m(e){var t=[],n=[f,h],i="up"==e?0:1;(t[i]=n[i]())&&(t[1-i]=n[1-i]())&&(t[i]<=t[1-i]?n[i]():n[1-i]())}function v(e){var t=[],n=[p,g],i="left"==e?0:1;(t[i]=n[i]())&&(t[1-i]=n[1-i]())&&(t[i]<=t[1-i]?n[i]():n[1-i]())}function y(e){var t=e.left>0,n=e.right>0;return n&&t?e.left>=e.right?"right":"left":n?"left":t?"right":null}function w(e){var t=e.top>0,n=e.bottom>0;return n&&t?e.top>=e.bottom?"bottom":"top":n?"top":t?"bottom":null}function b(){var t=e.getBoundingRect(l),n={left:S.left-t.left+o.left,right:t.right-S.right+o.right},i=y(n);"left"==i&&l.css("left",Math.max(-(T.width/2)+k.width,-n.right)),"right"==i&&l.css("left",Math.min(T.width/2-k.width,n.left))}function _(){var t=e.getBoundingRect(l),n={top:S.top-t.top+o.top,bottom:t.bottom-S.bottom+o.bottom},i=w(n);"top"==i&&l.css("top",Math.max(-(T.height/2)+k.height,-n.bottom)),"bottom"==i&&l.css("top",Math.min(T.height/2-k.height,n.top))}i()&&n(),s=t.anchor,c=t.content;var x=s.scrollParent(),C=x.offset(),S=e.getBoundingRect(x);r(),l.removeClass(),l.addClass("container"),t.klass&&l.addClass(t.klass),l.children().detach(),l.append(c),u.appendTo(x),u.css({visibility:"hidden",display:"block"});var k=null,T=e.measureElement(c),N=e.getBoundingRect(s),E={x:(N.left+N.right)/2,y:(N.top+N.bottom)/2},R=C.top-x.scrollTop(),O=C.left-x.scrollLeft();switch(t.placement){case"up":case"down":m(t.placement),b();break;case"left":case"right":v(t.placement),_()}$(window).one("resize.popover",function(){n()}),e.queueExec(function(){$(document).on("click.popover",function(e){$(e.target).is(s)||($(document).off("click.popover"),n())})}),u.css("visibility","visible"),s.trigger("open.popover")}function n(e){return i(e)?($(window).off("resize.popover"),$(document).off("click.popover"),u.css({visibility:"hidden",display:"none"}),s.trigger("close.popover"),c=null,s=null,!0):!1}function i(e){return s?e?e.is(s):!0:!1}function r(e){n(e.anchor)||t(e)}var o={top:10,right:20,bottom:10,left:20},a={top:7,right:2,bottom:2,left:2},s=null,c=null,u=$(['<div class="popover">','<div class="container"></div>','<div class="arrow"></div>',"</div>"].join(""));u.on("mousedown mouseup click",function(e){e.stopImmediatePropagation()});var d=u.find(".arrow"),l=u.find(".container");return{open:t,close:n,toggle:r,isOpen:i}}),define("intro-tooltips",["article","viewer","popover"],function(e,t,n){function i(e){localStorage.setItem("readcube-intro-shown",!0),(b=e.data("anchor"))?n.open({placement:e.data("placement"),content:e.clone(!0),anchor:$(b)}):e.addClass("active")}function r(e){(b=e.data("anchor"))?n.close($(b)):e.removeClass("active")}function o(){u(),n.close($(b)),w.hide(),_=!0}function a(){v>=y?o():(r(w.find(".intro-"+v)),i(w.find(".intro-"+ ++v)))}function s(){1>=v||(r(w.find(".intro-"+v)),i(w.find(".intro-"+--v)))}function c(){$(window).on("keydown.intro",function(e){switch(e.keyCode){case 13:case 32:case 39:a();break;case 37:s();break;case 27:o()}})}function u(){$(window).off("keydown.intro")}function d(t){e.onAccessCheck(function(){t(e.get().sync_enabled)})}function l(){return window.readcube.show_intro}function f(){return localStorage.getItem("readcube-intro-shown")}function h(e){window.readcube.show_checkout?e(!1):d(function(t){e(t?l()||!f():!1)})}function p(){return!_}function g(){h(function(e){e?t.onInit(function(){$(function(){w=$(".intro-container"),y=w.children().length,n.close(),w.show(),w.find(".intro-skip, .intro-done").click(o),w.find(".intro-next").click(a),w.click(function(e){e.stopImmediatePropagation(),w.is(e.target)&&a()}),setTimeout(function(){a(),c()},200)})}):_=!0})}var m={},v=0,y=0,w=null,b=null,_=!1;return g(),m.active=p,m}),function(e,t){e.Spinner=t(),"function"==typeof define&&define.amd&&define("spin",[],function(){return e.Spinner})}(this,function(){"use strict";function e(e,t){var n,i=document.createElement(e||"div");for(n in t)i[n]=t[n];return i}function t(e){for(var t=1,n=arguments.length;n>t;t++)e.appendChild(arguments[t]);return e}function n(e,t,n,i){var r=["opacity",t,~~(100*e),n,i].join("-"),o=.01+n/i*100,a=Math.max(1-(1-e)/t*(100-o),e),s=d.substring(0,d.indexOf("Animation")).toLowerCase(),c=s&&"-"+s+"-"||"";return f[r]||(h.insertRule("@"+c+"keyframes "+r+"{0%{opacity:"+a+"}"+o+"%{opacity:"+e+"}"+(o+.01)+"%{opacity:1}"+(o+t)%100+"%{opacity:"+e+"}100%{opacity:"+a+"}}",h.cssRules.length),f[r]=1),r}function i(e,t){var n,i,r=e.style;for(t=t.charAt(0).toUpperCase()+t.slice(1),i=0;i<l.length;i++)if(n=l[i]+t,void 0!==r[n])return n;return void 0!==r[t]?t:void 0}function r(e,t){for(var n in t)e.style[i(e,n)||n]=t[n];return e}function o(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)void 0===e[i]&&(e[i]=n[i])}return e}function a(e){for(var t={x:e.offsetLeft,y:e.offsetTop};e=e.offsetParent;)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}function s(e,t){return"string"==typeof e?e:e[t%e.length]}function c(e){return"undefined"==typeof this?new c(e):void(this.opts=o(e||{},c.defaults,p))}function u(){function n(t,n){return e("<"+t+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',n)}h.addRule(".spin-vml","behavior:url(#default#VML)"),c.prototype.lines=function(e,i){function o(){return r(n("group",{coordsize:d+" "+d,coordorigin:-u+" "+-u}),{width:d,height:d})}function a(e,a,c){t(f,t(r(o(),{rotation:360/i.lines*e+"deg",left:~~a}),t(r(n("roundrect",{arcsize:i.corners}),{width:u,height:i.width,left:i.radius,top:-i.width>>1,filter:c}),n("fill",{color:s(i.color,e),opacity:i.opacity}),n("stroke",{opacity:0}))))}var c,u=i.length+i.width,d=2*u,l=2*-(i.width+i.length)+"px",f=r(o(),{position:"absolute",top:l,left:l});if(i.shadow)for(c=1;c<=i.lines;c++)a(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=i.lines;c++)a(c);return t(e,f)},c.prototype.opacity=function(e,t,n,i){var r=e.firstChild;i=i.shadow&&i.lines||0,r&&t+i<r.childNodes.length&&(r=r.childNodes[t+i],r=r&&r.firstChild,r=r&&r.firstChild,r&&(r.opacity=n))}}var d,l=["webkit","Moz","ms","O"],f={},h=function(){var n=e("style",{type:"text/css"});return t(document.getElementsByTagName("head")[0],n),n.sheet||n.styleSheet}(),p={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto",position:"relative"};c.defaults={},o(c.prototype,{spin:function(t){this.stop();var n,i,o=this,s=o.opts,c=o.el=r(e(0,{className:s.className}),{position:s.position,width:0,zIndex:s.zIndex}),u=s.radius+s.length+s.width;if(t&&(t.insertBefore(c,t.firstChild||null),i=a(t),n=a(c),r(c,{left:("auto"==s.left?i.x-n.x+(t.offsetWidth>>1):parseInt(s.left,10)+u)+"px",top:("auto"==s.top?i.y-n.y+(t.offsetHeight>>1):parseInt(s.top,10)+u)+"px"})),c.setAttribute("role","progressbar"),o.lines(c,o.opts),!d){var l,f=0,h=(s.lines-1)*(1-s.direction)/2,p=s.fps,g=p/s.speed,m=(1-s.opacity)/(g*s.trail/100),v=g/s.lines;!function y(){f++;for(var e=0;e<s.lines;e++)l=Math.max(1-(f+(s.lines-e)*v)%g*m,s.opacity),o.opacity(c,e*s.direction+h,l,s);o.timeout=o.el&&setTimeout(y,~~(1e3/p))}()}return o},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=void 0),this},lines:function(i,o){function a(t,n){return r(e(),{position:"absolute",width:o.length+o.width+"px",height:o.width+"px",background:t,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/o.lines*u+o.rotate)+"deg) translate("+o.radius+"px,0)",borderRadius:(o.corners*o.width>>1)+"px"})}for(var c,u=0,l=(o.lines-1)*(1-o.direction)/2;u<o.lines;u++)c=r(e(),{position:"absolute",top:1+~(o.width/2)+"px",transform:o.hwaccel?"translate3d(0,0,0)":"",opacity:o.opacity,animation:d&&n(o.opacity,o.trail,l+u*o.direction,o.lines)+" "+1/o.speed+"s linear infinite"}),o.shadow&&t(c,r(a("#000","0 0 4px #000"),{top:"2px"})),t(i,t(c,a(s(o.color,u),"0 0 1px rgba(0,0,0,.1)")));return i},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}});var g=r(e("group"),{behavior:"url(#default#VML)"});return!i(g,"transform")&&g.adj?u():d=i(g,"animation"),c}),define("spin-btn",["spin"],function(e){function t(e,t){this._elem=e,this._spinner=null,this._options=$.extend({color:"#FFF",radius:4,length:4,width:2},t)}return t.prototype={spin:function(){this._spinner||(this._elem.children().css("visibility","hidden"),this._spinner=new e(this._options).spin(this._elem[0]))},stop:function(){this._spinner&&(this._spinner.stop(),this._elem.children().css("visibility","visible"),this._spinner=null)},spinning:function(){return!!this._spinner}},t}),define("savecloud-view",["util","user","storage","sync","article","access-control","tracker","intro-tooltips","popover","spin-btn"],function(e,t,n,i,r,o,a,s,c,u){function d(e){y.spinning()||(y.spin(),i.add(function(){y.stop(),i.isAdded(function(t){e&&e(t)})}),a.saveCloud())}function l(){y.spinning()||(y.spin(),i.remove(function(){y.stop()}))}function f(){v.hasClass("saved")?l():d()}function h(){$(function(){v=$("#cloud-save"),g=$("#cloud-save-menu"),m=$("#cloud-first-add-dialog"),y=new u(v),r.onAccessCheck(function(){$(document.body).toggleClass("rainbow",!r.get().sync_enabled)}),i.onAdd(function(){v.addClass("saved")}),i.onRemove(function(){v.removeClass("saved")}),$(i).on("added",function(){s.active()||n.getItem("sync-used")||(n.setItem("sync-used",!0),setTimeout(function(){c.open({placement:"up",content:m,anchor:v})},1e3))}),g.find(".sign-in").click(function(){return c.close(v),t.showRegister({tracking_action:"add_to_library",tracking_origin:a.trackingOrigin()},function(){o.onLoginCheck(function(){d()})}),!1}),v.click(function(){t.signedIn()?f():c.toggle({placement:"up",content:g,anchor:v})})})}var p={},g=null,m=null,v=null,y=null;return h(),p.saveToCloud=d,p}),define("checkout-view",["util","message-receiver","user","article","access-control","viewer","tracker","spin"],function(e,t,n,i,r,o,a,s){function c(){w.attr("src")||(d(),$(t).one("checkout:new",l),w.on("load",l),w.attr("src",w.data("src")))}function u(){w.attr("src")&&(w.removeAttr("src"),c())}function d(){w.css("visibility","hidden"),b.show(),_.spin(b.find(".spinner")[0]),x=e.timer.tic()}function l(){e.log("checkout load time:",e.timer.toc(x)+"ms"),w.off("load"),_.stop(),b.hide(),w.css("visibility","visible")}function f(){arguments.callee.initalized||(arguments.callee.initalized=!0,$(o).on("scroll.checkout",e.throttle(function(){o.eachVisiblePage(function(e,t){return t.hasAccess()?void 0:($(o).off("scroll.checkout"),g(),!1)})},500)))}function h(e){$("#content").toggleClass("non-purchasable",!e.purchasable)}function p(){$(t).on("checkout:success",function(e,t){a.purchase(t),r.checkAccess()}),$(t).on("checkout:auth",function(e,t){$(n).off("auth.checkout"),n.set(t.user,t.auth),$(n).on("auth.checkout",u)}),$(t).on("checkout:redirect",function(e,t){location.href=t.url}),$(function(){y=$("#sidepanel-checkout"),w=y.find("iframe.checkout"),b=y.find(".loading-screen"),_=new s({color:"#0697fe",radius:20,length:40,width:2}),y.one("open",c),$(n).on("auth.checkout",u),i.onceAccessChecked(f),i.onceAccessChecked(h),i.onAccessCheck(function(){i.hasAccess()?y.trigger("hide"):(y.trigger("show"),window.readcube.show_checkout&&g())})})}function g(){y.trigger("tab:open")}function m(){y.trigger("tab:close")}var v={},y=null,w=null,b=null,_=null,x=null;return p(),v.open=g,v.close=m,v}),define("dialog-modal",function(){var e=200,t=400,n=function(n){function i(){return $('<div class="modal-bg"></div>')}function r(e){return $('<div class="modal '+y+'"></div>').click(function(e){e.stopPropagation()}).append(e)}function o(){$(document.body).addClass("modal-open")}function a(){$(document.body).removeClass("modal-open")}function s(){$(window).unbind("keydown.dialog-modal")}function c(){s(),$(window).bind("keydown.dialog-modal",function(e){return e.metaKey||e.ctrlKey?void 0:27==e.keyCode&&f()?(u(),!1):void 0})}function u(n){return v||!g?(n&&n(),!1):(v=!0,s(),m.animate({top:"-100%",bottom:"100%"},t,function(){m.detach(),m=null,g.fadeOut(e,function(){g.remove(),a(),g=null,v=!1,n&&n()})}),!0)}function d(){return v||!g?!1:(s(),m.detach(),g.remove(),a(),m=null,g=null,v=!1,!0)}function l(n,a){return v||g?(a&&a(),!1):(v=!0,o(),g=i(),m=r(n),g.appendTo(document.body),m.appendTo(g),g.click(function(){return u(),!1}),g.fadeIn(e,function(){m.animate({top:"0%",bottom:"0%"},t,function(){c(),v=!1,a&&a()})}),!0)}function f(){return null!=g}function h(e,t){f()?u(t):l(e,t)}function p(e){m&&m.removeClass(y).addClass(e),y=e}var g=null,m=null,v=!1,y=n;return{show:l,hide:u,hideIm:d,isOpen:f,toggle:h,setClass:p}};return n}),define("print-modal",["dialog-modal"],function(e){var t=function(){function t(e){return d.show(u,e)}function n(e){return d.hide(e)}function i(){return d.hideIm()}function r(){return d.isOpen()}function o(e){return d.toggle(u,e)}function a(e){return d.setClass(e)}function s(){var e=$("#templates #print-dialog");u=e.clone().removeAttr("id"),u.find(".print-pdf").click(function(){$(c).trigger("print-pdf")}),u.find(".send-to-tablet").click(function(){$(c).trigger("send-to-tablet")}),u.find(".google-cloud-print").click(function(){$(c).trigger("google-cloud-print")}),u.find(".close-btn").click(function(){n()})}var c={},u=null,d=e("print-options");return s(),c.show=t,c.hide=n,c.hideIm=i,c.isOpen=r,c.toggle=o,c.setClass=a,c};return t}),define("format",function(){function e(e){return l[e]}function t(e,t){if(e=(0|e).toString(),e.length<t)for(var n=e.length;t>n;n++)e="0"+e;return e}function n(e){var n=t(e.getFullYear(),4),i=t(e.getMonth()+1,2),r=t(e.getDate(),2),o=t(e.getHours(),2),a=t(e.getMinutes(),2),s=t(e.getSeconds(),2);return[n,"/",i,"/",r," ",o,":",a,":",s].join("")}function i(e){var t=Date.now(),n=t-d,i=new Date(t),r=new Date(n),o=e.toLocaleDateString(),a=e.toLocaleTimeString(),s=o;return o==i.toLocaleDateString()?s="Today,":o==r.toLocaleDateString()&&(s="Yesterday,"),s+=" "+a}function r(e){var n=t(e.getFullYear(),4),i=t(e.getMonth()+1,2),r=t(e.getDate(),2);return[n,"/",i,"/",r].join("")}function o(e){return{hours:Math.floor(e/u),minutes:Math.floor(e%u/c),seconds:Math.round(e%c/s)}}function a(e){var t=o(e),n="hh hours, mm minutes";return 0==t.hours&&(n="mm minutes, ss seconds"),1==t.hours&&n.replace("hours","hour"),1==t.minutes&&n.replace("minutes","minute"),1==t.seconds&&n.replace("seconds","second"),n=n.replace("hh",t.hours),n=n.replace("mm",t.minutes),n.replace("ss",t.seconds)}var s=1e3,c=60*s,u=60*c,d=24*u,l={1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"};return{zfill:t,month:e,preciseDate:n,simpleDate:r,friendlyDate:i,friendlyDuration:a}}),define("i18n",function(){function e(e,n){var i=t[e];if(i&&n)for(o in n)i=i.replace("%{"+o+"}",n[o]);return i}var t={"js.ajax_error":"A communication error has occurred. Please check your internet connection and try again.","js.invalid_email":"You entered an invalid email address.","js.password_too_short":"Password must be at least %{len} characters long.","js.checkout.errors.invalid_number":"The card number you entered is not valid.","js.checkout.errors.invalid_cvc":"The CVC code you entered is not valid.","js.checkout.errors.invalid_expiry":"The expiry date you entered is not valid.","js.checkout.errors.invalid_country":"The country you entered does not match the credit card country.","js.checkout.tier_name.tier_1":"48-hour Rental","js.checkout.tier_name.tier_2":"Cloud Access","js.checkout.tier_name.tier_3":"PDF"};return{t:e}}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),"function"!=typeof Object.create&&(Object.create=function(){var e=function(){};return function(t){if(arguments.length>1)throw Error("Second argument not supported");if("object"!=typeof t)throw TypeError("Argument must be an object");e.prototype=t;var n=new e;return e.prototype=null,n}}()),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,i;if(null==this)throw new TypeError(" this is null or not defined");var r=Object(this),o=r.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),i=0;o>i;){var a;i in r&&(a=r[i],e.call(n,a,i,r)),i++}}),function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return r(n?n:e)},d,d.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t){function n(){}var i=t.exports={};i.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;if((t===window||null===t)&&"process-tick"===e.data&&(e.stopPropagation(),n.length>0)){var i=n.shift();i()}},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),i.title="browser",i.browser=!0,i.env={},i.argv=[],i.on=n,i.addListener=n,i.once=n,i.off=n,i.removeListener=n,i.removeAllListeners=n,i.emit=n,i.binding=function(){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t){"use strict";function n(e){function t(e){return null===u?void l.push(e):void o(function(){var t=u?e.onFulfilled:e.onRejected;if(null===t)return void(u?e.resolve:e.reject)(d);var n;try{n=t(d)}catch(i){return void e.reject(i)}e.resolve(n)})}function a(e){try{if(e===f)throw new TypeError("A promise cannot be resolved with itself.");if(e&&("object"==typeof e||"function"==typeof e)){var t=e.then;if("function"==typeof t)return void r(t.bind(e),a,s)}u=!0,d=e,c()}catch(n){s(n)}}function s(e){u=!1,d=e,c()}function c(){for(var e=0,n=l.length;n>e;e++)t(l[e]);l=null}if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");var u=null,d=null,l=[],f=this;this.then=function(e,r){return new n(function(n,o){t(new i(e,r,n,o))})},r(e,a,s)}function i(e,t,n,i){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.resolve=n,this.reject=i}function r(e,t,n){var i=!1;try{e(function(e){i||(i=!0,t(e))},function(e){i||(i=!0,n(e))})}catch(r){if(i)return;i=!0,n(r)}}var o=e("asap");t.exports=n},{asap:4}],3:[function(e,t){"use strict";function n(e){this.then=function(t){return"function"!=typeof t?this:new i(function(n,i){r(function(){try{n(t(e))}catch(r){i(r)}})})}}var i=e("./core.js"),r=e("asap");t.exports=i,n.prototype=Object.create(i.prototype);var o=new n(!0),a=new n(!1),s=new n(null),c=new n(void 0),u=new n(0),d=new n("");i.resolve=function(e){if(e instanceof i)return e;if(null===e)return s;if(void 0===e)return c;if(e===!0)return o;if(e===!1)return a;if(0===e)return u;if(""===e)return d;if("object"==typeof e||"function"==typeof e)try{var t=e.then;if("function"==typeof t)return new i(t.bind(e))}catch(r){return new i(function(e,t){t(r)})}return new n(e)},i.from=i.cast=function(e){var t=new Error("Promise.from and Promise.cast are deprecated, use Promise.resolve instead");return t.name="Warning",console.warn(t.stack),i.resolve(e)},i.denodeify=function(e,t){return t=t||1/0,function(){var n=this,r=Array.prototype.slice.call(arguments);return new i(function(i,o){for(;r.length&&r.length>t;)r.pop();r.push(function(e,t){e?o(e):i(t)}),e.apply(n,r)})}},i.nodeify=function(e){return function(){var t=Array.prototype.slice.call(arguments),n="function"==typeof t[t.length-1]?t.pop():null;try{return e.apply(this,arguments).nodeify(n)}catch(o){if(null===n||"undefined"==typeof n)return new i(function(e,t){t(o)});r(function(){n(o)})}}},i.all=function(){var e=1===arguments.length&&Array.isArray(arguments[0]),t=Array.prototype.slice.call(e?arguments[0]:arguments);if(!e){var n=new Error("Promise.all should be called with a single array, calling it with multiple arguments is deprecated");n.name="Warning",console.warn(n.stack)}return new i(function(e,n){function i(o,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var s=a.then;if("function"==typeof s)return void s.call(a,function(e){i(o,e)},n)}t[o]=a,0===--r&&e(t)}catch(c){n(c)}}if(0===t.length)return e([]);for(var r=t.length,o=0;o<t.length;o++)i(o,t[o])})},i.reject=function(e){return new i(function(t,n){n(e)})},i.race=function(e){return new i(function(t,n){e.forEach(function(e){i.resolve(e).then(t,n)})})},i.prototype.done=function(){var e=arguments.length?this.then.apply(this,arguments):this;e.then(null,function(e){r(function(){throw e})})},i.prototype.nodeify=function(e){return"function"!=typeof e?this:void this.then(function(t){r(function(){e(null,t)})},function(t){r(function(){e(t)})})},i.prototype["catch"]=function(e){return this.then(null,e)}},{"./core.js":2,asap:4}],4:[function(e,t){(function(e){function n(){for(;r.next;){r=r.next;var e=r.task;r.task=void 0;var t=r.domain;t&&(r.domain=void 0,t.enter());try{e()}catch(i){if(c)throw t&&t.exit(),setTimeout(n,0),t&&t.enter(),i;setTimeout(function(){throw i},0)}t&&t.exit()}a=!1}function i(t){o=o.next={task:t,domain:c&&e.domain,next:null},a||(a=!0,s())}var r={task:void 0,next:null},o=r,a=!1,s=void 0,c=!1;if("undefined"!=typeof e&&e.nextTick)c=!0,s=function(){e.nextTick(n)};else if("function"==typeof setImmediate)s="undefined"!=typeof window?setImmediate.bind(window,n):function(){setImmediate(n)};else if("undefined"!=typeof MessageChannel){var u=new MessageChannel;u.port1.onmessage=n,s=function(){u.port2.postMessage(0)}}else s=function(){setTimeout(n,0)};t.exports=i}).call(this,e("_process"))},{_process:1}],5:[function(){Promise.prototype.done||(Promise.prototype.done=function(e,t){var n="function"==typeof e||"function"==typeof t?this.then(e,t):this;n.then(null,function(e){setTimeout(function(){throw e},0)})})},{}],6:[function(e){"undefined"==typeof Promise?Promise=e("promise"):e("./polyfill-done.js")},{"./polyfill-done.js":5,promise:3}]},{},[6]),define("article-export",["user","article","tracker","checkout-view","savecloud-view","print-modal","popover","browser-detect","format","util","i18n"],function(e,t,n,i,r,o,a,s,c,u,d){function l(){t.onceAccessChecked(function(){t.get().pdf_url?(n.download(!0),window.location=t.get().pdf_url):t.hasAccess()?(a.open({placement:"up",content:y("download"),anchor:$("#save")}),n.download(!1)):(i.open(),n.download(!1))})}function f(){t.onceAccessChecked(function(){t.get().print_url?h():t.hasAccess()?a.open({placement:"up",content:y("print"),anchor:$("#print")}):i.open()})}function h(){x.setClass("print-options"),x.show()}function p(){n.print("hd"),x.hideIm();var e=t.get().print_url;"Chrome"==s.browser&&(e=u.addParams(e,{salt:u.guid()})),window.open(e,"_blank").focus()}function g(){return new Promise(function(e){_?e():$.getScript(window.readcube.sources.cpgadget,function(){_=new cloudprint.Gadget,e()})})}function m(){n.print("cloud"),x.hideIm(),g().then(function(){_.setPrintDocument("url","",t.get().print_url),_.openPrintDialog()})}function v(){n.print("mobile");var t=function(){r.saveToCloud(function(e){e&&(x.setClass("sync-success"),x.show())})};e.signedIn()?t():(x.hideIm(),e.showLogin({tracking_action:"print_send_to_mobile",tracking_origin:n.trackingOrigin()},t))}function y(e){var n=t.get().purchase,i=t.get().access_shared,r=i?"shared":"purchase",o=$("#"+e+"-"+r+"-unavailable-notice").clone().removeAttr("id");return n?(o.find(".info .purchase-type").html(d.t("js.checkout.tier_name.tier_"+n.tier)),o.find(".info .purchase-date").html(c.simpleDate(new Date(1e3*n.purchasedAt))),o.find(".info").show()):o.find(".info").hide(),o}function w(){x=o(),$(x).on("print-pdf",p),$(x).on("google-cloud-print",m),$(x).on("send-to-tablet",v)}var b={},_=null,x=null;return w(),b.download=l,b.print=f,b}),define("key-handler",["viewer","article-export"],function(e,t){function n(){$(window).on("keydown",function(n){(n.metaKey||n.ctrlKey)&&(70==n.keyCode?e.loadAll():80==n.keyCode&&(n.preventDefault(),t.print()))})}n()}),define("copy-control",["article"],function(e){function t(){$(document).on("contextmenu","#reader",function(e){e.preventDefault()})}function n(){$(document).on("keydown","#reader",function(e){(e.metaKey||e.ctrlKey)&&67==e.keyCode&&e.preventDefault()})}function i(){e.onAccess(function(e){e.access_shared&&$(function(){t(),n()})})}i()}),define("banner",["article","viewer"],function(e,t){function n(){return t.getPageObj(1)}function i(){var e=n();if(e){var t=e.getWidth()*e.getScale(),i=e.getMargin()*e.getScale(),r=t/c.data("original-width"),o=c.data("original-height")*r,a=c.data("bg-original-width"),s=c.data("bg-original-height")*r;c.css({width:t,height:o,margin:i+"px auto","background-size":a+"px "+s+"px"}),c.find("img").each(function(){var e=$(this);e.css({width:e.data("original-width")*r,height:e.data("original-height")*r})})}}function r(){$(function(){c=$("#reader .banner"),c.data("original-width",c.width()),c.data("original-height",c.height()),e.onData(function(e){e.banner&&(o(e.banner),$(t).on("scale",i),t.onInit(i))})})}function o(e){a(e.background,function(t){function n(e){c.append(e),c.data("original-height",Math.max($(e).data("original-height"),c.data("original-height")))}c.css("background-image",'url("'+e.background+'")').show(),c.data("bg-original-width",$(t).data("original-width")),c.data("bg-original-height",$(t).data("original-height")),i(),a(e.left,function(e){e.className="left",n(e),i()}),a(e.center,function(e){e.className="center",n(e),i()}),a(e.right,function(e){e.className="right",n(e),i()})})}function a(e,t){var n=new Image;n.onload=function(){$(n).data("original-width",n.width),$(n).data("original-height",n.height),t(n)},n.src=e}var s={},c=null;return r(),s}),define("input-handler",function(){function e(e){var t=e.attr("class").split(" ");return t=$.grep(t,function(e){return!!f[e]}).sort(function(e,t){return f[e]-f[t]}),t[0]}function t(t,n){n.getElems().on(t+"."+n.getId(),function(n){var i=$(n.target),r=e(i);if(r){var o=i.data(r+h).split(" ").pop();return $(l[o]).trigger(t),!1}})}function n(e,t){t.getElems().off(e+"."+t.getId())}function i(e){for(var n=0;n<d.length;n++)t(d[n],e)}function r(e){for(var t=0;t<d.length;t++)n(d[t],e)}function o(e){var t=e.getId(),n=e.getKlass()+h;e.getElems().each(function(){var e=$(this),i=e.data(n),r=i?[i,t].join(" "):t;e.data(n,r)})}function a(e){var t=e.getId(),n=e.getKlass()+h;e.getElems().each(function(){var e=$(this),i=e.data(n).split(" ");i=$.grep(i,function(e){return e!=t}),e.data(n,i.join(" "))})}function s(e){l[e.getId()]=e,o(e),i(e)}function c(e){r(e),a(e),delete l[e.getId()]}var u={},d=["mouseenter","mouseleave","click"],l={},f={"current-selection":1,"enhanced-reference":2,"enhanced-author":3,annotation:4},h="-input-id";return u.add=s,u.remove=c,u}),define("citations-drawer",["util","viewer"],function(e,t){function n(e){e.addClass("animate-enhanced show-enhanced"),setTimeout(function(){e.removeClass("show-enhanced")},1e3),setTimeout(function(){e.removeClass("animate-enhanced")},1500)
}function i(){var e=t.getPage(),i=t.getPageObj(e);return i.hasText()?(n(i.getElem()),!0):!1}function r(t){var n=t.getKlass()+c,i=t.getElems().addClass(n);"author"==t.getType()?i.filter(function(){return e.containsDiacritic(this.innerText)}).addClass("diacritic"):i.length>1&&i.each(function(e){$(this).addClass(0==e?"leftmost":e==i.length-1?"rightmost":"middle")}),i.on({mouseenter:function(){i.addClass("hover")},mouseleave:function(){i.removeClass("hover")},"open.popover":function(){i.addClass("active")},"close.popover":function(){i.removeClass("active")}})}function o(){}function a(){t.onInit(function(){$(document).one("mousemove.animate-citations",function(){$(document).on("mousemove.animate-citations",function(){i()&&$(document).off("mousemove.animate-citations")})}),$(window).on("keydown",function(e){e.metaKey||e.ctrlKey||82==e.keyCode&&i()})})}var s={},c="-elem-draw";return a(),s.add=r,s.remove=o,s}),function(e){function t(e,t){var n=typeof e[t];return n==b||!(n!=w||!e[t])||"unknown"==n}function n(e,t){return!(typeof e[t]!=w||!e[t])}function i(e,t){return typeof e[t]!=_}function r(e){return function(t,n){for(var i=n.length;i--;)if(!e(t,n[i]))return!1;return!0}}function o(e){return e&&T(e,k)&&E(e,S)}function a(e){return n(e,"body")?e.body:e.getElementsByTagName("body")[0]}function s(e){n(window,"console")&&t(window.console,"log")&&window.console.log(e)}function c(e,t){t?window.alert(e):s(e)}function u(e){O.initialized=!0,O.supported=!1,c("Rangy is not supported on this page in your browser. Reason: "+e,O.config.alertOnFail)}function d(e){c("Rangy warning: "+e,O.config.alertOnWarn)}function l(e){return e.message||e.description||String(e)}function f(){if(!O.initialized){var e,n=!1,i=!1;t(document,"createRange")&&(e=document.createRange(),T(e,C)&&E(e,x)&&(n=!0));var r=a(document);if(!r||"body"!=r.nodeName.toLowerCase())return void u("No body element found");if(r&&t(r,"createTextRange")&&(e=r.createTextRange(),o(e)&&(i=!0)),!n&&!i)return void u("Neither Range nor TextRange are available");O.initialized=!0,O.features={implementsDomRange:n,implementsTextRange:i};var c,d;for(var f in R)(c=R[f])instanceof p&&c.init(c,O);for(var h=0,g=I.length;g>h;++h)try{I[h](O)}catch(m){d="Rangy init listener threw an exception. Continuing. Detail: "+l(m),s(d)}}}function h(e){e=e||window,f();for(var t=0,n=A.length;n>t;++t)A[t](e)}function p(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function g(e,t,n,i){var r=new p(t,n,function(e){if(!e.initialized){e.initialized=!0;try{i(O,e),e.supported=!0}catch(n){var r="Module '"+t+"' failed to load: "+l(n);s(r)}}});R[t]=r}function m(){}function v(){}var y=!1,w="object",b="function",_="undefined",x=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],C=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],S=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],k=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],T=r(t),N=r(n),E=r(i),R={},O={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:t,isHostObject:n,isHostProperty:i,areHostMethods:T,areHostObjects:N,areHostProperties:E,isTextRange:o,getBody:a},features:{},modules:R,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};O.fail=u,O.warn=d,{}.hasOwnProperty?O.util.extend=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&O.util.extend(i,r,!0),e[o]=r);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e}:u("hasOwnProperty not supported"),function(){var e=document.createElement("div");e.appendChild(document.createElement("span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(i){}t||(t=function(e){for(var t=[],n=0,i=e.length;i>n;++n)t[n]=e[n];return t}),O.util.toArray=t}();var $;t(document,"addEventListener")?$=function(e,t,n){e.addEventListener(t,n,!1)}:t(document,"attachEvent")?$=function(e,t,n){e.attachEvent("on"+t,n)}:u("Document does not have required addEventListener or attachEvent method"),O.util.addListener=$;var I=[];O.init=f,O.addInitListener=function(e){O.initialized?e(O):I.push(e)};var A=[];O.addCreateMissingNativeApiListener=function(e){A.push(e)},O.createMissingNativeApi=h,p.prototype={init:function(){for(var e,t,n=this.dependencies||[],i=0,r=n.length;r>i;++i){if(t=n[i],e=R[t],!(e&&e instanceof p))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){O.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){O.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},O.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]),g(!1,e,n,t)},O.createCoreModule=function(e,t,n){g(!0,e,t,n)},O.RangePrototype=m,O.rangePrototype=new m,O.selectionPrototype=new v;var D=!1,M=function(){D||(D=!0,O.initialized||f())};return typeof window==_?void u("No window found"):typeof document==_?void u("No document found"):(t(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",M,!1),$(window,"load",M),y&&!function(e){e(function(){return O.amd=!0,O})}(e.define),void(e.rangy=O))}(this),rangy.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==R||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function i(e){var t=e.parentNode;return 1==t.nodeType?t:null}function r(e){for(var t=0;e=e.previousSibling;)++t;return t}function o(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,i=[];for(n=e;n;n=n.parentNode)i.push(n);for(n=t;n;n=n.parentNode)if(A(i,n))return n;return null}function s(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function c(e,t){return s(e,t,!0)}function u(e,t,n){for(var i,r=n?e:e.parentNode;r;){if(i=r.parentNode,i===t)return r;r=i}return null}function d(e){var t=e.nodeType;return 3==t||4==t||8==t}function l(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function f(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function h(e,t,n){var i=e.cloneNode(!1);if(i.deleteData(0,t),e.deleteData(t,e.length-t),f(i,e),n)for(var o,a=0;o=n[a++];)o.node==e&&o.offset>t?(o.node=i,o.offset-=t):o.node==e.parentNode&&o.offset>r(e)&&++o.offset;return i}function p(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=R)return e.ownerDocument;if(typeof e.document!=R)return e.document;if(e.parentNode)return p(e.parentNode);throw t.createError("getDocument: no document found for node")}function g(e){var n=p(e);if(typeof n.defaultView!=R)return n.defaultView;if(typeof n.parentWindow!=R)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function m(e){if(typeof e.contentDocument!=R)return e.contentDocument;if(typeof e.contentWindow!=R)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=R)return e.contentWindow;if(typeof e.contentDocument!=R)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function y(e){return e&&O.isHostMethod(e,"setTimeout")&&O.isHostObject(e,"document")}function w(e,t,n){var i;if(e?O.isHostProperty(e,"nodeType")?i=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?m(e):p(e):y(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i}function b(e){for(var t;t=e.parentNode;)e=t;return e}function _(e,n,i,o){var s,c,d,l,f;if(e==i)return n===o?0:o>n?-1:1;if(s=u(i,e,!0))return n<=r(s)?-1:1;if(s=u(e,i,!0))return r(s)<o?-1:1;if(c=a(e,i),!c)throw new Error("comparePoints error: nodes have no common ancestor");if(d=e===c?c:u(e,c,!0),l=i===c?c:u(i,c,!0),d===l)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(f=c.firstChild;f;){if(f===d)return-1;if(f===l)return 1;f=f.nextSibling}}function x(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function C(e){if(!e)return"[No node]";if(D&&x(e))return"[Broken node]";if(d(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+r(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function S(e){for(var t,n=p(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function k(e){this.root=e,this._next=e}function T(e){return new k(e)}function N(e,t){this.node=e,this.offset=t}function E(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var R="undefined",O=e.util;O.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),O.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var $=document.createElement("div");O.areHostMethods($,["insertBefore","appendChild","cloneNode"]||!O.areHostObjects($,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),O.isHostProperty($,"innerHTML")||t.fail("Element is missing innerHTML property");var I=document.createTextNode("test");O.areHostMethods(I,["splitText","deleteData","insertData","appendData","cloneNode"]||!O.areHostObjects($,["previousSibling","nextSibling","childNodes","parentNode"])||!O.areHostProperties(I,["data"]))||t.fail("Incomplete Text Node implementation");var A=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},D=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br>",D=x(n),e.features.crashyTextNodes=D}();var M;typeof window.getComputedStyle!=R?M=function(e,t){return g(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=R?M=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),k.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},N.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+C(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},E.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},E.prototype.toString=function(){return this.message},e.dom={arrayContains:A,isHtmlNamespace:n,parentElement:i,getNodeIndex:r,getNodeLength:o,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:c,getClosestAncestorIn:u,isCharacterDataNode:d,isTextOrCommentNode:l,insertAfter:f,splitDataNode:h,getDocument:p,getWindow:g,getIframeWindow:v,getIframeDocument:m,getBody:O.getBody,isWindow:y,getContentDocument:w,getRootContainer:b,comparePoints:_,isBrokenNode:x,inspectNode:C,getComputedStyleProperty:M,fragmentFromNodeChildren:S,createIterator:T,DomPosition:N},e.DOMException=E}),rangy.createCoreModule("DomRange",["DomUtil"],function(e){function t(e,t){return 3!=e.nodeType&&(L(e,t.startContainer)||L(e,t.endContainer))}function n(e){return e.document||W(e.startContainer)}function i(e){return new M(e.parentNode,B(e))}function r(e){return new M(e.parentNode,B(e)+1)}function o(e,t,n){var i=11==e.nodeType?e.firstChild:e;return j(t)?n==t.length?A.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:z(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function a(e,t,i){if(S(e),S(t),n(t)!=n(e))throw new P("WRONG_DOCUMENT_ERR");var r=Y(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=Y(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return i?0>=r&&o>=0:0>r&&o>0}function s(e){for(var t,i,r,o=n(e.range).createDocumentFragment();i=e.next();){if(t=e.isPartiallySelectedSubtree(),i=i.cloneNode(!t),t&&(r=e.getSubtreeIterator(),i.appendChild(s(r)),r.detach()),10==i.nodeType)throw new P("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}function c(e,t,n){var i,r;n=n||{stop:!1};for(var o,a;o=e.next();)if(e.isPartiallySelectedSubtree()){if(t(o)===!1)return void(n.stop=!0);if(a=e.getSubtreeIterator(),c(a,t,n),a.detach(),n.stop)return}else for(i=A.createIterator(o);r=i.next();)if(t(r)===!1)return void(n.stop=!0)}function u(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),u(t),t.detach()):e.remove()}function d(e){for(var t,i,r=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),i=e.getSubtreeIterator(),t.appendChild(d(i)),i.detach()):e.remove(),10==t.nodeType)throw new P("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function l(e,t,n){var i,r=!(!t||!t.length),o=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var a=[];return c(new h(e,!1),function(t){if(!(r&&!i.test(t.nodeType)||o&&!n(t))){var s=e.startContainer;if(t!=s||!j(s)||e.startOffset!=s.length){var c=e.endContainer;t==c&&j(c)&&0==e.endOffset||a.push(t)}}}),a}function f(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+A.inspectNode(e.startContainer)+":"+e.startOffset+", "+A.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function h(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&j(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||j(this.sc)?F(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||j(this.ec)?F(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function p(e){return function(t,n){for(var i,r=n?t:t.parentNode;r;){if(i=r.nodeType,U(e,i))return r;r=r.parentNode}return null}}function g(e,t){if(tt(e,t))throw new P("INVALID_NODE_TYPE_ERR")}function m(e,t){if(!U(t,e.nodeType))throw new P("INVALID_NODE_TYPE_ERR")}function v(e,t){if(0>t||t>(j(e)?e.length:e.childNodes.length))throw new P("INDEX_SIZE_ERR")}function y(e,t){if(X(e,!0)!==X(t,!0))throw new P("WRONG_DOCUMENT_ERR")}function w(e){if(et(e,!0))throw new P("NO_MODIFICATION_ALLOWED_ERR")}function b(e,t){if(!e)throw new P(t)}function _(e){return G&&A.isBrokenNode(e)||!U(K,e.nodeType)&&!X(e,!0)}function x(e,t){return t<=(j(e)?e.length:e.childNodes.length)}function C(e){return!!e.startContainer&&!!e.endContainer&&!_(e.startContainer)&&!_(e.endContainer)&&x(e.startContainer,e.startOffset)&&x(e.endContainer,e.endOffset)}function S(e){if(!C(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function k(e,t){S(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,a=n===r;j(r)&&o>0&&o<r.length&&z(r,o,t),j(n)&&i>0&&i<n.length&&(n=z(n,i,t),a?(o-=i,r=n):r==n.parentNode&&o>=B(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}function T(e){e.START_TO_START=st,e.START_TO_END=ct,e.END_TO_END=ut,e.END_TO_START=dt,e.NODE_BEFORE=lt,e.NODE_AFTER=ft,e.NODE_BEFORE_AND_AFTER=ht,e.NODE_INSIDE=pt}function N(e){T(e),T(e.prototype)}function E(e,t){return function(){S(this);var n,i,o=this.startContainer,a=this.startOffset,s=this.commonAncestorContainer,u=new h(this,!0);o!==s&&(n=F(o,s,!0),i=r(n),o=i.node,a=i.offset),c(u,w),u.reset();var d=e(u);return u.detach(),t(this,o,a,o,a),d}}function R(n,o){function a(e,t){return function(n){m(n,V),m(q(n),K);var o=(e?i:r)(n);(t?s:c)(this,o.node,o.offset)}}function s(e,t,n){var i=e.endContainer,r=e.endOffset;(t!==e.startContainer||n!==e.startOffset)&&((q(t)!=q(i)||1==Y(t,n,i,r))&&(i=t,r=n),o(e,t,n,i,r))}function c(e,t,n){var i=e.startContainer,r=e.startOffset;(t!==e.endContainer||n!==e.endOffset)&&((q(t)!=q(i)||-1==Y(t,n,i,r))&&(i=t,r=n),o(e,i,r,t,n))}var l=function(){};l.prototype=e.rangePrototype,n.prototype=new l,D.extend(n.prototype,{setStart:function(e,t){g(e,!0),v(e,t),s(this,e,t)},setEnd:function(e,t){g(e,!0),v(e,t),c(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],i=t,r=n;switch(e.length){case 3:r=e[2];break;case 4:i=e[2],r=e[3]}o(this,t,n,i,r)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){S(this),e?o(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):o(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){g(e,!0),o(this,e,0,e,H(e))},selectNode:function(e){g(e,!1),m(e,V);var t=i(e),n=r(e);o(this,t.node,t.offset,n.node,n.offset)},extractContents:E(d,o),deleteContents:E(u,o),canSurroundContents:function(){S(this),w(this.startContainer),w(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},splitBoundaries:function(){k(this)},splitBoundariesPreservingPositions:function(e){k(this,e)},normalizeBoundaries:function(){S(this);var e=this.startContainer,t=this.startOffset,n=this.endContainer,i=this.endOffset,r=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(n=e,i=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},a=function(r){var o=r.previousSibling;if(o&&o.nodeType==r.nodeType){e=r;var a=r.length;if(t=o.length,r.insertData(0,o.data),o.parentNode.removeChild(o),e==n)i+=t,n=e;else if(n==r.parentNode){var s=B(r);i==s?(n=r,i=a):i>s&&i--}}},s=!0;if(j(n))n.length==i&&r(n);else{if(i>0){var c=n.childNodes[i-1];c&&j(c)&&r(c)}s=!this.collapsed}if(s){if(j(e))0==t&&a(e);else if(t<e.childNodes.length){var u=e.childNodes[t];u&&j(u)&&a(u)}}else e=n,t=i;o(this,e,t,n,i)},collapseToPoint:function(e,t){g(e,!0),v(e,t),this.setStartAndEnd(e,t)}}),N(n)}function O(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:A.getCommonAncestor(e.startContainer,e.endContainer)}function $(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=A.getDocument(t),O(e)}function I(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,O(this)}var A=e.dom,D=e.util,M=A.DomPosition,P=e.DOMException,j=A.isCharacterDataNode,B=A.getNodeIndex,L=A.isOrIsAncestorOf,W=A.getDocument,Y=A.comparePoints,z=A.splitDataNode,F=A.getClosestAncestorIn,H=A.getNodeLength,U=A.arrayContains,q=A.getRootContainer,G=e.features.crashyTextNodes;h.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,j(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!j(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new I(n(this.range));var t=this._current,i=t,r=0,o=t,a=H(t);L(t,this.sc)&&(i=this.sc,r=this.so),L(t,this.ec)&&(o=this.ec,a=this.eo),$(e,i,r,o,a)}return new h(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var V=[1,3,4,5,7,8,10],K=[2,9,11],Q=[5,6,10,12],Z=[1,3,4,5,7,8,10,11],J=[1,3,4,5,7,8],X=p([9,11]),et=p(Q),tt=p([6,10,12]),nt=document.createElement("style"),it=!1;try{nt.innerHTML="<b>x</b>",it=3==nt.firstChild.nodeType}catch(rt){}e.features.htmlParsingConforms=it;var ot=it?function(e){var t=this.startContainer,n=W(t);if(!t)throw new P("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:j(t)&&(i=A.parentElement(t)),i=null===i||"HTML"==i.nodeName&&A.isHtmlNamespace(W(i).documentElement)&&A.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1),i.innerHTML=e,A.fragmentFromNodeChildren(i)}:function(e){var t=n(this),i=t.createElement("body");return i.innerHTML=e,A.fragmentFromNodeChildren(i)},at=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],st=0,ct=1,ut=2,dt=3,lt=0,ft=1,ht=2,pt=3;D.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){S(this),y(this.startContainer,t.startContainer);var n,i,r,o,a=e==dt||e==st?"start":"end",s=e==ct||e==st?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],r=t[s+"Container"],o=t[s+"Offset"],Y(n,i,r,o)},insertNode:function(e){if(S(this),m(e,Z),w(this.startContainer),L(e,this.startContainer))throw new P("HIERARCHY_REQUEST_ERR");var t=o(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){S(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&j(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var i=new h(this,!0);return e=s(i),i.detach(),e},canSurroundContents:function(){S(this),w(this.startContainer),w(this.endContainer);var e=new h(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(m(e,J),!this.canSurroundContents())throw new P("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);o(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){S(this);for(var e,t=new I(n(this)),i=at.length;i--;)e=at[i],t[e]=this[e];return t},toString:function(){S(this);var e=this.startContainer;if(e===this.endContainer&&j(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new h(this,!0);return c(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){S(this);var t=e.parentNode,n=B(e);if(!t)throw new P("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return 0>i?r>0?ht:lt:r>0?ft:pt},comparePoint:function(e,t){return S(this),b(e,"HIERARCHY_REQUEST_ERR"),y(e,this.startContainer),Y(e,t,this.startContainer,this.startOffset)<0?-1:Y(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ot,toHtml:function(){S(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(S(this),b(e,"NOT_FOUND_ERR"),W(e)!==n(this))return!1;var i=e.parentNode,r=B(e);b(i,"NOT_FOUND_ERR");var o=Y(i,r,this.endContainer,this.endOffset),a=Y(i,r+1,this.startContainer,this.startOffset);return t?0>=o&&a>=0:0>o&&a>0},isPointInRange:function(e,t){return S(this),b(e,"HIERARCHY_REQUEST_ERR"),y(e,this.startContainer),Y(e,t,this.startContainer,this.startOffset)>=0&&Y(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return a(this,e,!1)},intersectsOrTouchesRange:function(e){return a(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=Y(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=Y(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==Y(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==Y(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new P("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==pt},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,H(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var i=n.pop();return t.setEnd(i,i.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return S(this),l(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var i=n(this),r=e.createRange(i);t=t||A.getBody(i),r.selectNodeContents(t);var o=this.intersection(r),a=0,s=0;return o&&(r.setEnd(o.startContainer,o.startOffset),a=r.toString().length,s=a+o.toString().length),{start:a,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,a,s=[t],c=!1,u=!1;!u&&(i=s.pop());)if(3==i.nodeType)r=n+i.length,!c&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),c=!0),c&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),u=!0),n=r;else for(a=i.childNodes,o=a.length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return I.rangesEqual(this,e)},isValid:function(){return C(this)},inspect:function(){return f(this)},detach:function(){}}),R(I,$),D.extend(I,{rangeProperties:at,RangeIterator:h,copyComparisonConstants:N,createPrototypeRange:R,inspect:f,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=I}),rangy.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,i,r=e.dom,o=e.util,a=r.DomPosition,s=e.DomRange,c=r.getBody,u=r.getContentDocument,d=r.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function i(e){for(var t,n=f.length;n--;)t=f[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==i||e.endOffset!=r,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(i,r),e.setStart(t,n))}var d,l,f=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,i(this)},s.createPrototypeRange(n,a),d=n.prototype,d.selectNode=function(e){this.nativeRange.selectNode(e),i(this)},d.cloneContents=function(){return this.nativeRange.cloneContents()},d.surroundContents=function(e){this.nativeRange.surroundContents(e),i(this)},d.collapse=function(e){this.nativeRange.collapse(e),i(this)},d.cloneRange=function(){return new n(this.nativeRange.cloneRange())},d.refresh=function(){i(this)},d.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");c(document).appendChild(h);var p=document.createRange();p.setStart(h,0),p.setEnd(h,0);try{p.setStart(h,1),d.setStart=function(e,t){this.nativeRange.setStart(e,t),i(this)},d.setEnd=function(e,t){this.nativeRange.setEnd(e,t),i(this)},l=function(e){return function(t){this.nativeRange[e](t),i(this)}}}catch(g){d.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}i(this)},d.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}i(this)},l=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}i(this)}}}d.setStartBefore=l("setStartBefore","setEndBefore"),d.setStartAfter=l("setStartAfter","setEndAfter"),d.setEndBefore=l("setEndBefore","setStartBefore"),d.setEndAfter=l("setEndAfter","setStartAfter"),d.selectNodeContents=function(e){this.setStartAndEnd(e,0,r.getNodeLength(e))},p.selectNodeContents(h),p.setEnd(h,3);var m=document.createRange();m.selectNodeContents(h),m.setEnd(h,4),m.setStart(h,2),d.compareBoundaryPoints=-1==p.compareBoundaryPoints(p.START_TO_END,m)&&1==p.compareBoundaryPoints(p.END_TO_START,m)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var v=document.createElement("div");v.innerHTML="123";var y=v.firstChild,w=c(document);w.appendChild(v),p.setStart(y,1),p.setEnd(y,2),p.deleteContents(),"13"==y.data&&(d.deleteContents=function(){this.nativeRange.deleteContents(),i(this)},d.extractContents=function(){var e=this.nativeRange.extractContents();return i(this),e}),w.removeChild(v),w=null,o.isHostMethod(p,"createContextualFragment")&&(d.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),c(document).removeChild(h),d.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=u(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var l=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();n=e.duplicate(),n.collapse(!1);var o=n.parentElement(),a=i==o?i:r.getCommonAncestor(i,o);return a==t?a:r.getCommonAncestor(t,a)},f=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,i,o){var s=e.duplicate();s.collapse(n);var c=s.parentElement();if(r.isOrIsAncestorOf(t,c)||(c=t),!c.canHaveHTML){var u=new a(c.parentNode,r.getNodeIndex(c));return{boundaryPosition:u,nodeInfo:{nodeIndex:u.offset,containerElement:u.node}}}var l=r.getDocument(c).createElement("span");l.parentNode&&l.parentNode.removeChild(l);for(var f,h,p,g,m,v=n?"StartToStart":"StartToEnd",y=o&&o.containerElement==c?o.nodeIndex:0,w=c.childNodes.length,b=w,_=b;;){if(_==w?c.appendChild(l):c.insertBefore(l,c.childNodes[_]),s.moveToElementText(l),f=s.compareEndPoints(v,e),0==f||y==b)break;if(-1==f){if(b==y+1)break;y=_}else b=b==y+1?y:_;_=Math.floor((y+b)/2),c.removeChild(l)}if(m=l.nextSibling,-1==f&&m&&d(m)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var x;if(/[\r\n]/.test(m.data)){var C=s.duplicate(),S=C.text.replace(/\r\n/g,"\r").length;for(x=C.moveStart("character",S);-1==(f=C.compareEndPoints("StartToEnd",C));)x++,C.moveStart("character",1)}else x=s.text.length;g=new a(m,x)}else h=(i||!n)&&l.previousSibling,p=(i||n)&&l.nextSibling,g=p&&d(p)?new a(p,0):h&&d(h)?new a(h,h.data.length):new a(c,r.getNodeIndex(l));return l.parentNode.removeChild(l),{boundaryPosition:g,nodeInfo:{nodeIndex:_,containerElement:c}}},p=function(e,t){var n,i,o,a,s=e.offset,u=r.getDocument(e.node),l=c(u).createTextRange(),f=d(e.node);return f?(n=e.node,i=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,i=e.node),o=u.createElement("span"),o.innerHTML="&#feff;",n?i.insertBefore(o,n):i.appendChild(o),l.moveToElementText(o),l.collapse(!t),i.removeChild(o),f&&l[t?"moveStart":"moveEnd"]("character",s),l};if(i=function(e){this.textRange=e,this.refresh()},i.prototype=new s(document),i.prototype.refresh=function(){var e,t,n,i=l(this.textRange);f(this.textRange)?t=e=h(this.textRange,i,!0,!0).boundaryPosition:(n=h(this.textRange,i,!0,!1),e=n.boundaryPosition,t=h(this.textRange,i,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},i.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(i),i.rangeToTextRange=function(e){if(e.collapsed)return p(new a(e.startContainer,e.startOffset),!0);var t=p(new a(e.startContainer,e.startOffset),!0),n=p(new a(e.endContainer,e.endOffset),!1),i=c(s.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},e.WrappedTextRange=i,!e.features.implementsDomRange||e.config.preferTextRange){var g=function(){return this
}();"undefined"==typeof g.Range&&(g.Range=i),e.createNativeRange=function(e){return e=u(e,t,"createNativeRange"),c(e).createTextRange()},e.WrappedRange=i}}e.createRange=function(n){return n=u(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=u(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function i(e,n){if(e){if(E.isWindow(e))return e;if(e instanceof v)return e.win;var i=E.getContentDocument(e,t,n);return E.getWindow(i)}return window}function r(e){return i(e,"getWinSelection").getSelection()}function o(e){return i(e,"getDocSelection").document.selection}function a(e){var t=!1;return e.anchorNode&&(t=1==E.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function s(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function c(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function u(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function d(t){var n;return t instanceof $?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof I?n=t.nativeRange:M.implementsDomRange&&t instanceof E.getWindow(t.startContainer).Range&&(n=t),n}function l(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!E.isAncestorOf(e[0],e[t]))return!1;return!0}function f(e){var n=e.getNodes();if(!l(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&"undefined"!=typeof e.text}function p(e,t){var n=new I(t);e._ranges=[n],s(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function g(t){if(t._ranges.length=0,"None"==t.docSelection.type)u(t);else{var n=t.docSelection.createRange();if(h(n))p(t,n);else{t.rangeCount=n.length;for(var i,r=j(n.item(0)),o=0;o<t.rangeCount;++o)i=e.createRange(r),i.selectNode(n.item(o)),t._ranges.push(i);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,s(t,t._ranges[t.rangeCount-1],!1)}}}function m(e,n){for(var i=e.docSelection.createRange(),r=f(n),o=j(i.item(0)),a=B(o).createControlRange(),s=0,c=i.length;c>s;++s)a.add(i.item(s));try{a.add(r)}catch(u){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),g(e)}function v(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function y(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function w(e,t){for(var n,i,r=tt.length;r--;)if(n=tt[r],i=n.selection,"deleteAll"==t)y(i);else if(n.win==e)return"delete"==t?(tt.splice(r,1),!0):i;return"deleteAll"==t&&(tt.length=0),null}function b(e,n){for(var i,r=j(n[0].startContainer),o=B(r).createControlRange(),a=0,s=n.length;s>a;++a){i=f(n[a]);try{o.add(i)}catch(c){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),g(e)}function _(e,t){if(e.win.document!=j(t))throw new A("WRONG_DOCUMENT_ERR")}function x(t){return function(n,i){var r;this.rangeCount?(r=this.getRangeAt(0),r["set"+(t?"Start":"End")](n,i)):(r=e.createRange(this.win.document),r.setStartAndEnd(n,i)),this.setSingleRange(r,this.isBackward())}}function C(e){var t=[],n=new D(e.anchorNode,e.anchorOffset),i=new D(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var o=0,a=e.rangeCount;a>o;++o)t[o]=$.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}e.config.checkSelectionRanges=!0;var S,k,T="boolean",N="number",E=e.dom,R=e.util,O=R.isHostMethod,$=e.DomRange,I=e.WrappedRange,A=e.DOMException,D=E.DomPosition,M=e.features,P="Control",j=E.getDocument,B=E.getBody,L=$.rangesEqual,W=O(window,"getSelection"),Y=R.isHostObject(document,"selection");M.implementsWinGetSelection=W,M.implementsDocSelection=Y;var z=Y&&(!W||e.config.preferTextRange);z?(S=o,e.isSelectionValid=function(e){var t=i(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||j(n.createRange().parentElement())==t}):W?(S=r,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=S;var F=S(),H=e.createNativeRange(document),U=B(document),q=R.areHostProperties(F,["anchorNode","focusNode","anchorOffset","focusOffset"]);M.selectionHasAnchorAndFocus=q;var G=O(F,"extend");M.selectionHasExtend=G;var V=typeof F.rangeCount==N;M.selectionHasRangeCount=V;var K=!1,Q=!0,Z=G?function(t,n){var i=$.getRangeDocument(n),r=e.createRange(i);r.collapseToPoint(n.endContainer,n.endOffset),t.addRange(d(r)),t.extend(n.startContainer,n.startOffset)}:null;R.areHostMethods(F,["addRange","getRangeAt","removeAllRanges"])&&typeof F.rangeCount==N&&M.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,i=[],r=a(t),o=0;n>o;++o)i[o]=t.getRangeAt(o);var s=B(document),c=s.appendChild(document.createElement("div"));c.contentEditable="false";var u=c.appendChild(document.createTextNode("\xa0\xa0\xa0")),d=document.createRange();for(d.setStart(u,1),d.collapse(!0),t.addRange(d),Q=1==t.rangeCount,t.removeAllRanges(),s.removeChild(c),t.removeAllRanges(),o=0;n>o;++o)0==o&&r?Z?Z(t,i[o]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(i[o])):t.addRange(i[o])}}(),M.selectionSupportsMultipleRanges=K,M.collapsedNonEditableSelectionsSupported=Q;var J,X=!1;U&&O(U,"createControlRange")&&(J=U.createControlRange(),R.areHostProperties(J,["item","add"])&&(X=!0)),M.implementsControlRange=X,k=q?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var et;O(F,"getRangeAt")?et=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:q&&(et=function(t){var n=j(t.anchorNode),i=e.createRange(n);return i.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),i}),v.prototype=e.selectionPrototype;var tt=[],nt=function(e){if(e&&e instanceof v)return e.refresh(),e;e=i(e,"getNativeSelection");var t=w(e),n=S(e),r=Y?o(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new v(n,r,e),tt.push({win:e,selection:t})),t};e.getSelection=nt,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(E.getIframeWindow(n))};var it=v.prototype;if(!z&&q&&R.areHostMethods(F,["removeAllRanges","addRange"])){it.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),u(this)};var rt=function(e,t){Z(e.nativeSelection,t),e.refresh()};it.addRange=V?function(t,i){if(X&&Y&&this.docSelection.type==P)m(this,t);else if(n(i)&&G)rt(this,t);else{var r;if(K?r=this.rangeCount:(this.removeAllRanges(),r=0),this.nativeSelection.addRange(d(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var o=et(this.nativeSelection,this.rangeCount-1);o&&!L(o,t)&&(t=new I(o))}this._ranges[this.rangeCount-1]=t,s(this,t,st(this.nativeSelection)),this.isCollapsed=k(this)}else this.refresh()}}:function(e,t){n(t)&&G?rt(this,e):(this.nativeSelection.addRange(d(e)),this.refresh())},it.setRanges=function(e){if(X&&e.length>1)b(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(O(F,"empty")&&O(H,"select")&&X&&z))return t.fail("No means of selecting a Range or TextRange was found"),!1;it.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=j(this.anchorNode);else if(this.docSelection.type==P){var t=this.docSelection.createRange();t.length&&(e=j(t.item(0)))}if(e){var n=B(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(i){}u(this)},it.addRange=function(t){this.docSelection.type==P?m(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,t,!1))},it.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?b(this,e):t&&this.addRange(e[0])}}it.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new A("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var ot;if(z)ot=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=B(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==P?g(t):h(n)?p(t,n):u(t)};else if(O(F,"getRangeAt")&&typeof F.rangeCount==N)ot=function(t){if(X&&Y&&t.docSelection.type==P)g(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,i=t.rangeCount;i>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));s(t,t._ranges[t.rangeCount-1],st(t.nativeSelection)),t.isCollapsed=k(t)}else u(t)};else{if(!q||typeof F.isCollapsed!=T||typeof H.collapsed!=T||!M.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;ot=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=et(n,0),e._ranges=[t],e.rangeCount=1,c(e),e.isCollapsed=k(e)):u(e)}}it.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(ot(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!L(t[r],this._ranges[r]))return!0;return!1}};var at=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;r>i;++i)L(t,n[i])||e.addRange(n[i]);e.rangeCount||u(e)};it.removeRange=X?function(e){if(this.docSelection.type==P){for(var t,n=this.docSelection.createRange(),i=f(e),r=j(n.item(0)),o=B(r).createControlRange(),a=!1,s=0,c=n.length;c>s;++s)t=n.item(s),t!==i||a?o.add(n.item(s)):a=!0;o.select(),g(this)}else at(this,e)}:function(e){at(this,e)};var st;!z&&q&&M.implementsDomRange?(st=a,it.isBackward=function(){return st(this)}):st=it.isBackward=function(){return!1},it.isBackwards=it.isBackward,it.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},it.collapse=function(t,n){_(this,t);var i=e.createRange(t);i.collapseToPoint(t,n),this.setSingleRange(i),this.isCollapsed=!0},it.collapseToStart=function(){if(!this.rangeCount)throw new A("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},it.collapseToEnd=function(){if(!this.rangeCount)throw new A("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},it.selectAllChildren=function(t){_(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},it.deleteFromDocument=function(){if(X&&Y&&this.docSelection.type==P){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;r>i;++i)n[i].deleteContents();this.addRange(n[r-1])}}},it.eachRange=function(e,t){for(var n=0,i=this._ranges.length;i>n;++n)if(e(this.getRangeAt(n)))return t},it.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},it.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},it.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(i){n.push(i[e].apply(i,t))}),n},it.setStart=x(!0),it.setEnd=x(!1),e.rangePrototype.select=function(e){nt(this.getDocument()).setSingleRange(this,e)},it.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},it.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)},it.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},it.moveToBookmark=function(t){for(var n,i,r=[],o=0;n=t.rangeBookmarks[o++];)i=e.createRange(this.win),i.moveToBookmark(n),r.push(i);t.backward?this.setSingleRange(r[0],"backward"):this.setRanges(r)},it.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},it.getName=function(){return"WrappedSelection"},it.inspect=function(){return C(this)},it.detach=function(){w(this.win,"delete"),y(this)},v.detachAll=function(){w(null,"deleteAll")},v.inspect=C,v.isDirectionBackward=n,e.Selection=v,e.selectionPrototype=it,e.addCreateMissingNativeApiListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return nt(e)}),e=null})}),rangy.createModule("TextRange",["WrappedSelection"],function(e,t){function n(e,t){function n(t,n,i){for(var r=e.slice(t,n),o={isWord:i,chars:r,toString:function(){return r.join("")}},a=0,c=r.length;c>a;++a)r[a].token=o;s.push(o)}for(var i,r,o,a=e.join(""),s=[],c=0;i=t.wordRegex.exec(a);){if(r=i.index,o=r+i[0].length,r>c&&n(c,r,!1),t.includeTrailingSpace)for(;Q.test(e[o]);)++o;n(r,o,!0),c=o}return c<e.length&&n(c,e.length,!1),s}function i(e,t){if(e){var n={};return U(n,t),U(n,e,!0),n}return t}function r(e){var t,n;return e?(t=e.language||Z,n={},U(n,at[t]||at[Z]),U(n,e),n):at[Z]}function o(e){return i(e,rt)}function a(e){return i(e,ot)}function s(e){var t=i(e,st);return t.characterOptions=o(t.wordOptions),t}function c(e,t){var n=lt(e,"display",t),i=e.tagName.toLowerCase();return"block"==n&&it&&ft.hasOwnProperty(i)?ft[i]:n}function u(e){for(var t=p(e),n=0,i=t.length;i>n;++n)if(1==t[n].nodeType&&"none"==c(t[n]))return!0;return!1}function d(e){var t;return 3==e.nodeType&&(t=e.parentNode)&&"hidden"==lt(t,"visibility")}function l(e){return e&&(1==e.nodeType&&!/^(inline(-block|-table)?|none)$/.test(c(e))||9==e.nodeType||11==e.nodeType)}function f(e){return F.isCharacterDataNode(e)||!/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i.test(e.nodeName)}function h(e){for(var t=[];e.parentNode;)t.unshift(e.parentNode),e=e.parentNode;return t}function p(e){return h(e).concat([e])}function g(e){for(;e&&!e.nextSibling;)e=e.parentNode;return e?e.nextSibling:null}function m(e,t){return!t&&e.hasChildNodes()?e.firstChild:g(e)}function v(e){var t=e.previousSibling;if(t){for(e=t;e.hasChildNodes();)e=e.lastChild;return e}var n=e.parentNode;return n&&1==n.nodeType?n:null}function y(e){if(!e||3!=e.nodeType)return!1;var t=e.data;if(""===t)return!0;var n=e.parentNode;if(!n||1!=n.nodeType)return!1;var i=lt(e.parentNode,"whiteSpace");return/^[\t\n\r ]+$/.test(t)&&/^(normal|nowrap)$/.test(i)||/^[\t\r ]+$/.test(t)&&"pre-line"==i}function w(e){if(""===e.data)return!0;if(!y(e))return!1;var t=e.parentNode;return t?u(e)?!0:!1:!0}function b(e){var t=e.nodeType;return 7==t||8==t||u(e)||/^(script|style)$/i.test(e.nodeName)||d(e)||w(e)}function _(e,t){var n=e.nodeType;return 7==n||8==n||1==n&&"none"==c(e,t)}function x(){this.store={}}function C(e,t,n){return function(i){var r=this.cache;if(r.hasOwnProperty(e))return ht++,r[e];pt++;var o=t.call(this,n?this[n]:this,i);return r[e]=o,o}}function S(e,t){this.node=e,this.session=t,this.cache=new x,this.positions=new x}function k(e,t){this.offset=t,this.nodeWrapper=e,this.node=e.node,this.session=e.session,this.cache=new x}function T(){return"[Position("+F.inspectNode(this.node)+":"+this.offset+")]"}function N(){return R(),Tt=new Nt}function E(){return Tt||N()}function R(){Tt&&Tt.detach(),Tt=null}function O(e,n,i,r){function o(){var e=null;return n?(e=s,c||(s=s.previousVisible(),c=!s||i&&s.equals(i))):c||(e=s=s.nextVisible(),c=!s||i&&s.equals(i)),c&&(s=null),e}i&&(n?b(i.node)&&(i=e.previousVisible()):b(i.node)&&(i=i.nextVisible()));var a,s=e,c=!1,u=!1;return{next:function(){if(u)return u=!1,a;for(var e,t;e=o();)if(t=e.getCharacter(r))return a=e,e;return null},rewind:function(){if(!a)throw t.createError("createCharacterIterator: cannot rewind. Only one position can be rewound.");u=!0},dispose:function(){e=i=null}}}function $(e,t,n){function i(e){for(var t,n,i=[],a=e?r:o,s=!1,c=!1;t=a.next();){if(n=t.character,K.test(n))c&&(c=!1,s=!0);else{if(s){a.rewind();break}c=!0}i.push(t)}return i}var r=O(e,!1,null,t),o=O(e,!0,null,t),a=n.tokenizer,s=i(!0),c=i(!1).reverse(),u=a(c.concat(s),n),d=s.length?u.slice(Et(u,s[0].token)):[],l=c.length?u.slice(0,Et(u,c.pop().token)+1):[];return{nextEndToken:function(){for(var e,t;1==d.length&&!(e=d[0]).isWord&&(t=i(!0)).length>0;)d=a(e.chars.concat(t),n);return d.shift()},previousStartToken:function(){for(var e,t;1==l.length&&!(e=l[0]).isWord&&(t=i(!1)).length>0;)l=a(t.reverse().concat(e.chars),n);return l.pop()},dispose:function(){r.dispose(),o.dispose(),d=l=null}}}function I(e,t,n,i,r){var o,a,s,c,u=0,d=e,l=Math.abs(n);if(0!==n){var f=0>n;switch(t){case Y:for(a=O(e,f,null,i);(o=a.next())&&l>u;)++u,d=o;s=o,a.dispose();break;case z:for(var h=$(e,i,r),p=f?h.previousStartToken:h.nextEndToken;(c=p())&&l>u;)c.isWord&&(++u,d=f?c.chars[0]:c.chars[c.chars.length-1]);break;default:throw new Error("movePositionBy: unit '"+t+"' not implemented")}f?(d=d.previousVisible(),u=-u):d&&d.isLeadingSpace&&(t==z&&(a=O(e,!1,null,i),s=a.next(),a.dispose()),s&&(d=s.previousVisible()))}return{position:d,unitsMoved:u}}function A(e,t,n,i){var r=e.getRangeBoundaryPosition(t,!0),o=e.getRangeBoundaryPosition(t,!1),a=i?o:r,s=i?r:o;return O(a,!!i,s,n)}function D(e,t,n){for(var i,r=[],o=A(e,t,n);i=o.next();)r.push(i);return o.dispose(),r}function M(t,n,i){var r=e.createRange(t.node);r.setStartAndEnd(t.node,t.offset,n.node,n.offset);var o=!r.expand("word",i);return o}function P(e,t,n,i,r){function o(e,t){var n=g[e].previousVisible(),i=g[t-1],o=!r.wholeWordsOnly||M(n,i,r.wordOptions);return{startPos:n,endPos:i,valid:o}}for(var a,s,c,u,d,l,f=J(r.direction),h=O(e,f,e.session.getRangeBoundaryPosition(i,f),r.characterOptions),p="",g=[],m=null;a=h.next();)if(s=a.character,n||r.caseSensitive||(s=s.toLowerCase()),f?(g.unshift(a),p=s+p):(g.push(a),p+=s),n){if(d=t.exec(p))if(l){if(c=d.index,u=c+d[0].length,!f&&u<p.length||f&&c>0){m=o(c,u);break}}else l=!0}else if(-1!=(c=p.indexOf(t))){m=o(c,c+t.length);break}return l&&(m=o(c,u)),h.dispose(),m}function j(e){return function(){var t=!!Tt,n=E(),i=[n].concat(H.toArray(arguments)),r=e.apply(this,i);return t||R(),r}}function B(e,t){return j(function(n,a,s,c){"undefined"==typeof s&&(s=a,a=Y),c=i(c,ct);var u=o(c.characterOptions),d=r(c.wordOptions),l=e;t&&(l=s>=0,this.collapse(!l));var f=I(n.getRangeBoundaryPosition(this,l),a,s,u,d),h=f.position;return this[l?"setStart":"setEnd"](h.node,h.offset),f.unitsMoved})}function L(e){return j(function(t,n){n=o(n);for(var i,r=A(t,this,n,!e),a=0;(i=r.next())&&K.test(i.character);)++a;r.dispose();var s=a>0;return s&&this[e?"moveStart":"moveEnd"]("character",e?a:-a,{characterOptions:n}),s})}function W(e){return j(function(t,n){var i=!1;return this.changeEachRange(function(t){i=t[e](n)||i}),i})}var Y="character",z="word",F=e.dom,H=e.util,U=H.extend,q=F.getBody,G=/^[ \t\f\r\n]+$/,V=/^[ \t\f\r]+$/,K=/^[\t-\r \u0085\u00A0\u1680\u180E\u2000-\u200B\u2028\u2029\u202F\u205F\u3000]+$/,Q=/^[\t \u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]+$/,Z="en",J=e.Selection.isDirectionBackward,X=!1,et=!1,tt=!1,nt=!0;!function(){var t=document.createElement("div");t.contentEditable="true",t.innerHTML="<p>1 </p><p></p>";var n=q(document),i=t.firstChild,r=e.getSelection();n.appendChild(t),r.collapse(i.lastChild,2),r.setStart(i.firstChild,0),X=1==(""+r).length,t.innerHTML="1 <br>",r.collapse(t,2),r.setStart(t.firstChild,0),et=1==(""+r).length,t.innerHTML="1 <p>1</p>",r.collapse(t,2),r.setStart(t.firstChild,0),tt=1==(""+r).length,n.removeChild(t),r.removeAllRanges()}();var it,rt={includeBlockContentTrailingSpace:!0,includeSpaceBeforeBr:!0,includeSpaceBeforeBlock:!0,includePreLineTrailingSpace:!0},ot={includeBlockContentTrailingSpace:!nt,includeSpaceBeforeBr:!et,includeSpaceBeforeBlock:!tt,includePreLineTrailingSpace:!0},at={en:{wordRegex:/[a-z0-9]+('[a-z0-9]+)*/gi,includeTrailingSpace:!1,tokenizer:n}},st={caseSensitive:!1,withinRange:null,wholeWordsOnly:!1,wrap:!1,direction:"forward",wordOptions:null,characterOptions:null},ct={wordOptions:null,characterOptions:null},ut={wordOptions:null,characterOptions:null,trim:!1,trimStart:!0,trimEnd:!0},dt={wordOptions:null,characterOptions:null,direction:"forward"},lt=F.getComputedStyleProperty;!function(){var e=document.createElement("table"),t=q(document);t.appendChild(e),it="block"==lt(e,"display"),t.removeChild(e)}(),e.features.tableCssDisplayBlock=it;var ft={table:"table",caption:"table-caption",colgroup:"table-column-group",col:"table-column",thead:"table-header-group",tbody:"table-row-group",tfoot:"table-footer-group",tr:"table-row",td:"table-cell",th:"table-cell"};x.prototype={get:function(e){return this.store.hasOwnProperty(e)?this.store[e]:null},set:function(e,t){return this.store[e]=t}};var ht=0,pt=0,gt={getPosition:function(e){var t=this.positions;return t.get(e)||t.set(e,new k(this,e))},toString:function(){return"[NodeWrapper("+F.inspectNode(this.node)+")]"}};S.prototype=gt;var mt="EMPTY",vt="NON_SPACE",yt="UNCOLLAPSIBLE_SPACE",wt="COLLAPSIBLE_SPACE",bt="TRAILING_SPACE_BEFORE_BLOCK",_t="TRAILING_SPACE_IN_BLOCK",xt="TRAILING_SPACE_BEFORE_BR",Ct="PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK",St="TRAILING_LINE_BREAK_AFTER_BR";U(gt,{isCharacterDataNode:C("isCharacterDataNode",F.isCharacterDataNode,"node"),getNodeIndex:C("nodeIndex",F.getNodeIndex,"node"),getLength:C("nodeLength",F.getNodeLength,"node"),containsPositions:C("containsPositions",f,"node"),isWhitespace:C("isWhitespace",y,"node"),isCollapsedWhitespace:C("isCollapsedWhitespace",w,"node"),getComputedDisplay:C("computedDisplay",c,"node"),isCollapsed:C("collapsed",b,"node"),isIgnored:C("ignored",_,"node"),next:C("nextPos",m,"node"),previous:C("previous",v,"node"),getTextNodeInfo:C("textNodeInfo",function(e){var t=null,n=!1,i=lt(e.parentNode,"whiteSpace"),r="pre-line"==i;return r?(t=V,n=!0):("normal"==i||"nowrap"==i)&&(t=G,n=!0),{node:e,text:e.data,spaceRegex:t,collapseSpaces:n,preLine:r}},"node"),hasInnerText:C("hasInnerText",function(e,t){for(var n=this.session,i=n.getPosition(e.parentNode,this.getNodeIndex()+1),r=n.getPosition(e,0),o=t?i:r,a=t?r:i;o!==a;){if(o.prepopulateChar(),o.isDefinitelyNonEmpty())return!0;o=t?o.previousVisible():o.nextVisible()}return!1},"node"),isRenderedBlock:C("isRenderedBlock",function(e){for(var t=e.getElementsByTagName("br"),n=0,i=t.length;i>n;++n)if(!b(t[n]))return!0;return this.hasInnerText()},"node"),getTrailingSpace:C("trailingSpace",function(e){if("br"==e.tagName.toLowerCase())return"";switch(this.getComputedDisplay()){case"inline":for(var t=e.lastChild;t;){if(!_(t))return 1==t.nodeType?this.session.getNodeWrapper(t).getTrailingSpace():"";t=t.previousSibling}break;case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":break;case"table-cell":return"	";default:return this.isRenderedBlock(!0)?"\n":""}return""},"node"),getLeadingSpace:C("leadingSpace",function(){switch(this.getComputedDisplay()){case"inline":case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":case"table-cell":break;default:return this.isRenderedBlock(!1)?"\n":""}return""},"node")});var kt={character:"",characterType:mt,isBr:!1,prepopulateChar:function(){var e=this;if(!e.prepopulatedChar){var t=e.node,n=e.offset,i="",r=mt,o=!1;if(n>0)if(3==t.nodeType){var a=t.data,s=a.charAt(n-1),c=e.nodeWrapper.getTextNodeInfo(),u=c.spaceRegex;c.collapseSpaces?u.test(s)?n>1&&u.test(a.charAt(n-2))||(c.preLine&&"\n"===a.charAt(n)?(i=" ",r=Ct):(i=" ",r=wt)):(i=s,r=vt,o=!0):(i=s,r=yt,o=!0)}else{var d=t.childNodes[n-1];if(d&&1==d.nodeType&&!b(d)&&("br"==d.tagName.toLowerCase()?(i="\n",e.isBr=!0,r=wt,o=!1):e.checkForTrailingSpace=!0),!i){var l=t.childNodes[n];l&&1==l.nodeType&&!b(l)&&(e.checkForLeadingSpace=!0)}}e.prepopulatedChar=!0,e.character=i,e.characterType=r,e.isCharInvariant=o}},isDefinitelyNonEmpty:function(){var e=this.characterType;return e==vt||e==yt},resolveLeadingAndTrailingSpaces:function(){if(this.prepopulatedChar||this.prepopulateChar(),this.checkForTrailingSpace){var e=this.session.getNodeWrapper(this.node.childNodes[this.offset-1]).getTrailingSpace();e&&(this.isTrailingSpace=!0,this.character=e,this.characterType=wt),this.checkForTrailingSpace=!1}if(this.checkForLeadingSpace){var t=this.session.getNodeWrapper(this.node.childNodes[this.offset]).getLeadingSpace();t&&(this.isLeadingSpace=!0,this.character=t,this.characterType=wt),this.checkForLeadingSpace=!1}},getPrecedingUncollapsedPosition:function(e){for(var t,n=this;n=n.previousVisible();)if(t=n.getCharacter(e),""!==t)return n;return null},getCharacter:function(e){function t(){return c||(o=u.getPrecedingUncollapsedPosition(e),c=!0),o}if(this.resolveLeadingAndTrailingSpaces(),this.isCharInvariant)return this.character;var n=["character",e.includeSpaceBeforeBr,e.includeBlockContentTrailingSpace,e.includePreLineTrailingSpace].join("_"),i=this.cache.get(n);if(null!==i)return i;var r,o,a="",s=this.characterType==wt,c=!1,u=this;return s?(" "!=this.character||t()&&!o.isTrailingSpace&&"\n"!=o.character)&&("\n"==this.character&&this.isLeadingSpace?t()&&"\n"!=o.character&&(a="\n"):(r=this.nextUncollapsed(),r&&(r.isBr?this.type=xt:r.isTrailingSpace&&"\n"==r.character?this.type=_t:r.isLeadingSpace&&"\n"==r.character&&(this.type=bt),"\n"===r.character?(this.type!=xt||e.includeSpaceBeforeBr)&&(this.type!=bt||e.includeSpaceBeforeBlock)&&(this.type==_t&&r.isTrailingSpace&&!e.includeBlockContentTrailingSpace||(this.type!=Ct||r.type!=vt||e.includePreLineTrailingSpace)&&("\n"===this.character?r.isTrailingSpace?this.isTrailingSpace||this.isBr&&(r.type=St,t()&&o.isLeadingSpace&&"\n"==o.character&&(r.character="")):a="\n":" "===this.character&&(a=" "))):a=this.character))):"\n"===this.character&&(!(r=this.nextUncollapsed())||r.isTrailingSpace),this.cache.set(n,a),a},equals:function(e){return!!e&&this.node===e.node&&this.offset===e.offset},inspect:T,toString:function(){return this.character}};k.prototype=kt,U(kt,{next:C("nextPos",function(e){var t=e.nodeWrapper,n=e.node,i=e.offset,r=t.session;if(!n)return null;var o,a,s;return i==t.getLength()?(o=n.parentNode,a=o?t.getNodeIndex()+1:0):t.isCharacterDataNode()?(o=n,a=i+1):(s=n.childNodes[i],r.getNodeWrapper(s).containsPositions()?(o=s,a=0):(o=n,a=i+1)),o?r.getPosition(o,a):null}),previous:C("previous",function(e){var t,n,i,r=e.nodeWrapper,o=e.node,a=e.offset,s=r.session;return 0==a?(t=o.parentNode,n=t?r.getNodeIndex():0):r.isCharacterDataNode()?(t=o,n=a-1):(i=o.childNodes[a-1],s.getNodeWrapper(i).containsPositions()?(t=i,n=F.getNodeLength(i)):(t=o,n=a-1)),t?s.getPosition(t,n):null}),nextVisible:C("nextVisible",function(e){var t=e.next();if(!t)return null;var n=t.nodeWrapper,i=t.node,r=t;return n.isCollapsed()&&(r=n.session.getPosition(i.parentNode,n.getNodeIndex()+1)),r}),nextUncollapsed:C("nextUncollapsed",function(e){for(var t=e;t=t.nextVisible();)if(t.resolveLeadingAndTrailingSpaces(),""!==t.character)return t;return null}),previousVisible:C("previousVisible",function(e){var t=e.previous();if(!t)return null;var n=t.nodeWrapper,i=t.node,r=t;return n.isCollapsed()&&(r=n.session.getPosition(i.parentNode,n.getNodeIndex())),r})});var Tt=null,Nt=function(){function e(e){var t=new x;return{get:function(n){var i=t.get(n[e]);if(i)for(var r,o=0;r=i[o++];)if(r.node===n)return r;return null},set:function(n){var i=n.node[e],r=t.get(i)||t.set(i,[]);r.push(n)}}}function t(){this.initCaches()}var n=H.isHostProperty(document.documentElement,"uniqueID");return t.prototype={initCaches:function(){this.elementCache=n?function(){var e=new x;return{get:function(t){return e.get(t.uniqueID)},set:function(t){e.set(t.node.uniqueID,t)}}}():e("tagName"),this.textNodeCache=e("data"),this.otherNodeCache=e("nodeName")},getNodeWrapper:function(e){var t;switch(e.nodeType){case 1:t=this.elementCache;break;case 3:t=this.textNodeCache;break;default:t=this.otherNodeCache}var n=t.get(e);return n||(n=new S(e,this),t.set(n)),n},getPosition:function(e,t){return this.getNodeWrapper(e).getPosition(t)},getRangeBoundaryPosition:function(e,t){var n=t?"start":"end";return this.getPosition(e[n+"Container"],e[n+"Offset"])},detach:function(){this.elementCache=this.textNodeCache=this.otherNodeCache=null}},t}();U(F,{nextNode:m,previousNode:v});var Et=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0,i=e.length;i>n;++n)if(e[n]===t)return n;return-1};U(e.rangePrototype,{moveStart:B(!0,!1),moveEnd:B(!1,!1),move:B(!0,!0),trimStart:L(!0),trimEnd:L(!1),trim:j(function(e,t){var n=this.trimStart(t),i=this.trimEnd(t);return n||i}),expand:j(function(e,t,n){var a=!1;n=i(n,ut);var s=o(n.characterOptions);if(t||(t=Y),t==z){var c,u,d=r(n.wordOptions),l=e.getRangeBoundaryPosition(this,!0),f=e.getRangeBoundaryPosition(this,!1),h=$(l,s,d),p=h.nextEndToken(),g=p.chars[0].previousVisible();if(this.collapsed)c=p;else{var m=$(f,s,d);c=m.previousStartToken()}return u=c.chars[c.chars.length-1],g.equals(l)||(this.setStart(g.node,g.offset),a=!0),u&&!u.equals(f)&&(this.setEnd(u.node,u.offset),a=!0),n.trim&&(n.trimStart&&(a=this.trimStart(s)||a),n.trimEnd&&(a=this.trimEnd(s)||a)),a}return this.moveEnd(Y,1,n)}),text:j(function(e,t){return this.collapsed?"":D(e,this,o(t)).join("")}),selectCharacters:j(function(e,t,n,i,r){var o={characterOptions:r};t||(t=q(this.getDocument())),this.selectNodeContents(t),this.collapse(!0),this.moveStart("character",n,o),this.collapse(!0),this.moveEnd("character",i-n,o)}),toCharacterRange:j(function(e,t,n){t||(t=q(this.getDocument()));var i,r,o=t.parentNode,a=F.getNodeIndex(t),s=-1==F.comparePoints(this.startContainer,this.endContainer,o,a),c=this.cloneRange();return s?(c.setStartAndEnd(this.startContainer,this.startOffset,o,a),i=-c.text(n).length):(c.setStartAndEnd(o,a,this.startContainer,this.startOffset),i=c.text(n).length),r=i+this.text(n).length,{start:i,end:r}}),findText:j(function(t,n,i){i=s(i),i.wholeWordsOnly&&(i.wordOptions=r(i.wordOptions),i.wordOptions.includeTrailingSpace=!1);var o=J(i.direction),a=i.withinRange;a||(a=e.createRange(),a.selectNodeContents(this.getDocument()));var c=n,u=!1;"string"==typeof c?i.caseSensitive||(c=c.toLowerCase()):u=!0;var d=t.getRangeBoundaryPosition(this,!o),l=a.comparePoint(d.node,d.offset);-1===l?d=t.getRangeBoundaryPosition(a,!0):1===l&&(d=t.getRangeBoundaryPosition(a,!1));for(var f,h=d,p=!1;;)if(f=P(h,c,u,a,i)){if(f.valid)return this.setStartAndEnd(f.startPos.node,f.startPos.offset,f.endPos.node,f.endPos.offset),!0;h=o?f.startPos:f.endPos}else{if(!i.wrap||p)return!1;a=a.cloneRange(),h=t.getRangeBoundaryPosition(a,!o),a.setBoundary(d.node,d.offset,o),p=!0}}),pasteHtml:function(e){if(this.deleteContents(),e){var t=this.createContextualFragment(e),n=t.lastChild;this.insertNode(t),this.collapseAfter(n)}}}),U(e.selectionPrototype,{expand:j(function(e,t,n){this.changeEachRange(function(e){e.expand(t,n)})}),move:j(function(e,t,n,i){var r=0;if(this.focusNode){this.collapse(this.focusNode,this.focusOffset);var o=this.getRangeAt(0);i||(i={}),i.characterOptions=a(i.characterOptions),r=o.move(t,n,i),this.setSingleRange(o)}return r}),trimStart:W("trimStart"),trimEnd:W("trimEnd"),trim:W("trim"),selectCharacters:j(function(t,n,i,r,o,a){var s=e.createRange(n);s.selectCharacters(n,i,r,a),this.setSingleRange(s,o)}),saveCharacterRanges:j(function(e,t,n){for(var i=this.getAllRanges(),r=i.length,o=[],a=1==r&&this.isBackward(),s=0,c=i.length;c>s;++s)o[s]={characterRange:i[s].toCharacterRange(t,n),backward:a,characterOptions:n};return o}),restoreCharacterRanges:j(function(t,n,i){this.removeAllRanges();for(var r,o,a,s=0,c=i.length;c>s;++s)o=i[s],a=o.characterRange,r=e.createRange(n),r.selectCharacters(n,a.start,a.end,o.characterOptions),this.addRange(r,o.backward)}),text:j(function(e,t){for(var n=[],i=0,r=this.rangeCount;r>i;++i)n[i]=this.getRangeAt(i).text(t);
return n.join("")})}),e.innerText=function(t,n){var i=e.createRange(t);i.selectNodeContents(t);var r=i.text(n);return r},e.createWordIterator=function(e,t,n){var a=E();n=i(n,dt);var s=o(n.characterOptions),c=r(n.wordOptions),u=a.getPosition(e,t),d=$(u,s,c),l=J(n.direction);return{next:function(){return l?d.previousStartToken():d.nextEndToken()},dispose:function(){d.dispose(),this.next=function(){}}}},e.noMutation=function(e){var t=E();e(t),R()},e.noMutation.createEntryPointFunction=j,e.textRange={isBlockNode:l,isCollapsedWhitespaceNode:w,createPosition:j(function(e,t,n){return e.getPosition(t,n)})}}),rangy.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t(n,e[n])===!1)return!1;return!0}function i(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function r(e,t){return e.className&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e.className)}function o(e,t){e.className?r(e,t)||(e.className+=" "+t):e.className=t}function a(e){return e&&e.split(/\s+/).sort().join(" ")}function s(e){return a(e.className)}function c(e,t){return s(e)==s(t)}function u(e,t,n,i,r){var o=e.node,a=e.offset,s=o,c=a;o==i&&a>r&&++c,o!=t||a!=n&&a!=n+1||(s=i,c+=r-n),o==t&&a>n+1&&--c,e.node=s,e.offset=c}function d(e,t,n){e.node==t&&e.offset>n&&--e.offset}function l(e,t,n,i){-1==n&&(n=t.childNodes.length);for(var r,o=e.parentNode,a=A.getNodeIndex(e),s=0;r=i[s++];)u(r,o,a,t,n);t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function f(e,t){for(var n,i=e.parentNode,r=A.getNodeIndex(e),o=0;n=t[o++];)d(n,i,r);e.parentNode.removeChild(e)}function h(e,t,n,i,r){for(var o,a=[];o=e.firstChild;)l(o,t,n++,r),a.push(o);return i&&f(e,r),a}function p(e,t){return h(e,e.parentNode,A.getNodeIndex(e),!0,t)}function g(e,t){var n=e.cloneRange();n.selectNodeContents(t);var i=n.intersection(e),r=i?i.toString():"";return""!=r}function m(e){for(var t,n=e.getNodes([3]),i=0;(t=n[i])&&!g(e,t);)++i;for(var r=n.length-1;(t=n[r])&&!g(e,t);)--r;return n.slice(i,r+1)}function v(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,i,r,o=0,a=e.attributes.length;a>o;++o)if(n=e.attributes[o],r=n.name,"class"!=r){if(i=t.attributes.getNamedItem(r),null===n!=(null===i))return!1;if(n.specified!=i.specified)return!1;if(n.specified&&n.nodeValue!==i.nodeValue)return!1}return!0}function y(e,t){for(var n,i=0,r=e.attributes.length;r>i;++i)if(n=e.attributes[i].name,(!t||!M(t,n))&&e.attributes[i].specified&&"class"!=n)return!0;return!1}function w(e,t){return n(t,function(t,n){if("object"==typeof n){if(!w(e[t],n))return!1}else if(e[t]!==n)return!1})}function b(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||W(e)&&!W(e.parentNode))}function _(e){return(W(e)||1!=e.nodeType&&W(e.parentNode))&&!b(e)}function x(e){return e&&1==e.nodeType&&!Y.test(L(e,"display"))}function C(e){if(0==e.data.length)return!0;if(z.test(e.data))return!1;var t=L(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return x(e.previousSibling)||x(e.nextSibling)}function S(e){var t,n,i=[];for(t=0;n=e[t++];)i.push(new D(n.startContainer,n.startOffset),new D(n.endContainer,n.endOffset));return i}function k(e,t){for(var n,i,r,o=0,a=e.length;a>o;++o)n=e[o],i=t[2*o],r=t[2*o+1],n.setStartAndEnd(i.node,i.offset,r.node,r.offset)}function T(e,t){return A.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function N(e,n,i,r){var o,a,s=0==i;if(A.isAncestorOf(n,e))return e;if(A.isCharacterDataNode(n)){var c=A.getNodeIndex(n);if(0==i)i=c;else{if(i!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+i+" in "+n.data);i=c+1}n=n.parentNode}if(T(n,i)){o=n.cloneNode(!1),a=n.parentNode,o.id&&o.removeAttribute("id");for(var u,d=0;u=n.childNodes[i];)l(u,o,d++,r);return l(o,a,A.getNodeIndex(n)+1,r),n==e?o:N(e,a,A.getNodeIndex(o),r)}if(e!=n){o=n.parentNode;var f=A.getNodeIndex(n);return s||f++,N(e,o,f,r)}return e}function E(e,t){return e.namespaceURI==t.namespaceURI&&e.tagName.toLowerCase()==t.tagName.toLowerCase()&&c(e,t)&&v(e,t)&&"inline"==L(e,"display")&&"inline"==L(t,"display")}function R(e){var t=e?"nextSibling":"previousSibling";return function(n,i){var r=n.parentNode,o=n[t];if(o){if(o&&3==o.nodeType)return o}else if(i&&(o=r[t],o&&1==o.nodeType&&E(r,o))){var a=o[e?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}function O(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function $(e,t,r){var o,a,s,c,u=this;u.cssClass=e;var d=null,l={};if("object"==typeof t&&null!==t){for(r=t.tagNames,d=t.elementProperties,l=t.elementAttributes,a=0;c=U[a++];)t.hasOwnProperty(c)&&(u[c]=t[c]);o=t.normalize}else o=t;u.normalize="undefined"==typeof o?!0:o,u.attrExceptions=[];var f=document.createElement(u.elementTagName);u.elementProperties=u.copyPropertiesToElement(d,f,!0),n(l,function(e){u.attrExceptions.push(e)}),u.elementAttributes=l,u.elementSortedClassName=u.elementProperties.hasOwnProperty("className")?u.elementProperties.className:e,u.applyToAnyTagName=!1;var h=typeof r;if("string"==h)"*"==r?u.applyToAnyTagName=!0:u.tagNames=i(r.toLowerCase()).split(/\s*,\s*/);else if("object"==h&&"number"==typeof r.length)for(u.tagNames=[],a=0,s=r.length;s>a;++a)"*"==r[a]?u.applyToAnyTagName=!0:u.tagNames.push(r[a].toLowerCase());else u.tagNames=[u.elementTagName]}function I(e,t,n){return new $(e,t,n)}var A=e.dom,D=A.DomPosition,M=A.arrayContains,P=A.isHtmlNamespace,j="span",B=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){t.className&&(t.className=t.className.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e))}}(),L=A.getComputedStyleProperty,W=function(){var e=document.createElement("div");return"boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||W(e.parentNode):!1}}(),Y=/^inline(-block|-table)?$/i,z=/[^\r\n\t\f \u200B]/,F=R(!1),H=R(!0);O.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){for(var i,r,o,a,s=A.getNodeIndex(n),c=[],u=0,d=0,l=t.length;l>d;++d){if(i=t[d],r=i.parentNode,d>0&&(r.removeChild(i),r.hasChildNodes()||r.parentNode.removeChild(r),e))for(o=0;a=e[o++];)a.node==i&&(a.node=n,a.offset+=u),a.node==r&&a.offset>s&&(--a.offset,a.offset==s+1&&l-1>d&&(a.node=n,a.offset=u));c[d]=i.data,u+=i.data.length}n.data=c.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){for(var e=[],t=0,n=this.textNodes.length;n>t;++t)e[t]="'"+this.textNodes[t].data+"'";return"[Merge("+e.join(",")+")]"}};var U=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],q={};$.prototype={elementTagName:j,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var i,r,s,c,u,d,l={};for(var f in e)if(e.hasOwnProperty(f))if(c=e[f],u=t[f],"className"==f)o(t,c),o(t,this.cssClass),t[f]=a(t[f]),n&&(l[f]=t[f]);else if("style"==f){r=u,n&&(l[f]=s={});for(i in e[f])r[i]=c[i],n&&(s[i]=r[i]);this.attrExceptions.push(f)}else t[f]=c,n&&(l[f]=t[f],d=q.hasOwnProperty(f)?q[f]:f,this.attrExceptions.push(d));return n?l:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&t.setAttribute(n,e[n])},hasClass:function(e){return 1==e.nodeType&&M(this.tagNames,e.tagName.toLowerCase())&&r(e,this.cssClass)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||_(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&C(e)},postApply:function(e,t,n,i){for(var r,o,a,s=e[0],c=e[e.length-1],u=[],d=s,l=c,f=0,h=c.length,p=0,g=e.length;g>p;++p)o=e[p],a=F(o,!i),a?(r||(r=new O(a),u.push(r)),r.textNodes.push(o),o===s&&(d=r.textNodes[0],f=d.length),o===c&&(l=r.textNodes[0],h=r.getLength())):r=null;var m=H(c,!i);if(m&&(r||(r=new O(c),u.push(r)),r.textNodes.push(m)),u.length){for(p=0,g=u.length;g>p;++p)u[p].doMerge(n);t.setStartAndEnd(d,f,l,h)}},createContainer:function(e){var t=e.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,t,!1),this.copyAttributesToElement(this.elementAttributes,t),o(t,this.cssClass),this.onElementCreate&&this.onElementCreate(t,this),t},applyToTextNode:function(e){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&P(t)&&M(this.tagNames,t.tagName.toLowerCase())&&w(t,this.elementProperties))o(t,this.cssClass);else{var n=this.createContainer(A.getDocument(e));e.parentNode.insertBefore(n,e),n.appendChild(e)}},isRemovable:function(e){return P(e)&&e.tagName.toLowerCase()==this.elementTagName&&s(e)==this.elementSortedClassName&&w(e,this.elementProperties)&&!y(e,this.attrExceptions)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){for(var t,n=this,i=e.getNodes([1],function(e){return n.isEmptyContainer(e)}),r=[e],o=S(r),a=0;t=i[a++];)f(t,o);k(r,o)},undoToTextNode:function(e,t,n,i){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(N(n,t.endContainer,t.endOffset,i),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=N(n,t.startContainer,t.startOffset,i))}this.isRemovable(n)?p(n,i):B(n,this.cssClass)},applyToRange:function(e,t){t=t||[];var n=S(t||[]);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e);var i=m(e);if(i.length){for(var r,o=0;r=i[o++];)this.isIgnorableWhiteSpaceNode(r)||this.getSelfOrAncestorWithClass(r)||!this.isModifiable(r)||this.applyToTextNode(r,n);r=i[i.length-1],e.setStartAndEnd(i[0],0,r,r.length),this.normalize&&this.postApply(i,e,n,!1),k(t,n)}},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){t=t||[];var n=S(t);e.splitBoundariesPreservingPositions(n),this.removeEmptyElements&&this.removeEmptyContainers(e,n);var i,r,o=m(e),a=o[o.length-1];if(o.length){for(var s=0,c=o.length;c>s;++s)i=o[s],r=this.getSelfOrAncestorWithClass(i),r&&this.isModifiable(i)&&this.undoToTextNode(i,e,r,n),e.setStartAndEnd(o[0],0,a,a.length);this.normalize&&this.postApply(o,e,n,!0),k(t,n)}},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),i=e.getSelection(t).getAllRanges();this.undoToRanges(i),n.setRanges(i)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,i=0;n=t[i++];)if(!this.isIgnorableWhiteSpaceNode(n)&&g(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var i=n.getSelfOrAncestorWithClass(e);i&&!M(t,i)&&t.push(i)}),t},detach:function(){}},$.util={hasClass:r,addClass:o,removeClass:B,hasSameClasses:c,replaceWithOwnChildren:p,elementsHaveSameNonClassAttributes:v,elementHasNonClassAttributes:y,splitNodeAt:N,isEditableElement:W,isEditingHost:b,isEditable:_},e.CssClassApplier=e.ClassApplier=$,e.createCssClassApplier=e.createClassApplier=I}),define("rangy",function(){return rangy.init(),rangy}),define("findtxt",function(){function e(e,r,o,a){var s,c=[],u=[],d=n(r);if(!d)return u;if(e.global)for(;s=e.exec(d);)c.push(t(s,a));else s=d.match(e),s&&c.push(t(s,a));return c.length&&(u=i(r,c,o)),u}function t(e,t){if(t=t||0,!e[0])throw"findTxt cannot handle zero-length matches";var n=e.index;if(t>0){var i=e[t];if(!i)throw"Invalid capture group";n+=e[0].indexOf(i),e[0]=i}return[n,n+e[0].length,[e[0]]]}function n(e){if(3===e.nodeType)return e.data;var t="";if(e=e.firstChild)do t+=n(e);while(e=e.nextSibling);return t}function i(e,t,n){var i,r,o,a,s=e,c=0,u=[],d=[],l=t.shift();e:for(;;){if(3===s.nodeType&&(!r&&s.length+c>=l[1]?(r=s,a=l[1]-c):i&&d.push(s),!i&&s.length+c>l[0]&&(i=s,o=l[0]-c),c+=s.length),i&&r){var f={startNode:i,startNodeIndex:o,endNode:r,endNodeIndex:a,matchIndex:u.length+1};if(u.push(f),n&&!1===n(f))break;if(s=r,c-=r.length-a,i=null,r=null,d=[],l=t.shift(),!l)break}else if(s.firstChild||s.nextSibling){s=s.firstChild||s.nextSibling;continue}for(;;){if(s.nextSibling){s=s.nextSibling;break}if(s.parentNode===e)break e;s=s.parentNode}}return n?void 0:u}return e}),define("rect",function(){function e(e,t,n,i){this.left=e,this.top=t,this.width=n,this.height=i}return e.prototype.intersects=function(e){return this.left<=e.left+e.width&&e.left<=this.left+this.width&&this.top<=e.top+e.height&&e.top<=this.top+this.height},e.prototype.boundingRect=function(e){var t=Math.max(this.left+this.width,e.left+e.width),n=Math.max(this.top+this.height,e.top+e.height);this.left=Math.min(this.left,e.left),this.top=Math.min(this.top,e.top),this.width=t-this.left,this.height=n-this.top},e.prototype.translate=function(e,t){return this.left+=e,this.top+=t,this},e.prototype.scale=function(e,t){return this.left*=e,this.width*=e,this.top*=t,this.height*=t,this},e.prototype.clone=function(){return new e(this.left,this.top,this.width,this.height)},e}),define("range-serializer",["util","rangy","findtxt","rect"],function(e,t,n,i){function r(t,n){n=$.extend({minLength:128,validate:function(){return!0}},n);var i=arguments.callee,r=t.cloneRange(),o=r.text(),a=o.length,s=a-n.minLength;if(0>s){if(r.moveStart("character",s),!n.validate(r))return i(t,e.merge(n,{minLength:n.minLength>>1}));o=r.text()}return{text:o.substr(-a),prefix:o.substring(0,o.length-a)}}function o(t){return function(n){var r=n.nodeType==Node.TEXT_NODE;r&&(n=e.wrapTextNode(n));var o=n.getBoundingClientRect();r&&(n=e.unwrapTextNode(n));for(var a=new i(o.left,o.top,o.width,o.height),s=0;s<t.length;s++)if(a.intersects(t[s]))return!0;return!1}}function a(e){var n=t.createRange();return n.setStart(e.startNode,e.startNodeIndex),n.setEnd(e.endNode,e.endNodeIndex),n}function s(e,t){if(!e.length)return null;if(!t||!t.length)return a(e[0]);for(var n=null,i=0,r=o(t),s=0;s<e.length;s++){var c=a(e[s]),u=c.getNodes([Node.TEXT_NODE,Node.ELEMENT_NODE],r);u.length>i&&(i=u.length,n=c)}return n}function c(t,i){i=$.extend({matchFilter:null,matchWeirdCitations:!1,insertWhitespace:!1,matchBrokenTxt:!1,matchTranslits:!1,boundingRects:null},i);var r=t.text,o=t.prefix;i.insertWhitespace&&(r=r.replace(/\s+/g,"").split("").join(" "),o=o.replace(/\s+/g,"").split("").join(" "));var a=e.regexEscape(r),c=e.regexEscape(o);i.matchTranslits&&(a=a.replace(/([szcaeoui]{1})/gi,"$1[\xb8\u02c7\xb4\xa8`'\"~]? ").replace(/i/gi,"(i|\u0131)"),a=a.replace(/\\?[\u2014\u2012\u2013\u2010-]/gi,".")),i.matchBrokenTxt&&t.text.match(/[a-z]+/i)&&t.text.match(/\d{4}/)&&(a=a.replace(/([a-z0-9]{1})/gi,"($1|[^\\x20-\\x7F]{1})")),i.matchWeirdCitations&&(a=a.replace(/(\u2022|\u2217 )/gi,"($1|.{1})"),c.length>0&&(c=c.replace(/(\d+)\\\)/,"$1 \\)"))),a="("+a.replace(/\s+/g,"\\s*")+")",c=c.replace(/\s+/g,"\\s*");var u=new RegExp(c+"\\s*"+a,"ig"),d=n(u,i.container[0],null,1);return i.matchFilter&&(d=$.grep(d,i.matchFilter)),s(d,i.boundingRects)}return{serialize:r,deserialize:c}}),define("rendering-fixes",["util","article","viewer"],function(e,t,n){function i(){0==c.indexOf("10.4018/irmj")&&n.onInit(function(){var e=n.getPageObj(1);e.onLoaded(function(){e.hasText()&&e.getElem().find('.t:contains("717/533-8845")').length&&e.getElem().find('.t:contains("Information Resources Management Journal")').hide()})})}function r(){0==c.indexOf("10.4018/irmj.2013010102")&&n.onInit(function(){n.eachPage(function(t,n){n.onLoaded(function(){n.hasText()&&n.getElem().find('.t:contains("Copyright \xa9 2013, IGI Global")').contents().each(function(t,n){0!=t&&(n.nodeType==Node.TEXT_NODE&&(n=e.wrapTextNode(n)),$(n).hide())})})})})}function o(e,t){n.onInit(function(){n.eachPage(function(n,i){i.onLoaded(function(){i.hasText()&&i.getElem().find('.t:contains("'+e+'")').each(function(){var n=$(this);n.html(n.html().replace(new RegExp(e,"g"),t))})})})})}function a(){i(),r()}function s(){a()}var c=t.get().doi;return s(),{transliterate:o}}),define("citation",["util","rangy","range-serializer","rendering-fixes"],function(e,t,n,i){function r(e,t){var n=[];-1!=e.indexOf("'",1)&&(e=e.replace(/\'$/,"\u2019"),n.push(e)),-1!=e.indexOf("\u201d",1)&&(e=e.replace(/\\u201d/,"\u2019\u2019"),n.push(e)),n.push(e.replace(" "," "));for(var i=1;i<e.length-2;i++)n.push(e.substring(0,i)+e.substring(i,e.length).replace(/(.{1})/,"$1-"));return n.push(".\u201d",".","\u201d"),t.match(/^\s*\d{1}\s*$/)||n.push(""),n}function o(e){for(var t=[],n=1;n<e.length-2;n++)t.push(e.substring(0,n)+e.substring(n,e.length).replace(/(.{1})/,"$1-"));return t}var a=function(t,n){this.klass="enhanced-"+n.type,this.id=e.guid(),this.range=t,this.data=n,this.elems=null,this.clapp=null,this._init()};return a.prototype={_init:function(){this.clapp=t.createClassApplier([this.klass,this.id].join(" ")),this.clapp.applyToRange(this.range),this.elems=this._getNodes()},_getNodes:function(){var e=this.range.commonAncestorContainer;return e.nodeType==Node.TEXT_NODE&&(e=e.parentNode.parentNode),$(e).find("."+this.id)},getElems:function(){return this.elems},getId:function(){return this.id},getKlass:function(){return this.klass},getType:function(){return this.data.type},getData:function(){return e.clone(this.data)},getRange:function(){return this.range.cloneRange()},destroy:function(){this.clapp.undoToRange(this.range),this.clapp=null,this.range=null,this.elems=null,this.data=null}},a.deserialize=function(t,s,c){var u=null,d={matchFilter:c,matchTranslits:"author"==s.type,matchWeirdCitations:!0,container:t};if(!u&&s.text.match(/^\d{4}$/)&&(u=n.deserialize({prefix:s.prefix.split(/\(|\[|;/g).pop().trim(),text:s.text},e.merge(d,{matchTranslits:!1}))),u||(u=n.deserialize({prefix:s.prefix.split(/\s+|\n/).pop(),text:s.text},d)),!u&&s.text.match(/\d+\s+-\s+\d+/)&&(u=n.deserialize({prefix:s.prefix,text:s.text.replace(/\s+-\s+/g," - - ")},d)),u||(u=n.deserialize({prefix:s.prefix.replace(/(;)/g," $1 "),text:s.text.replace(/(\d+|[a-zA-Z\.]+|,|;)/g," $1 ")},d)),u||(u=n.deserialize(s,e.merge(d,{matchBrokenTxt:!0}))),u||(u=n.deserialize(s,e.merge(d,{insertWhitespace:!0}))),!u&&s.prefix.length)for(var l=r(s.prefix,s.text),f=0;f<l.length&&!(u=n.deserialize({prefix:l[f],text:s.text},d));f++);if(!u&&!s.text.match(/^\s*\d{1}\s*$/))for(var l=o(s.text),f=0;f<l.length&&!(u=n.deserialize({prefix:l[f],text:s.text},d));f++);if(!u&&(s.prefix+s.text).match("\xe9")){var h=n.deserialize({prefix:s.prefix.replace(/\xe9/g,"\xd8"),text:s.text.replace(/\xe9/g,"\xd8")},d);h&&(i.transliterate("\xd8","\xe9"),u=n.deserialize({prefix:s.prefix,text:s.text},d))}return u?new a(u,s):(t.children().length&&e.log("* missed citation: ["+s.prefix+"]["+s.text+"]"),null)},a}),define("citations-model",["util","article","viewer","input-handler","citations-drawer","citation"],function(e,t,n,i,r,o){function a(e){var t=e.getId();w[t]=e,i.add(e),r.add(e),$(y).trigger("add",[e])}function s(e){return[e.startNode.textContent,e.startNodeIndex.toString(),e.endNode.textContent,e.endNodeIndex.toString()].join("-")}function c(e){return[e.startContainer.textContent,e.startOffset.toString(),e.endContainer.textContent,e.endOffset.toString()].join("-")}function u(e,t){var n=t.getRange(),i=[e,c(n)].join(":");_[i]||(_[i]=[]),_[i].push(n)}function d(e){var t=rangy.createRange();return t.setStart(e.startNode,e.startNodeIndex),t.setEnd(e.endNode,e.endNodeIndex),t}function l(e,t){return t.startContainer.isEqualNode(e.startNode)&&t.endContainer.isEqualNode(e.endNode)?t.equals(d(e)):!1}function f(e){return function(t){var n=[e,s(t)].join(":");if(!_[n])return!0;for(var i=0;i<_[n].length;i++)if(l(t,_[n][i]))return!1;return!0}}function h(e,t){var i=x[e-1][t];if("figure"!=i.type){var r=n.getPageObj(e);i.references=$.map(i.ids,function(e){return C[e-1]});var s=o.deserialize(r.getElem(),i,f(e));s&&(u(e,s),a(s))}}function p(t,n){if(!b[t]&&n.hasText()&&x[t-1]){for(var i=e.timer.tic(),r=0;r<x[t-1].length;r++)h(t,r);e.log("citations("+t+") duration: "+e.timer.toc(i)+"ms"),b[t]=!0}}function g(){t.onData(function(){x=t.get().citations,C=t.get().references,$(n).on("page-loaded",function(e,t){p(t,n.getPageObj(t))}),n.onInit(function(){n.eachPage(p)})})}function m(e){for(var t in w)if(!1===e(w[t]))break}function v(){return e.clone(w)}var y={},w={},b={},_={},x=null,C=null;return g(),y.forEach=m,y.getAll=v,y}),define("author-template",function(){function e(e,t){return e?'<a href="'+e+'" target="_blank"> '+t+" </a>":null}function t(t){var n=[];return n.push(e(t.search_npg,"NPG Journals")),n.push(e(t.search_pm,"PubMed")),n.push(e(t.search_gs,"Google Scholar")),$.grep(n,function(e){return!!e}).join(" \u2022 ")}function n(n){var r=i.clone().removeAttr("id");if(r.find(".name").html(n.text),n.affiliations&&n.affiliations.length?r.find(".affiliations").html(n.affiliations.join("<br>")):r.find(".affiliations").hide(),n.email){var o=e(n.email,"Contact "+n.text);r.find(".contact-link").html(o)}else r.find(".contact").hide();return r.find(".links").html(t(n)),r}var i=$("#article-author-template");return{create:n}}),define("references-template",function(){function e(e){for(var i=$('<div class="references articles"></div>'),a=0,s=e.length;s>a;a++){var c=e[a],u=o.clone().removeAttr("id");u.find(".number").html(c.label||c.ordinal),u.find(".title").html(t(c.title)),u.find(".authors").html((c.authors||[]).join(", ")),u.find(".published").html(r(c)),u.find(".links").html(n(c)),i.append(u)}return i}function t(e){return e&&(e=e.replace(/<(http[^>]+)>/g,function(e,t){return i(t)})),e}function n(e){var t=[];return t.push(i(e.find_article_url,"Find Article")),t.push(i(e.article_url,"Article")),$.grep(t,function(e){return!!e}).join(" | ")}function i(e,t){return e?'<a href="'+e+'" target="_blank"> '+(t||e)+" </a>":null}function r(e){return e.journal&&e.year?e.journal+", "+e.year:e.journal||e.year}var o=$("#article-reference-template");return{create:e}}),define("citations-view",["viewer","citations-model","author-template","references-template","popover"],function(e,t,n,i,r){function o(t){var o;o="author"==t.getType()?n.create(t.getData()):i.create(t.getData().references),o.css("max-height",.5*e.getElem().height()+"px"),$(t).on("click",function(){r.open({placement:"up",content:o,anchor:t.getElems().first()})})}function a(){t.forEach(o),$(t).on("add",function(e,t){o(t)})}var s={};return a(),s}),define("s3-storage",["util"],function(e){function t(t){$.ajax(e.merge(r,t,{dataType:"json"}))}function n(t,n){$.ajax(e.merge(r,n,{type:"PUT",contentType:"application/json; charset=UTF-8",data:JSON.stringify(t)}))}var i={},r={success:function(){},complete:function(){},error:function(){}};return i.read=t,i.write=n,i}),define("shared-annotations-modal",["dialog-modal"],function(e){var t=function(){function t(e){return c.show(s,e)}function n(e){return c.hide(e)}function i(){return c.isOpen()}function r(e){return c.toggle(s,e)}function o(){var e=$("#templates #shared-annotations-dialog");s=e.clone().removeAttr("id"),s.find(".import").click(function(){$(a).trigger("import"),n()}),s.find(".cancel").click(function(){$(a).trigger("cancel"),n()}),s.find(".close-btn").click(function(){n()})}var a={},s=null,c=e("shared-annotations");return o(),a.show=t,a.hide=n,a.isOpen=i,a.toggle=r,a};return t}),define("annotations-store",["util","user","article","sync","storage","s3-storage","article","shared-annotations-modal"],function(e,t,n,i,r,o,n,a){function s(e,t){return JSON.stringify(e)==JSON.stringify(t)}function c(){Y=e.merge(F,r.getItem(z))}function u(){r.setItem(z,Y)}function d(){return e.merge(H,{user_data:i.get().user_data})}function l(t){n.get().shared_annotations_url&&o.read({url:n.get().shared_annotations_url,success:function(n){n&&t(e.merge(H,n))}})}function f(){return e.merge(H,{user_data:{modified:W,annotations:e.hashToArray(L)}})}function h(e,t){if(!t.user_data.modified)return!0;var n=new Date(e.user_data.modified),i=new Date(t.user_data.modified);return n>=i}function p(t,n){var i=e.arrayToHash(t.user_data.annotations),r=e.arrayToHash(n.user_data.annotations);if(h(t,n))for(var o in r)i[o]||Y.removed[o]||M(o,r[o],!0);else{w(n.user_data.modified);for(var o in i)r[o]||Y.added[o]||P(o,!0);for(var o in r)i[o]&&s(i[o],r[o])||M(o,r[o],!0)}return f()}function g(t,n){var i=e.arrayToHash(t.user_data.annotations),r=e.arrayToHash(n.user_data.annotations);if(h(t,n))for(var o in r)i[o]||M(o,r[o],!0);else{w(n.user_data.modified);for(var o in r)i[o]&&s(i[o],r[o])||M(o,r[o],!0)}return f()}function m(t,n){var i=e.arrayToHash(t.user_data.annotations),r=e.arrayToHash(n.user_data.annotations);if(h(t,n)){for(var o in r)if(!i[o])return!0}else for(var o in r)if(!i[o]||!s(i[o],r[o]))return!0;return!1}function v(){Y.added={},Y.updated={},Y.removed={},u()}function y(){for(var e in Y.added)return!0;for(var e in Y.updated)return!0;for(var e in Y.removed)return!0;return!1}function w(e){W=e}function b(e){Y.added[e]=!0,u()}function _(e){Y.added[e]||(Y.updated[e]=!0),u()}function x(e){Y.added[e]?delete Y.added[e]:Y.removed[e]=!0,u()}function C(e,t,n){L[e]=t,n?$(B).trigger("add-internal",[t]):b(e),$(B).trigger("add",[t])}function S(e,t,n){L[e]=t,n?$(B).trigger("change-internal",[t]):_(e),$(B).trigger("change",[t])}function k(e,t,n){delete L[e],n?$(B).trigger("remove-internal",[t]):x(e),$(B).trigger("remove",[t])}function T(){Y=e.clone(F);for(var t in L)Y.added[t]=!0;u()}function N(e,n){t.signedIn()?i.set(f(),e,v):n||$(B).trigger("not-saved")}function E(){p(f(),d())}function R(e){if(t.signedIn()){var n=a();$(n).one("import",e),n.show()}else e()}function O(){l(function(e){m(f(),e)&&R(function(){g(f(),e),N(p,!0)})})}function I(){c(),E(),O(),$(i).on("added changed",function(){E(),y()&&N(p)}),$(i).on("removed",function(){v(),T()}),$(r).on("reload",function(){E(),y()&&N(p)})}function A(){return e.clone(L)}function D(e){return L[e]}function M(e,t,n){return L[e]?S(e,t,n):C(e,t,n),!0}function P(e,t){return L[e]?(k(e,L[e],t),!0):!1}function j(e){o.write(f(),e)}var B={},L={},W=null,Y=null,z="annot-local-changes:"+n.get().doi,F={added:{},updated:{},removed:{}},H={user_data:{modified:e.dateISO(0),annotations:[]}};return I(),B.getAll=A,B.getItem=D,B.setItem=function(t,n){M(t,n)&&(w(e.dateISO()),N(p))},B.removeItem=function(t){P(t)&&(w(e.dateISO()),N(p))},B.writeShared=j,B}),define("annotations-drawer",["util"],function(e){function t(t){var n=[t.getKlass()+r,t.getColor()].join(" ");t.getElems().addClass(n).filter(function(){return e.containsDiacritic(this.innerText)}).addClass("diacritic")}function n(e){var t=[e.getKlass()+r,e.getColor(),"diacritic"].join(" ");e.getElems().removeClass(t)}var i={},r="-elem-draw";return i.add=t,i.remove=n,i}),define("number",function(){function e(e,t,n){return"undefined"==typeof n||0===+n?Math[e](t):(t=+t,n=+n,isNaN(t)||"number"!=typeof n||n%1!==0?0/0:(t=t.toString().split("e"),t=Math[e](+(t[0]+"e"+(t[1]?+t[1]-n:-n))),t=t.toString().split("e"),+(t[0]+"e"+(t[1]?+t[1]+n:n))))}var t={};return t.round10=function(t,n){return e("round",t,n)},t.floor10=function(t,n){return e("floor",t,n)},t.ceil10=function(t,n){return e("ceil",t,n)},t}),define("annotation",["util","rangy","range-serializer","rect","number"],function(e,t,n,i,r){function o(e,t){var n=e[0].getBoundingClientRect(),r=new i(n.left,n.top,n.width,n.height),o=r.height/t.page_height,a=r.width/t.page_width,s=r.height/o;return $.map(t.rects,function(e){var t=new i(e[0],s-e[1]-e[3],e[2],e[3]);return t.scale(a,o),t.translate(r.left,r.top),t})}var a=function(t,n,i){var r=e.dateISO();this.data=$.extend({source:"sync",id:e.guid(),type:"highlight",renderer:"html5",created:r,color_id:"1"},i),this.range=t,this.container=n,this.id=this.data.id,this.klass="annotation",this.elems=null,this.clapp=null,this._init()};return a.prototype={_init:function(){this.clapp=t.createClassApplier([this.id,this.klass].join(" ")),this.clapp.applyToRange(this.range),this.elems=this._getNodes(),this.rects=this._getRects()},_getNodes:function(){var e=this.range.commonAncestorContainer;return e.nodeType==Node.TEXT_NODE&&(e=e.parentNode.parentNode),$(e).find("."+this.id)},_getRects:function(){return this.data.rects&&this.data.rects.length||(this.data.rects=this._getBoundingRects()),this.data.rects},_getBoundingRects:function(){var e=[],t=this.container[0].getBoundingClientRect(),n=new i(t.left,t.top,t.width,t.height),o=this.data.page_height/n.height,a=this.data.page_width/n.width;return this.elems.each(function(){var t=this.getBoundingClientRect(),r=new i(t.left,t.top,t.width,t.height);r.translate(-n.left,-n.top),r.scale(a,o);for(var s=0;s<e.length;s++)if(e[s].intersects(r))return void e[s].boundingRect(r);e.push(r)}),n.scale(a,o),$.map(e,function(e){return[[r.round10(e.left,-1),r.round10(n.height-e.top-e.height,-1),r.round10(e.width,-1),r.round10(e.height,-1)]]})},getNote:function(){return this.data.note},setNote:function(e){this.data.has_note&&this.data.note==e||(this.data.has_note=!0,this.data.note=e,$(this).trigger("change"))},hasNote:function(){return this.data.has_note},getColor:function(){return"color-"+this.data.color_id},getElems:function(){return this.elems},getId:function(){return this.id},getKlass:function(){return this.klass},getRange:function(){return this.range.cloneRange()},getCreated:function(){return this.data.created},getPageStart:function(){return this.data.page_start},destroy:function(){this.clapp.undoToRange(this.range),this.clapp=null,this.range=null,this.elems=null,this.klass=null,this.data=null},serialize:function(){var t=this.container[0],i=n.serialize(this.range,{validate:function(e){return $.contains(t,e.commonAncestorContainer)}});return e.merge({preceeding_text:i.prefix,text:i.text},this.data)}},a.comparePositions=function(e,t){var n=e.getRange(),i=t.getRange();return n.compareBoundaryPoints(n.START_TO_START,i)},a.deserialize=function(t,i){var r="html5"==i.renderer,s="swf"==i.renderer,c=!r&&!s,u=null,d={container:t,insertWhitespace:!r};i.preceeding_text||(i.preceeding_text="");var l=parseInt(i.color_id);return(!l||1>l||l>4)&&delete i.color_id,c&&i.rects&&i.rects.length&&(d.boundingRects=o(t,i)),u||(u=n.deserialize({prefix:i.preceeding_text,text:i.text},d)),!u&&s&&(u=n.deserialize({prefix:i.preceeding_text.slice(0,-1),text:i.text.slice(0,-1)},d)),!u&&c&&(u=n.deserialize({prefix:"",text:i.text},d)),u?new a(u,t,i):(t.children().length&&e.log("* missed annotation: ["+i.preceeding_text+"]["+i.text+"]"),null)},a}),define("annotations-model",["util","viewer","article","input-handler","annotations-store","annotations-drawer","annotation"],function(e,t,n,i,r,o,a){function s(e){var t=e.getId();return y[t]=e,i.add(e),o.add(e),$(e).on("change.store",function(){r.setItem(t,e.serialize()),$(v).trigger("change",[e])}),$(v).trigger("add",[e]),e}function c(e){if(!y[e])return null;var t=y[e];return i.remove(t),o.remove(t),$(t).off("change.store"),delete y[e],t.destroy(),$(v).trigger("remove",[t]),t}function u(e){if(e.sha256==_){var n=e.page_start+1,i=t.getPageObj(n),r=a.deserialize(i.getElem(),e);r&&(w[r.getId()]=null,s(r))}}function d(e){t.onInit(function(){var n=e.page_start+1,i=t.getPageObj(n);b[n]=!1,w[e.id]=e,l(n,i)})}function l(t,n){if(!b[t]&&n.hasText()){var i=e.timer.tic();for(var r in w){var o=w[r];o&&o.page_start+1==t&&u(o)}e.log("annotations("+t+") duration: "+e.timer.toc(i)+"ms"),b[t]=!0}}function f(){w=r.getAll(),$(t).on("page-loaded",function(e,n){l(n,t.getPageObj(n))}),t.onInit(function(){t.eachPage(l)}),$(r).on("add-internal",function(e,t){t.sha256==_&&d(t)}),$(r).on("change-internal",function(e,t){t.sha256==_&&(c(t.id),d(t))}),$(r).on("remove-internal",function(e,t){t.sha256==_&&c(t.id)})}function h(n,i){var o=t.getPageObj(i.page_start),c=new a(n,o.getElem(),e.merge(i,{has_note:e.definedKey("note",i),page_start:i.page_start-1,page_end:i.page_start-1,page_height:o.getHeight(),page_width:o.getWidth(),sha256:_}));
return r.setItem(c.getId(),c.serialize()),s(c)}function p(e){return r.removeItem(e),c(e)}function g(e){for(var t in y)if(!1===e(y[t]))break}function m(){return e.clone(y)}var v={},y={},w={},b={},_=n.get().hash;return f(),v.addItem=h,v.removeItem=p,v.forEach=g,v.getAll=m,v}),define("selection",["util","rangy","input-handler"],function(e,t,n){function i(i,r){function o(){var e=h.commonAncestorContainer;return e.nodeType==Node.TEXT_NODE&&(e=e.parentNode.parentNode),$(e).find("."+f)}function a(){n.remove(d),o().removeClass(f),t.getSelection().removeAllRanges(),$(d).trigger("clear-selection")}function s(){var i=t.getSelection(),o=i.getAllRanges()[0];return r(o)?(l=e.guid(),h=o,p.applyToRange(h),i.setSingleRange(h),n.add(d),$(d).trigger("set-selection"),!0):(i.removeAllRanges(),!1)}function c(){var e=t.getSelection();return e.isCollapsed?!1:$.contains(i[0],e.anchorNode)&&$.contains(i[0],e.focusNode)?!0:!1}function u(){$(document).on("mousedown",function(){c()&&a(),i.one("mouseup",function(){return c()&&s()?(i.one("click",!1),!1):void 0})})}i=i||$(document.body),r=r||function(){return!0};var d={},l=null,f="current-selection",h=t.createRange(),p=t.createClassApplier(f);return u(),d.clear=function(){return a()},d.getRange=function(){return h.cloneRange()},d.getRangeAndClear=function(){var e=h.cloneRange();return a(),e},d.getElems=function(){return o()},d.getKlass=function(){return f},d.getId=function(){return l},d}return i}),define("base-toolbar",["popover"],function(e){var t=function(){};return t.prototype={_init:function(e,t){var n=this,i=$("#annotations-base-toolbar");this._elem=i.clone().removeAttr("id").addClass(e),this._elem.find(".annot-colors .sample").click(function(){$(n).trigger("highlight",[$(this).data("colorid")])}),this._elem.find(".add-note").click(function(){$(n).trigger("add-note")}),this._elem.find(".delete").click(function(){$(n).trigger("delete")});var r=null;this._textarea=this._elem.find("textarea"),this._textarea.val(t||""),this._textarea.on({blur:function(){$(n).trigger("change-note",[n._textarea.val()])},keydown:function(e){e.stopPropagation()},keyup:function(){clearTimeout(r),r=setTimeout(function(){$(n).trigger("change-note",[n._textarea.val()])},1e3)}}),this._initEvents()},_initEvents:function(){},_show:function(t,n){this._anchor=t,e.open({placement:"up",content:this._elem,anchor:this._anchor,klass:n})},addClass:function(e){this._elem.addClass(e)},removeClass:function(e){this._elem.removeClass(e)},show:function(e,t){this._show(e||this._anchor,t),this._textarea.is(":visible")&&!this._textarea.val()&&this._textarea.focus()},hide:function(){e.close(this._anchor)},destroy:function(){this.hide(),this._elem.remove(),this._elem=null,this._anchor=null}},t}),define("selection-toolbar",["base-toolbar"],function(e){var t=function(e){this.selection=e,this._init("selection")};return t.prototype=$.extend(new e,{_initEvents:function(){var e=this;$(this.selection).on({"set-selection":function(){e.show(e.selection.getElems().first())},"clear-selection":function(){e.hide()}})},destroy:function(){e.prototype.destroy.apply(this),this.selection=null}}),t}),define("annotation-toolbar",["base-toolbar"],function(e){var t=function(e){this.annotation=e,this.annotation.hasNote()?this._init("annotation note",this.annotation.getNote()):this._init("annotation")};return t.prototype=$.extend(new e,{_initEvents:function(){var e=this;$(this.annotation).on("click",function(){var t=e.annotation.getElems(),n=e.annotation.getColor();e.show(t.first(),n)})},destroy:function(){e.prototype.destroy.apply(this),this.selection=null}}),t}),define("annotations-view",["viewer","annotations-model","selection","selection-toolbar","annotation-toolbar","tracker"],function(e,t,n,i,r,o){function a(e){var n=new r(e);f[e.getId()]=n,$(n).on({"add-note":function(){e.setNote(""),n.addClass("note"),$(e).trigger("click")},"change-note":function(t,n){e.setNote(n)},"delete":function(){t.removeItem(e.getId())}})}function s(e){f[e.getId()].destroy()}function c(t){var n=-1,i=t.commonAncestorContainer;return e.eachPage(function(e,t){return $.contains(t.getElem()[0],i)?(n=e,!1):void 0}),n}function u(e){return-1!=c(e)}function d(){e.onInit(function(){var r=n(e.getElem(),u),a=new i(r);$(a).on({highlight:function(e,n){var i=r.getRangeAndClear();t.addItem(i,{page_start:c(i),color_id:n}),o.highlight()},"add-note":function(){var e=r.getRangeAndClear();$(t.addItem(e,{page_start:c(e),note:""})).trigger("click"),o.note()}})})}var l={},f={};return t.forEach(a),$(t).on({add:function(e,t){a(t)},remove:function(e,t){s(t)}}),d(),l}),define("related-template",function(){function e(e,t){return e?'<a href="'+e+'" class="link-out" target="_blank"> '+t+" </a>":void 0}function t(t){var n=[];return n.push(e(t.find_article_url,"Find Article")),n.push(e(t.article_url,"Article")),$.grep(n,function(e){return e}).join(" | ")}function n(e){return e.journal&&e.year?e.journal+", "+e.year:e.journal||e.year}function i(e){var i=$('<div class="articles"></div>');0==e.length&&i.append('<div class="none-found">No related articles found.</div>');for(var o=0;o<e.length;o++){var a=r.clone().removeAttr("id");a.find(".title").html(e[o].title),a.find(".authors").html((e[o].authors||[]).join(", ")),a.find(".published").html(n(e[o])),a.find(".links").html(t(e[o])),i.append(a)}return i}var r=$("#related-article-template");return{createElement:i}}),define("related-view",["util","endpoint","article","viewer","popover","related-template","tracker","spin-btn"],function(e,t,n,i,r,o,a,s){function c(i){if(c.data)return void i(c.data);var r=e.timer.tic(),o=n.get();$.ajax({url:t("related_articles",{doi:o.doi}),dataType:"json",success:function(t){e.log("related articles: "+e.timer.toc(r)+"ms"),c.data=t.slice(),i(c.data)}})}function u(e,t){var n=o.createElement(t);n.find(".link-out").on("click",function(){a.linkout("related")}),n.css("max-height",.9*i.getElem().height()+"px"),r.open({placement:"up",content:n,anchor:e})}function d(){$(function(){var e=$("#related-articles"),t=new s(e);e.click(function(){return r.isOpen(e)?void r.close():(t.spin(),c(function(n){t.stop(),u(e,n)}),void a.related())})})}var l={};return d(),l}),define("readcube-view",["user","tracker"],function(e,t){function n(){$(function(){s=$("#sidepanel-readcube"),s.find(".login-link").click(function(){e.showLogin({tracking_action:"readcube_sidepanel",tracking_origin:t.trackingOrigin()},function(){r()})}),e.onSignIn(function(){s.find(".existing-user").hide()})})}function i(){s.trigger("tab:open")}function r(){s.trigger("tab:close")}function o(){s.hasClass("active")?r():i()}var a={},s=null;return n(),a.open=i,a.close=r,a.toggle=o,a}),define("supplement-normalize",function(){function e(e){return e=e.toLowerCase(),0==e.indexOf("vnd.")?-1!=e.indexOf("word")?"doc":-1!=e.indexOf("excel")||-1!=e.indexOf("sheet")?"xls":-1!=e.indexOf("powerpoint")||-1!=e.indexOf("presentation")?"ppt":"type":e}return function(t,n){return t.index=n,t.caption=t.caption||"Supplement "+(n+1),t.type=e(t.type),t}}),define("supplement-viewer",["util","article","endpoint","message-receiver","supplement-normalize","tracker","spin"],function(e,t,n,i,r,o,a){function s(e){var n=t.get().supplements[e];return r(n,e)}function c(){return $("<div></div>").addClass("supplement-bg")}function u(){return $("<iframe></iframe>").addClass("supplements-frame").attr("allowTransparency","true")}function d(){b||(b=c()),b.appendTo(document.body).fadeIn(v,function(){_.spin(b[0])})}function l(){b&&(_.stop(),b.fadeOut(v,function(){b.hide()}))}function f(e,t){var n=t[0].contentWindow.document;n.write(e),n.close()}function h(t){var n=e.timer.tic();w=u(),$(i).one("supplement:load",function(){e.log("loaded supplement frame:",e.timer.toc(n)+"ms"),_.stop(),w.show(),g()}),$(i).one("supplement:close",function(){w.hide().remove(),w=null,l()}),w.appendTo(document.body),f(t,w)}function p(t){var i=e.timer.tic();y=t,d(),$.ajax({type:"POST",url:n("show_supplement"),dataType:"html",data:{supplement:s(y)},success:function(t){e.log("rendered supplement:",e.timer.toc(i)+"ms"),h(t),o.supplement()}})}function g(){t.hasAccess()&&w&&w.is(":visible")&&w[0].contentWindow.postMessage({type:"supplement:access",supplement:s(y)},"*")}function m(){t.onAccess(g)}var v=200,y=null,w=null,b=null,_=new a({color:"#CCC",radius:16,length:32,width:2});return m(),{show:p}}),define("video-player",["util"],function(e){function t(){return!!window.videojs}function n(n){t()?n():(e.loadCss("//vjs.zencdn.net/4.2/video-js.css"),$.getScript("//vjs.zencdn.net/4.2/video.js",n))}function i(e,t){n(function(){var n=e+"-video";$("body").append('<div class="video-overlay"></div>'),$("body .video-overlay").append('<video id="'+n+'" class="video-js vjs-default-skin" controls></video>'),$("body .video-overlay video").append('<source src="'+t+'" type="video/mp4">');var i=videojs(n,{width:640,height:480});$("body .video-overlay").click(function(e){$(e.target).hasClass("video-overlay")&&(i.dispose(),$(this).remove())})})}return api={},{show:i}}),define("supplements-template",["tracker","supplement-normalize","supplement-viewer","video-player"],function(e,t,n,i){function r(e,t){if(e.thumb&&e.thumb.length){var n=e.thumb[0],i=$(new Image);i.attr("src",n).load(function(){i.remove(),t(n)})}}function o(t){var o=a.clone().removeAttr("id");return o.addClass(t.type),o.attr("href",t.url),o.find(".type").html("("+t.type+")"),o.find(".title").html(t.caption),r(t,function(e){o.find(".thumb").css("background-image","url("+e+")"),t.stylesheet&&o.click(function(){return n.show(t.index),!1})}),"video"==t.type&&o.click(function(){return i.show("supplement-"+t.index,t.url),e.video(),!1}),o}var a=$("#article-supplement-template");return function(e){for(var n=$('<div class="supplements"><h3>Supporting Information</h3></div>'),i=0;i<e.length;i++){var r=t(e[i],i);n.append(o(r))}return n}}),define("supplements-view",["article","supplements-template","popover"],function(e,t,n){function i(){$(function(){e.onData(function(e){var i=$("#supplements"),r=e.supplements;r.length>0?i.append('<div class="count">'+r.length+"</div>"):i.hide(),i.click(function(){n.open({placement:"up",content:t(r),anchor:i})})})})}var r={};return i(),r}),define("bottombar-view",["user","viewer","article-export","tracker","readcube-view","popover"],function(e,t,n,i,r,o){function a(){var t=d.find("#readcube-button"),n=d.find("#user-button"),a=$("#readcube-menu");t.click(function(){r.toggle()}),n.click(function(){e.signedIn()?o.toggle({placement:"up",content:a,anchor:n}):e.showRegister({tracking_action:"toolbar_signup",tracking_origin:i.trackingOrigin()})}),a.find(".item").click(function(){o.close(n)}),e.onSignIn(function(){n.find(".user-name").html(e.get().name),n.addClass("logged-in")})}function s(){d.find("#zoom-in").click(function(){t.scaleBy(1.25)}),d.find("#zoom-out").click(function(){t.scaleBy(.8)}),d.find("#fit-width").click(function(){t.fitWidth()}),d.find("#print").click(function(){n.print()}),d.find("#save").click(function(){n.download()})}function c(){$(function(){d=$("#bottom"),a(),s()})}var u={},d=null;return c(),require("related-view"),require("supplements-view"),u}),define("topbar-view",["endpoint","tracker","util"],function(e,t,n){function i(){$(function(){e("parent")&&r(),$(".publisher-site-link, .back-to-publisher").on("click",function(){t.linkout("publisher")})})}function r(){if($("#content").addClass("embedded"),window.readcube.show_close){$("#close-reader").show();var t=n.getScrollbarWidth();t&&$("#close-reader").css("right",t)}$("#close-reader, .publisher-site-link, .back-to-publisher").click(function(t){t.preventDefault(),t.stopImmediatePropagation(),window.parent.postMessage({type:"close"},e("parent"))})}i()}),define("tabs",function(){function e(e,t,n){function i(e){c.removeClass("active"),c.filter('[data-pane="'+e+'"]').addClass("active"),u.filter(".active").removeClass("active").trigger("close"),$(e).addClass("active").trigger("open"),t&&t(e)}function r(){c.removeClass("active"),u.filter(".active").removeClass("active").trigger("close"),n&&n()}function o(e){var t=c.filter('[data-pane="'+e+'"]');t.hasClass("active")&&r(),t.hide()}function a(e){var t=c.filter('[data-pane="'+e+'"]');t.show()}function s(){c=e.find(".tab"),u=e.find(".tab-pane"),c.click(function(){$(this).hasClass("active")?r():i($(this).data("pane"))}),c.filter("[data-hide]").each(function(){$(this).hide()}),u.on("hide",function(){o("#"+$(this).attr("id"))}),u.on("show",function(){a("#"+$(this).attr("id"))}),u.on("tab:open",function(){i("#"+$(this).attr("id"))}),u.on("tab:close",function(){r()})}var c=null,u=null;return s(),{open:i,close:r}}return e}),define("summary-view",["util","article","format"],function(e,t,n){function i(){$(function(){var i=$("#sidepanel-info");t.onData(function(t){var r=t.meta,a=$.grep([r.journal,n.month(r.month),r.year],function(e){return!!e}).join(", ")+". "+t.doi,s=$.map(r.authors,function(e){return e.name}).join(", ");i.find(".info").html(a),i.find("h2.title").html(r.title),i.find("p.authors").html(s),$.each(o,function(t,n){e.log(t),r[t]?i.find("p."+n).html(r[t]):i.find("."+n).remove()})})})}var r={},o={editors_summary:"editors-summary",chapter:"chapter","abstract":"abstract"};return i(),r}),define("figures-view",["article"],function(e){function t(e,t){var n=o.clone().removeAttr("id"),i=t.caption,s=i.indexOf(":"),c="<b>"+i.substr(0,s)+" |</b> "+i.substr(s+1);return n.find(".figure-caption").html(c),n.find(".figure-thumb").data("src",t.thumb),$(a).one("open",function(){var e=n.find(".figure-thumb");e.attr("src",e.data("src"))}),n.click(function(){$(r).trigger("show-figure",[e])}),n}function n(e){if(e.length){a.removeClass("empty");for(var n=0;n<e.length;n++)s.append(t(n,e[n]))}}function i(){$(function(){o=$("#templates #figure-template"),a=$("#sidepanel-figures"),s=a.find(".figures-list"),e.onData(function(e){n(e.figures)})})}var r={},o=null,a=null,s=null;return i(),r}),define("figures-carousel",["article","figures-view","spin"],function(e,t,n){function i(){if(!d||!d.hasClass("open"))return void o();var e=l.width()-20,t=l.height()-20;(e!=m[0]||t!=m[1])&&(f.css({maxWidth:e,maxHeight:t}),m=[e,t])}function r(){o(),i(),g=setInterval(i,100)}function o(){clearInterval(g),g=null}function a(e){if(-1==e&&(e=u.length-1),e==u.length&&(e=0),e==p)return d.addClass("open"),void r();var t=u[e],n=t.caption,i=n.indexOf(":"),o=n.substr(0,i),a=n.substr(i+1);d.addClass("loading"),d.find(".title").text(o),d.find("img.figure").attr("src",t.url).load(function(){d.removeClass("loading"),h.stop()}),d.find(".caption").text(a),h.spin(d.find(".spinner")[0]),d.addClass("open"),p=e,r()}function s(){$(function(){h=new n({color:"#CCC",radius:10,length:20,width:2}),d=$("#figures-carousel"),l=d.find(".fc-content"),f=d.find("img.figure"),e.onData(function(e){u=e.figures,$(t).on("show-figure",function(e,t){a(t)}),d.find(".close").click(function(){d.removeClass("open")}),d.find(".prev").click(function(){a(p-1)}),d.find(".next").click(function(){a(p+1)}),d.find(".download-full").click(function(){location.href=u[p].download_url}),u.length<2&&d.find(".prev, .next").css({visibility:"hidden"})})})}var c={},u=null,d=null,l=null,f=null,h=null,p=null,g=null,m=[-1,-1];return s(),c}),define("sharing-view",["endpoint","access-control","article","tracker","annotations-store"],function(e,t,n,i,r){function o(e){var t=C.val(),i=n.get().meta.title;e.hasClass("twitter")&&(i=a(i,116));var r=e.data("url");r=r.replace("{{url}}",encodeURIComponent(t)),r=r.replace("{{title}}",encodeURIComponent(i)),e.attr("href",r)}function a(e,t){return e.length>t?e.substring(0,t-3)+"...":e}function s(){return k.hasClass("fa-check-square")}function c(){k.data("last_checked",s()),k.toggleClass("fa-square-o fa-check-square"),p()}function u(){k.data("last_checked")?(k.removeClass("fa-square-o"),k.addClass("fa-check-square")):(k.removeClass("fa-check-square"),k.addClass("fa-square-o"))}function d(){return new Promise(function(t,n){$.ajax({url:e("annotations_bucket"),success:t,error:n})})}function l(e){return new Promise(function(t,n){r.writeShared({url:e,success:t,error:n})})}function f(e){return new Promise(function(n,i){t.generateSharedAccess(e,n,i)})}function h(){u(),m()}function p(){g(),s()?d().then(function(e){return l(e.url).then(function(){return f({shared_annotations:e.id}).then(w)})})["catch"](h):f({}).then(w,h)}function g(){S.addClass("busy"),C.addClass("busy").val("Generating link...")}function m(e){S.removeClass("busy"),C.removeClass("busy"),e?(C.val(e),C.data("last_share_link",e)):C.val(C.data("last_share_link"))}function v(){return C.hasClass("busy")}function y(){n.onAccessCheck(function(e){!T&&e.access_share_enabled&&p()})}function w(e){return arguments.callee.abort?(arguments.callee.abort=!1,void h()):void(e.shared_access_url&&(T=!0,x.find(".share-access").show(),m(e.shared_access_url),i.shareToken(e.share_token),$(r).off("add.sharing remove.sharing change.sharing"),$(r).one("add.sharing remove.sharing change.sharing",function(){s()&&(v()?arguments.callee.abort=!0:c())})))}function b(){x.find(".share-btn.facebook").click(function(){i.share("fb")}),x.find(".share-btn.twitter").click(function(){i.share("twitter")}),x.find(".share-btn.google").click(function(){i.share("gp")}),x.find(".share-btn.linkedin").click(function(){i.share("li")}),x.find(".altmetric-embed a").click(function(){i.altmetric()})}function _(){$(function(){x=$("#sidepanel-share"),C=x.find(".share-access-link input[name=share_url]"),S=x.find(".share-access-link .link"),k=x.find(".include-annotations i"),C.click(function(){v()||$(this).select()}),k.click(function(){v()||c()}),n.onData(function(e){window.readcube.discover&&C.val(e.meta.url)}),x.one("open",function(){$.getScript(window.readcube.sources.altmetric),y()}),x.find(".share-btn").click(function(){$(this).attr("href",o($(this)))}),b()})}var x=null,C=null,S=null,k=null,T=!1,N={};return _(),N}),define("notes-view",["util","format","annotations-store"],function(e,t,n){function i(e,t){var n=new Date(e.created),i=new Date(t.created);return i.getTime()-n.getTime()}function r(e){var n=new Date(e.created),i=c.clone().removeAttr("id");return i.find(".note-created-at").html(t.friendlyDate(n)),i.find(".note-highlight").addClass("color-"+e.color_id).html(e.text),e.has_note?i.find(".note-text").html(e.note):i.find(".note-text").remove(),i}function o(){var t=e.hashToArray(n.getAll());if(t.length){var o=t.sort(i);d.empty();for(var a=0;a<o.length;a++)d.append(r(o[a]));u.removeClass("empty")}else u.addClass("empty")}function a(){$(function(){c=$("#templates #note-template"),u=$("#sidepanel-notes"),d=u.find(".notes-list"),$(n).on("add remove change",o),o()})}var s={},c=null,u=null,d=null;return a(),s}),define("references-view",["article","references-template"],function(e,t){function n(){$(function(){o=$("#sidepanel-references"),e.onData(function(e){i(e.references)})})}function i(e){e.length&&(o.removeClass("empty"),o.append(t.create(e)))}var r={},o=null;return n(),r}),define("sidepanel-view",["tabs","summary-view","figures-view","figures-carousel","sharing-view","notes-view","references-view","checkout-view","readcube-view","tracker"],function(e,t,n,i,r,o,a,s,c,u){function d(e){g.addClass("expanded"),$(".content").addClass("contracted"),u.sidepanel(e)}function l(){g.removeClass("expanded"),$(".content").removeClass("contracted")}function f(){$(function(){g=$("#sidepanel"),p=e(g,d,l),setTimeout(function(){g.addClass("ready")},1500)})}var h={},p=null,g=null;return f(),h}),define("annotation-notifications",["user","annotations-store","tracker"],function(e,t,n){function i(){var i=!1,r=$(".annotations-not-saved");r.find(".login").click(function(){e.showLogin({tracking_action:"annotations_notification",tracking_origin:n.trackingOrigin()})}),r.find(".register").click(function(){e.showRegister({tracking_action:"annotations_notification",tracking_origin:n.trackingOrigin()})}),r.find(".close").click(function(){r.removeClass("open")}),$(e).on("auth",function(){r.removeClass("open")}),$(t).on("not-saved",function(){i||(r.addClass("open"),i=!0)})}var r={};return $(function(){i()}),r}),function(e){function t(){return{empty:!1,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:!1,invalidMonth:null,invalidFormat:!1,userInvalidated:!1,iso:!1}}function n(e,t){return function(n){return d(e.call(this,n),t)}}function i(e,t){return function(n){return this.lang().ordinal(e.call(this,n),t)}}function r(){}function o(e){x(e),s(this,e)}function a(e){var t=m(e),n=t.year||0,i=t.month||0,r=t.week||0,o=t.day||0,a=t.hour||0,s=t.minute||0,c=t.second||0,u=t.millisecond||0;this._milliseconds=+u+1e3*c+6e4*s+36e5*a,this._days=+o+7*r,this._months=+i+12*n,this._data={},this._bubble()}function s(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return t.hasOwnProperty("toString")&&(e.toString=t.toString),t.hasOwnProperty("valueOf")&&(e.valueOf=t.valueOf),e}function c(e){var t,n={};for(t in e)e.hasOwnProperty(t)&&mt.hasOwnProperty(t)&&(n[t]=e[t]);return n}function u(e){return 0>e?Math.ceil(e):Math.floor(e)}function d(e,t,n){for(var i=""+Math.abs(e),r=e>=0;i.length<t;)i="0"+i;return(r?n?"+":"":"-")+i}function l(e,t,n,i){var r,o,a=t._milliseconds,s=t._days,c=t._months;a&&e._d.setTime(+e._d+a*n),(s||c)&&(r=e.minute(),o=e.hour()),s&&e.date(e.date()+s*n),c&&e.month(e.month()+c*n),a&&!i&&it.updateOffset(e),(s||c)&&(e.minute(r),e.hour(o))}function f(e){return"[object Array]"===Object.prototype.toString.call(e)}function h(e){return"[object Date]"===Object.prototype.toString.call(e)||e instanceof Date}function p(e,t,n){var i,r=Math.min(e.length,t.length),o=Math.abs(e.length-t.length),a=0;for(i=0;r>i;i++)(n&&e[i]!==t[i]||!n&&y(e[i])!==y(t[i]))&&a++;return a+o}function g(e){if(e){var t=e.toLowerCase().replace(/(.)s$/,"$1");e=Ut[e]||qt[t]||t}return e}function m(e){var t,n,i={};for(n in e)e.hasOwnProperty(n)&&(t=g(n),t&&(i[t]=e[n]));return i}function v(t){var n,i;if(0===t.indexOf("week"))n=7,i="day";else{if(0!==t.indexOf("month"))return;n=12,i="month"}it[t]=function(r,o){var a,s,c=it.fn._lang[t],u=[];if("number"==typeof r&&(o=r,r=e),s=function(e){var t=it().utc().set(i,e);return c.call(it.fn._lang,t,r||"")},null!=o)return s(o);for(a=0;n>a;a++)u.push(s(a));return u}}function y(e){var t=+e,n=0;return 0!==t&&isFinite(t)&&(n=t>=0?Math.floor(t):Math.ceil(t)),n}function w(e,t){return new Date(Date.UTC(e,t+1,0)).getUTCDate()}function b(e){return _(e)?366:365}function _(e){return e%4===0&&e%100!==0||e%400===0}function x(e){var t;e._a&&-2===e._pf.overflow&&(t=e._a[ut]<0||e._a[ut]>11?ut:e._a[dt]<1||e._a[dt]>w(e._a[ct],e._a[ut])?dt:e._a[lt]<0||e._a[lt]>23?lt:e._a[ft]<0||e._a[ft]>59?ft:e._a[ht]<0||e._a[ht]>59?ht:e._a[pt]<0||e._a[pt]>999?pt:-1,e._pf._overflowDayOfYear&&(ct>t||t>dt)&&(t=dt),e._pf.overflow=t)}function C(e){return null==e._isValid&&(e._isValid=!isNaN(e._d.getTime())&&e._pf.overflow<0&&!e._pf.empty&&!e._pf.invalidMonth&&!e._pf.nullInput&&!e._pf.invalidFormat&&!e._pf.userInvalidated,e._strict&&(e._isValid=e._isValid&&0===e._pf.charsLeftOver&&0===e._pf.unusedTokens.length)),e._isValid}function S(e){return e?e.toLowerCase().replace("_","-"):e}function k(e,t){return t._isUTC?it(e).zone(t._offset||0):it(e).local()}function T(e,t){return t.abbr=e,gt[e]||(gt[e]=new r),gt[e].set(t),gt[e]}function N(e){delete gt[e]}function E(e){var t,n,i,r,o=0,a=function(e){if(!gt[e]&&vt)try{require("./lang/"+e)}catch(t){}return gt[e]};if(!e)return it.fn._lang;if(!f(e)){if(n=a(e))return n;e=[e]}for(;o<e.length;){for(r=S(e[o]).split("-"),t=r.length,i=S(e[o+1]),i=i?i.split("-"):null;t>0;){if(n=a(r.slice(0,t).join("-")))return n;if(i&&i.length>=t&&p(r,i,!0)>=t-1)break;t--}o++}return it.fn._lang}function R(e){return e.match(/\[[\s\S]/)?e.replace(/^\[|\]$/g,""):e.replace(/\\/g,"")}function O(e){var t,n,i=e.match(_t);for(t=0,n=i.length;n>t;t++)i[t]=Qt[i[t]]?Qt[i[t]]:R(i[t]);return function(r){var o="";for(t=0;n>t;t++)o+=i[t]instanceof Function?i[t].call(r,e):i[t];return o}}function $(e,t){return e.isValid()?(t=I(t,e.lang()),Gt[t]||(Gt[t]=O(t)),Gt[t](e)):e.lang().invalidDate()}function I(e,t){function n(e){return t.longDateFormat(e)||e}var i=5;for(xt.lastIndex=0;i>=0&&xt.test(e);)e=e.replace(xt,n),xt.lastIndex=0,i-=1;return e}function A(e,t){var n,i=t._strict;switch(e){case"DDDD":return Dt;case"YYYY":case"GGGG":case"gggg":return i?Mt:kt;case"Y":case"G":case"g":return jt;case"YYYYYY":case"YYYYY":case"GGGGG":case"ggggg":return i?Pt:Tt;case"S":if(i)return It;case"SS":if(i)return At;case"SSS":if(i)return Dt;case"DDD":return St;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return Et;case"a":case"A":return E(t._l)._meridiemParse;case"X":return $t;case"Z":case"ZZ":return Rt;case"T":return Ot;case"SSSS":return Nt;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"ww":case"WW":return i?At:Ct;case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"W":case"e":case"E":return Ct;default:return n=new RegExp(Y(W(e.replace("\\","")),"i"))}}function D(e){e=e||"";var t=e.match(Rt)||[],n=t[t.length-1]||[],i=(n+"").match(zt)||["-",0,0],r=+(60*i[1])+y(i[2]);return"+"===i[0]?-r:r}function M(e,t,n){var i,r=n._a;switch(e){case"M":case"MM":null!=t&&(r[ut]=y(t)-1);break;case"MMM":case"MMMM":i=E(n._l).monthsParse(t),null!=i?r[ut]=i:n._pf.invalidMonth=t;break;case"D":case"DD":null!=t&&(r[dt]=y(t));break;case"DDD":case"DDDD":null!=t&&(n._dayOfYear=y(t));break;case"YY":r[ct]=y(t)+(y(t)>68?1900:2e3);break;case"YYYY":case"YYYYY":case"YYYYYY":r[ct]=y(t);break;case"a":case"A":n._isPm=E(n._l).isPM(t);break;case"H":case"HH":case"h":case"hh":r[lt]=y(t);break;case"m":case"mm":r[ft]=y(t);break;case"s":case"ss":r[ht]=y(t);break;case"S":case"SS":case"SSS":case"SSSS":r[pt]=y(1e3*("0."+t));break;case"X":n._d=new Date(1e3*parseFloat(t));break;case"Z":case"ZZ":n._useUTC=!0,n._tzm=D(t);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":e=e.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":e=e.substr(0,2),t&&(n._w=n._w||{},n._w[e]=t)}}function P(e){var t,n,i,r,o,a,s,c,u,d,l=[];if(!e._d){for(i=B(e),e._w&&null==e._a[dt]&&null==e._a[ut]&&(o=function(t){var n=parseInt(t,10);return t?t.length<3?n>68?1900+n:2e3+n:n:null==e._a[ct]?it().weekYear():e._a[ct]},a=e._w,null!=a.GG||null!=a.W||null!=a.E?s=Z(o(a.GG),a.W||1,a.E,4,1):(c=E(e._l),u=null!=a.d?G(a.d,c):null!=a.e?parseInt(a.e,10)+c._week.dow:0,d=parseInt(a.w,10)||1,null!=a.d&&u<c._week.dow&&d++,s=Z(o(a.gg),d,u,c._week.doy,c._week.dow)),e._a[ct]=s.year,e._dayOfYear=s.dayOfYear),e._dayOfYear&&(r=null==e._a[ct]?i[ct]:e._a[ct],e._dayOfYear>b(r)&&(e._pf._overflowDayOfYear=!0),n=q(r,0,e._dayOfYear),e._a[ut]=n.getUTCMonth(),e._a[dt]=n.getUTCDate()),t=0;3>t&&null==e._a[t];++t)e._a[t]=l[t]=i[t];for(;7>t;t++)e._a[t]=l[t]=null==e._a[t]?2===t?1:0:e._a[t];l[lt]+=y((e._tzm||0)/60),l[ft]+=y((e._tzm||0)%60),e._d=(e._useUTC?q:U).apply(null,l)}}function j(e){var t;e._d||(t=m(e._i),e._a=[t.year,t.month,t.day,t.hour,t.minute,t.second,t.millisecond],P(e))}function B(e){var t=new Date;return e._useUTC?[t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()]:[t.getFullYear(),t.getMonth(),t.getDate()]}function L(e){e._a=[],e._pf.empty=!0;var t,n,i,r,o,a=E(e._l),s=""+e._i,c=s.length,u=0;for(i=I(e._f,a).match(_t)||[],t=0;t<i.length;t++)r=i[t],n=(s.match(A(r,e))||[])[0],n&&(o=s.substr(0,s.indexOf(n)),o.length>0&&e._pf.unusedInput.push(o),s=s.slice(s.indexOf(n)+n.length),u+=n.length),Qt[r]?(n?e._pf.empty=!1:e._pf.unusedTokens.push(r),M(r,n,e)):e._strict&&!n&&e._pf.unusedTokens.push(r);e._pf.charsLeftOver=c-u,s.length>0&&e._pf.unusedInput.push(s),e._isPm&&e._a[lt]<12&&(e._a[lt]+=12),e._isPm===!1&&12===e._a[lt]&&(e._a[lt]=0),P(e),x(e)}function W(e){return e.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,n,i,r){return t||n||i||r})}function Y(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function z(e){var n,i,r,o,a;if(0===e._f.length)return e._pf.invalidFormat=!0,void(e._d=new Date(0/0));for(o=0;o<e._f.length;o++)a=0,n=s({},e),n._pf=t(),n._f=e._f[o],L(n),C(n)&&(a+=n._pf.charsLeftOver,a+=10*n._pf.unusedTokens.length,n._pf.score=a,(null==r||r>a)&&(r=a,i=n));s(e,i||n)}function F(e){var t,n,i=e._i,r=Bt.exec(i);if(r){for(e._pf.iso=!0,t=0,n=Wt.length;n>t;t++)if(Wt[t][1].exec(i)){e._f=Wt[t][0]+(r[6]||" ");break}for(t=0,n=Yt.length;n>t;t++)if(Yt[t][1].exec(i)){e._f+=Yt[t][0];break}i.match(Rt)&&(e._f+="Z"),L(e)}else e._d=new Date(i)}function H(t){var n=t._i,i=yt.exec(n);n===e?t._d=new Date:i?t._d=new Date(+i[1]):"string"==typeof n?F(t):f(n)?(t._a=n.slice(0),P(t)):h(n)?t._d=new Date(+n):"object"==typeof n?j(t):t._d=new Date(n)}function U(e,t,n,i,r,o,a){var s=new Date(e,t,n,i,r,o,a);return 1970>e&&s.setFullYear(e),s}function q(e){var t=new Date(Date.UTC.apply(null,arguments));return 1970>e&&t.setUTCFullYear(e),t}function G(e,t){if("string"==typeof e)if(isNaN(e)){if(e=t.weekdaysParse(e),"number"!=typeof e)return null}else e=parseInt(e,10);return e}function V(e,t,n,i,r){return r.relativeTime(t||1,!!n,e,i)}function K(e,t,n){var i=st(Math.abs(e)/1e3),r=st(i/60),o=st(r/60),a=st(o/24),s=st(a/365),c=45>i&&["s",i]||1===r&&["m"]||45>r&&["mm",r]||1===o&&["h"]||22>o&&["hh",o]||1===a&&["d"]||25>=a&&["dd",a]||45>=a&&["M"]||345>a&&["MM",st(a/30)]||1===s&&["y"]||["yy",s];return c[2]=t,c[3]=e>0,c[4]=n,V.apply({},c)}function Q(e,t,n){var i,r=n-t,o=n-e.day();return o>r&&(o-=7),r-7>o&&(o+=7),i=it(e).add("d",o),{week:Math.ceil(i.dayOfYear()/7),year:i.year()}}function Z(e,t,n,i,r){var o,a,s=q(e,0,1).getUTCDay();return n=null!=n?n:r,o=r-s+(s>i?7:0)-(r>s?7:0),a=7*(t-1)+(n-r)+o+1,{year:a>0?e:e-1,dayOfYear:a>0?a:b(e-1)+a}}function J(e){var t=e._i,n=e._f;return null===t?it.invalid({nullInput:!0}):("string"==typeof t&&(e._i=t=E().preparse(t)),it.isMoment(t)?(e=c(t),e._d=new Date(+t._d)):n?f(n)?z(e):L(e):H(e),new o(e))}function X(e,t){it.fn[e]=it.fn[e+"s"]=function(e){var n=this._isUTC?"UTC":"";return null!=e?(this._d["set"+n+t](e),it.updateOffset(this),this):this._d["get"+n+t]()}}function et(e){it.duration.fn[e]=function(){return this._data[e]}}function tt(e,t){it.duration.fn["as"+e]=function(){return+this/t}}function nt(e){var t=!1,n=it;"undefined"==typeof ender&&(e?(at.moment=function(){return!t&&console&&console.warn&&(t=!0,console.warn("Accessing Moment through the global scope is deprecated, and will be removed in an upcoming release.")),n.apply(null,arguments)},s(at.moment,n)):at.moment=it)}for(var it,rt,ot="2.5.1",at=this,st=Math.round,ct=0,ut=1,dt=2,lt=3,ft=4,ht=5,pt=6,gt={},mt={_isAMomentObject:null,_i:null,_f:null,_l:null,_strict:null,_isUTC:null,_offset:null,_pf:null,_lang:null},vt="undefined"!=typeof module&&module.exports&&"undefined"!=typeof require,yt=/^\/?Date\((\-?\d+)/i,wt=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,bt=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,_t=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYYY|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,xt=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,Ct=/\d\d?/,St=/\d{1,3}/,kt=/\d{1,4}/,Tt=/[+\-]?\d{1,6}/,Nt=/\d+/,Et=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,Rt=/Z|[\+\-]\d\d:?\d\d/gi,Ot=/T/i,$t=/[\+\-]?\d+(\.\d{1,3})?/,It=/\d/,At=/\d\d/,Dt=/\d{3}/,Mt=/\d{4}/,Pt=/[+-]?\d{6}/,jt=/[+-]?\d+/,Bt=/^\s*(?:[+-]\d{6}|\d{4})-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d(?::?\d\d)?|\s*Z)?)?$/,Lt="YYYY-MM-DDTHH:mm:ssZ",Wt=[["YYYYYY-MM-DD",/[+-]\d{6}-\d{2}-\d{2}/],["YYYY-MM-DD",/\d{4}-\d{2}-\d{2}/],["GGGG-[W]WW-E",/\d{4}-W\d{2}-\d/],["GGGG-[W]WW",/\d{4}-W\d{2}/],["YYYY-DDD",/\d{4}-\d{3}/]],Yt=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],zt=/([\+\-]|\d\d)/gi,Ft="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),Ht={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},Ut={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},qt={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},Gt={},Vt="DDD w W M D d".split(" "),Kt="M D H h m s w W".split(" "),Qt={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return d(this.year()%100,2)
},YYYY:function(){return d(this.year(),4)},YYYYY:function(){return d(this.year(),5)},YYYYYY:function(){var e=this.year(),t=e>=0?"+":"-";return t+d(Math.abs(e),6)},gg:function(){return d(this.weekYear()%100,2)},gggg:function(){return d(this.weekYear(),4)},ggggg:function(){return d(this.weekYear(),5)},GG:function(){return d(this.isoWeekYear()%100,2)},GGGG:function(){return d(this.isoWeekYear(),4)},GGGGG:function(){return d(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),!0)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),!1)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return y(this.milliseconds()/100)},SS:function(){return d(y(this.milliseconds()/10),2)},SSS:function(){return d(this.milliseconds(),3)},SSSS:function(){return d(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+d(y(e/60),2)+":"+d(y(e)%60,2)},ZZ:function(){var e=-this.zone(),t="+";return 0>e&&(e=-e,t="-"),t+d(y(e/60),2)+d(y(e)%60,2)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()},Q:function(){return this.quarter()}},Zt=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];Vt.length;)rt=Vt.pop(),Qt[rt+"o"]=i(Qt[rt],rt);for(;Kt.length;)rt=Kt.pop(),Qt[rt+rt]=n(Qt[rt],2);for(Qt.DDDD=n(Qt.DDD,3),s(r.prototype,{set:function(e){var t,n;for(n in e)t=e[n],"function"==typeof t?this[n]=t:this["_"+n]=t},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(e){return this._months[e.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var t,n,i;for(this._monthsParse||(this._monthsParse=[]),t=0;12>t;t++)if(this._monthsParse[t]||(n=it.utc([2e3,t]),i="^"+this.months(n,"")+"|^"+this.monthsShort(n,""),this._monthsParse[t]=new RegExp(i.replace(".",""),"i")),this._monthsParse[t].test(e))return t},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},weekdaysParse:function(e){var t,n,i;for(this._weekdaysParse||(this._weekdaysParse=[]),t=0;7>t;t++)if(this._weekdaysParse[t]||(n=it([2e3,1]).day(t),i="^"+this.weekdays(n,"")+"|^"+this.weekdaysShort(n,"")+"|^"+this.weekdaysMin(n,""),this._weekdaysParse[t]=new RegExp(i.replace(".",""),"i")),this._weekdaysParse[t].test(e))return t},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];return!t&&this._longDateFormat[e.toUpperCase()]&&(t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)}),this._longDateFormat[e]=t),t},isPM:function(e){return"p"===(e+"").toLowerCase().charAt(0)},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(e,t,n){return e>11?n?"pm":"PM":n?"am":"AM"},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){var n=this._calendar[e];return"function"==typeof n?n.apply(t):n},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,n,i){var r=this._relativeTime[n];return"function"==typeof r?r(e,t,n,i):r.replace(/%d/i,e)},pastFuture:function(e,t){var n=this._relativeTime[e>0?"future":"past"];return"function"==typeof n?n(t):n.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return Q(e,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}}),it=function(n,i,r,o){var a;return"boolean"==typeof r&&(o=r,r=e),a={},a._isAMomentObject=!0,a._i=n,a._f=i,a._l=r,a._strict=o,a._isUTC=!1,a._pf=t(),J(a)},it.utc=function(n,i,r,o){var a;return"boolean"==typeof r&&(o=r,r=e),a={},a._isAMomentObject=!0,a._useUTC=!0,a._isUTC=!0,a._l=r,a._i=n,a._f=i,a._strict=o,a._pf=t(),J(a).utc()},it.unix=function(e){return it(1e3*e)},it.duration=function(e,t){var n,i,r,o=e,s=null;return it.isDuration(e)?o={ms:e._milliseconds,d:e._days,M:e._months}:"number"==typeof e?(o={},t?o[t]=e:o.milliseconds=e):(s=wt.exec(e))?(n="-"===s[1]?-1:1,o={y:0,d:y(s[dt])*n,h:y(s[lt])*n,m:y(s[ft])*n,s:y(s[ht])*n,ms:y(s[pt])*n}):(s=bt.exec(e))&&(n="-"===s[1]?-1:1,r=function(e){var t=e&&parseFloat(e.replace(",","."));return(isNaN(t)?0:t)*n},o={y:r(s[2]),M:r(s[3]),d:r(s[4]),h:r(s[5]),m:r(s[6]),s:r(s[7]),w:r(s[8])}),i=new a(o),it.isDuration(e)&&e.hasOwnProperty("_lang")&&(i._lang=e._lang),i},it.version=ot,it.defaultFormat=Lt,it.updateOffset=function(){},it.lang=function(e,t){var n;return e?(t?T(S(e),t):null===t?(N(e),e="en"):gt[e]||E(e),n=it.duration.fn._lang=it.fn._lang=E(e),n._abbr):it.fn._lang._abbr},it.langData=function(e){return e&&e._lang&&e._lang._abbr&&(e=e._lang._abbr),E(e)},it.isMoment=function(e){return e instanceof o||null!=e&&e.hasOwnProperty("_isAMomentObject")},it.isDuration=function(e){return e instanceof a},rt=Zt.length-1;rt>=0;--rt)v(Zt[rt]);for(it.normalizeUnits=function(e){return g(e)},it.invalid=function(e){var t=it.utc(0/0);return null!=e?s(t._pf,e):t._pf.userInvalidated=!0,t},it.parseZone=function(e){return it(e).parseZone()},s(it.fn=o.prototype,{clone:function(){return it(this)},valueOf:function(){return+this._d+6e4*(this._offset||0)},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){var e=it(this).utc();return 0<e.year()&&e.year()<=9999?$(e,"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]"):$(e,"YYYYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var e=this;return[e.year(),e.month(),e.date(),e.hours(),e.minutes(),e.seconds(),e.milliseconds()]},isValid:function(){return C(this)},isDSTShifted:function(){return this._a?this.isValid()&&p(this._a,(this._isUTC?it.utc(this._a):it(this._a)).toArray())>0:!1},parsingFlags:function(){return s({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){return this.zone(0),this._isUTC=!1,this},format:function(e){var t=$(this,e||it.defaultFormat);return this.lang().postformat(t)},add:function(e,t){var n;return n="string"==typeof e?it.duration(+t,e):it.duration(e,t),l(this,n,1),this},subtract:function(e,t){var n;return n="string"==typeof e?it.duration(+t,e):it.duration(e,t),l(this,n,-1),this},diff:function(e,t,n){var i,r,o=k(e,this),a=6e4*(this.zone()-o.zone());return t=g(t),"year"===t||"month"===t?(i=432e5*(this.daysInMonth()+o.daysInMonth()),r=12*(this.year()-o.year())+(this.month()-o.month()),r+=(this-it(this).startOf("month")-(o-it(o).startOf("month")))/i,r-=6e4*(this.zone()-it(this).startOf("month").zone()-(o.zone()-it(o).startOf("month").zone()))/i,"year"===t&&(r/=12)):(i=this-o,r="second"===t?i/1e3:"minute"===t?i/6e4:"hour"===t?i/36e5:"day"===t?(i-a)/864e5:"week"===t?(i-a)/6048e5:i),n?r:u(r)},from:function(e,t){return it.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!t)},fromNow:function(e){return this.from(it(),e)},calendar:function(){var e=k(it(),this).startOf("day"),t=this.diff(e,"days",!0),n=-6>t?"sameElse":-1>t?"lastWeek":0>t?"lastDay":1>t?"sameDay":2>t?"nextDay":7>t?"nextWeek":"sameElse";return this.format(this.lang().calendar(n,this))},isLeapYear:function(){return _(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();return null!=e?(e=G(e,this.lang()),this.add({d:e-t})):t},month:function(e){var t,n=this._isUTC?"UTC":"";return null!=e?"string"==typeof e&&(e=this.lang().monthsParse(e),"number"!=typeof e)?this:(t=this.date(),this.date(1),this._d["set"+n+"Month"](e),this.date(Math.min(t,this.daysInMonth())),it.updateOffset(this),this):this._d["get"+n+"Month"]()},startOf:function(e){switch(e=g(e)){case"year":this.month(0);case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}return"week"===e?this.weekday(0):"isoWeek"===e&&this.isoWeekday(1),this},endOf:function(e){return e=g(e),this.startOf(e).add("isoWeek"===e?"week":e,1).subtract("ms",1)},isAfter:function(e,t){return t="undefined"!=typeof t?t:"millisecond",+this.clone().startOf(t)>+it(e).startOf(t)},isBefore:function(e,t){return t="undefined"!=typeof t?t:"millisecond",+this.clone().startOf(t)<+it(e).startOf(t)},isSame:function(e,t){return t=t||"ms",+this.clone().startOf(t)===+k(e,this).startOf(t)},min:function(e){return e=it.apply(null,arguments),this>e?this:e},max:function(e){return e=it.apply(null,arguments),e>this?this:e},zone:function(e){var t=this._offset||0;return null==e?this._isUTC?t:this._d.getTimezoneOffset():("string"==typeof e&&(e=D(e)),Math.abs(e)<16&&(e=60*e),this._offset=e,this._isUTC=!0,t!==e&&l(this,it.duration(t-e,"m"),1,!0),this)},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){return this._tzm?this.zone(this._tzm):"string"==typeof this._i&&this.zone(this._i),this},hasAlignedHourOffset:function(e){return e=e?it(e).zone():0,(this.zone()-e)%60===0},daysInMonth:function(){return w(this.year(),this.month())},dayOfYear:function(e){var t=st((it(this).startOf("day")-it(this).startOf("year"))/864e5)+1;return null==e?t:this.add("d",e-t)},quarter:function(){return Math.ceil((this.month()+1)/3)},weekYear:function(e){var t=Q(this,this.lang()._week.dow,this.lang()._week.doy).year;return null==e?t:this.add("y",e-t)},isoWeekYear:function(e){var t=Q(this,1,4).year;return null==e?t:this.add("y",e-t)},week:function(e){var t=this.lang().week(this);return null==e?t:this.add("d",7*(e-t))},isoWeek:function(e){var t=Q(this,1,4).week;return null==e?t:this.add("d",7*(e-t))},weekday:function(e){var t=(this.day()+7-this.lang()._week.dow)%7;return null==e?t:this.add("d",e-t)},isoWeekday:function(e){return null==e?this.day()||7:this.day(this.day()%7?e:e-7)},get:function(e){return e=g(e),this[e]()},set:function(e,t){return e=g(e),"function"==typeof this[e]&&this[e](t),this},lang:function(t){return t===e?this._lang:(this._lang=E(t),this)}}),rt=0;rt<Ft.length;rt++)X(Ft[rt].toLowerCase().replace(/s$/,""),Ft[rt]);X("year","FullYear"),it.fn.days=it.fn.day,it.fn.months=it.fn.month,it.fn.weeks=it.fn.week,it.fn.isoWeeks=it.fn.isoWeek,it.fn.toJSON=it.fn.toISOString,s(it.duration.fn=a.prototype,{_bubble:function(){var e,t,n,i,r=this._milliseconds,o=this._days,a=this._months,s=this._data;s.milliseconds=r%1e3,e=u(r/1e3),s.seconds=e%60,t=u(e/60),s.minutes=t%60,n=u(t/60),s.hours=n%24,o+=u(n/24),s.days=o%30,a+=u(o/30),s.months=a%12,i=u(a/12),s.years=i},weeks:function(){return u(this.days()/7)},valueOf:function(){return this._milliseconds+864e5*this._days+this._months%12*2592e6+31536e6*y(this._months/12)},humanize:function(e){var t=+this,n=K(t,!e,this.lang());return e&&(n=this.lang().pastFuture(t,n)),this.lang().postformat(n)},add:function(e,t){var n=it.duration(e,t);return this._milliseconds+=n._milliseconds,this._days+=n._days,this._months+=n._months,this._bubble(),this},subtract:function(e,t){var n=it.duration(e,t);return this._milliseconds-=n._milliseconds,this._days-=n._days,this._months-=n._months,this._bubble(),this},get:function(e){return e=g(e),this[e.toLowerCase()+"s"]()},as:function(e){return e=g(e),this["as"+e.charAt(0).toUpperCase()+e.slice(1)+"s"]()},lang:it.fn.lang,toIsoString:function(){var e=Math.abs(this.years()),t=Math.abs(this.months()),n=Math.abs(this.days()),i=Math.abs(this.hours()),r=Math.abs(this.minutes()),o=Math.abs(this.seconds()+this.milliseconds()/1e3);return this.asSeconds()?(this.asSeconds()<0?"-":"")+"P"+(e?e+"Y":"")+(t?t+"M":"")+(n?n+"D":"")+(i||r||o?"T":"")+(i?i+"H":"")+(r?r+"M":"")+(o?o+"S":""):"P0D"}});for(rt in Ht)Ht.hasOwnProperty(rt)&&(tt(rt,Ht[rt]),et(rt.toLowerCase()));tt("Weeks",6048e5),it.duration.fn.asMonths=function(){return(+this-31536e6*this.years())/2592e6+12*this.years()},it.lang("en",{ordinal:function(e){var t=e%10,n=1===y(e%100/10)?"th":1===t?"st":2===t?"nd":3===t?"rd":"th";return e+n}}),vt?(module.exports=it,nt(!0)):"function"==typeof define&&define.amd?define("moment",function(t,n,i){return i.config&&i.config()&&i.config().noGlobal!==!0&&nt(i.config().noGlobal===e),it}):nt()}.call(this),define("rental-notifications",["moment","format","access-control"],function(e,t,n){function i(e){return e-Date.now()}function r(e){return t.friendlyDuration(i(e))}function o(t){return e(t).format("dddd, MMMM Do YYYY, h:mm a")}function a(){var e=null,t=!1,a=$(".rental-expires-in"),s=$(".rental-expired-on");a.find(".close").click(function(){clearInterval(e),a.removeClass("open")}),s.find(".close").click(function(){s.removeClass("open")}),$(n).on("rental-expiry",function(n,c){t||(i(c)>=0?(a.addClass("open").find(".time").text(r(c)),clearInterval(e),e=setInterval(function(){i(c)>=0?a.find(".time").text(r(c)):clearInterval(e)},1e3)):s.addClass("open").find(".time").text(o(c)),t=!0)})}var s={};return $(function(){a()}),s}),define("shared-notifications",["article"],function(e){function t(){var t=!1,n=$(".notifications .shared-access");n.find(".close").click(function(){n.removeClass("open")}),e.onAccessCheck(function(e){t||(e.access&&e.access_shared?(t=!0,n.addClass("open")):n.removeClass("open"))})}return $(function(){t()}),api}),define("notifications",["annotation-notifications","rental-notifications","shared-notifications","intro-tooltips"],function(){return{}}),define("user-voice",["session","user","util"],function(e,t){function n(){r||($(function(){o=$("#user-voice"),e.onceStarted(i)}),r=!0)}function i(){UserVoice=window.UserVoice||[],$.getScript("//widget.uservoice.com/H9jSrH2fJST0D33BtNfyOA.js",function(){o.show()}),UserVoice.push(["set",{accent_color:"#448dd6",permalinks_enabled:!1,contact_title:"How can we help you?",ticket_custom_fields:{Product:"HTML5 Web Reader"}}]),t.onSignIn(function(){UserVoice.push(["identify",t.get()])}),UserVoice.push(["addTrigger","#user-voice",{mode:"contact",permalinks_enabled:!1,menu:!1,topic_id:4937,forum_id:263598}])}var r=!1,o=null;n()});var docCookies={getItem:function(e){return unescape(document.cookie.replace(new RegExp("(?:(?:^|.*;\\s*)"+escape(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*)|.*"),"$1"))||null},setItem:function(e,t,n,i,r,o){if(!e||/^(?:expires|max\-age|path|domain|secure)$/i.test(e))return!1;var a="";if(n)switch(n.constructor){case Number:a=1/0===n?"; expires=Fri, 31 Dec 9999 23:59:59 GMT":"; max-age="+n;break;case String:a="; expires="+n;break;case Date:a="; expires="+n.toGMTString()}return document.cookie=escape(e)+"="+escape(t)+a+(r?"; domain="+r:"")+(i?"; path="+i:"")+(o?"; secure":""),!0},removeItem:function(e,t){return e&&this.hasItem(e)?(document.cookie=escape(e)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT"+(t?"; path="+t:""),!0):!1},hasItem:function(e){return new RegExp("(?:^|;\\s*)"+escape(e).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};define("cookies-detect",function(){function e(){return docCookies.setItem("test-cookie",!0),docCookies.getItem("test-cookie")?(docCookies.removeItem("test-cookie"),!0):!1}return{enabled:e}}),define("reader",["enviroment","endpoint","access-control","key-handler","copy-control","banner","citations-view","annotations-view","bottombar-view","topbar-view","sidepanel-view","rendering-fixes","notifications","user-voice"],function(e){e.production()||(window["readcube-console-log"]=!0),$(function(){$(document.body).removeClass("redirect-wait")})}),define("initializer",["compatible","endpoint","cookies-detect"],function(e,t,n){function i(){return/^\/force_reader_v2\/.+/.test(location.pathname)}function r(){e.result||i()?require("reader"):location.href=t("legacy_browser_redirect",{cookies:n.enabled()})}r()}),require("initializer");